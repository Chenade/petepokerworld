var versionSort = function(data){
    var result = {};
    for(const i in data){
            var tmp = data[i].version.split("."), count = 0, level = 10000;
            for(const d in tmp){
                count += (parseInt(tmp[d])) * level;
                level /= 100;
            }
            result[count] = data[i];
    }
    return result;
};
$(document).ready(function () {
    $('html > head').append('<style>.table>tbody>tr>td{vertical-align: middle;}</style>');
    $('html > head').append('<style>.table>tbody>tr>th{vertical-align: middle;}</style>');
    $('.overflow-auto').height($(window).height() * 0.75);

    var object = {}, table = '';

    ajax('PUT', '/agent/apps', data_format('/api/app/list', 0, 'GET', {}, null), function (apps) {

        if (apps.error)
            $.growl.error({message: apps.error});
        else {

            object = apps;

            for (const app in apps) {

                const rowspan = Object.keys(apps[app]).length + 1,
                    th = '<th rowspan="' + rowspan + '">' + app + '</th>';

                table += th;

                for (const os in apps[app]) {
                    //icon
                    var td = '<td><i class="fas fa-question"></i> ' + os + '</td>';

                    switch (os.toLowerCase()) {
                        case 'android':
                            td = '<td><i class="fab fa-android"></i> ' + os + '</td>';
                            break;
                        case 'ios':
                            td = '<td><i class="fab fa-apple"></i> ' + os + '</td>';
                            break;
                        case 'windows-32bit':
                        case 'windows-64bit':
                            td = '<td><i class="fab fa-windows"></i> ' + os + '</td>';
                            break;
                    }

                    //Version
                    var option = '', versions = versionSort(apps[app][os]);
                    for (var i in versions) option += '<a class="dropdown-item change-version" href="#">' + versions[i].version + '</a>';
                    td += '<td class="font-weight-bold text-info">' + versions[i].version + '</td>';

                    //Download link
                    td += '<td><div class="btn-group"><button type="button" class="btn btn-primary app-download" data-app="' + app + '" data-os="' + os + '"><i class="fa fa-download"> ' + langDict.download + '</i></button><button type="button" class="btn btn-info dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"></button><div class="dropdown-menu">' + option + '</div></div></td>';
                    //Note
                    td += '<td><button class="btn btn-sm app-note" data-app="' + app + '" data-os="' + os + '"><i class="fas fa-book fa-2x"></i></button></td>';

                    table += '<tr>' + td + '</tr>';
                }

                table = '<tr>' + table + '</tr>';
            }

            $("tr:contains('BoviLive Apps')").last().after(table);
        }
        loading(false);
    });

    $(document).on('click', '.change-version', function (e) {
        var version = $(this).text(), row = $(this).closest('tr');
        row.find('td').eq(1).text(version);
    });

    $(document).on('click', '.app-download, .app-note', function (e) {
        var downloading = $(this).find('i').hasClass('fa-book'),
            app = $(this).attr('data-app'), os = $(this).attr('data-os'),
            row = $(this).closest('tr'), version = row.find('td').eq(1).text();

        try {
            var data = object[app][os];
            for (const i in data) if (data[i].version == version) {
                //window.open(downloading ? data[i].note : data[i].archive, '_blank');
                var mywin = window.open("about:blank", "redirect");
                var someCallback = function (url) {
                    mywin.open(url, "redirect");
                };
                someCallback(downloading ? data[i].note : data[i].archive);
                break;
            }
        } catch (e) {
            console.warn(e);
        }
    });
});