"use strict";


function SVGCreate(targetDivID, videoSrc, videoWidth, videoHeight, drawtype, isRTSPMode, callback) {

    this.divTarget = document.getElementById(targetDivID);

    this.divLiveStreaming;
    this.playerId = 'vxg';

    this.divSvgPanel;
    this.svgPanel;
    this.focusCircle;
    this.areaObjectList = [];
    this.circleList = [];

    this.videoRatio = 1;
    this.svgRatio = 1;
    this.width = videoWidth;
    this.height = videoHeight;
    this.url = videoSrc;
    this.isRTSPMode = isRTSPMode;
    this.drawType = drawtype;

    this.vxg = null;

    var _this = this;

    var setAttribute = function (elm, obj) {
        for (var i in obj) elm.setAttribute(i, obj[i]);
    };

    this.svgControlPanel = {
        isCreating: false,
        isModify: false,
        createRegion: function createRegion(custom) {
            if (custom == undefined) {
                if (_this.drawType == "poly") _this.svgControlPanel.createPolyRegion(); else if (_this.drawType == "rect") _this.svgControlPanel.createRectRegion();
            } else {
                if (_this.drawType == "poly") _this.svgControlPanel.createPolyRegionByCustom(custom); else if (_this.drawType == "rect") _this.svgControlPanel.createRectRegionByCustom(custom);
            }
            return custom;
        },
        changeRegionType: function changeRegionType(RegionType) {
            if (RegionType == "poly" || RegionType == "rect") {
                _this.drawType = RegionType;
                _this.svgControlPanel.removePoly();
                return RegionType;
            } else console.warn("Error Type");

        },
        createRectRegion: function createRectRegion() {
            if (this.isCreating) {
                console.warn("The creating progress is still process...");
                return;
            }
            if (this.isModify) {
                console.warn("The modify progress is still process...");
                return;
            }
            if (_this.areaObjectList.length > 0) {
                console.warn("The area has been created.");
                return;
            }
            this.isCreating = true;

            var poly = _this.svgPanel.rect().fill("#ffff99").opacity(0.5).draw({snapToGrid: 10});
            poly.on("drawstop", function () {
                _this.isModify = false;
                _this.enabledAllButton();
                _this.disabledSpecificButton("btn-new");
                _this.areaObjectList.push(poly);

                //console.log(poly);
                //console.log(_this.svgControlPanel.getPolyPoint());

                _this.svgControlPanel.isCreating = false;
                _this.isRTSPMode && _this.objVXGPlayer.controls(1);
                $('#draw').length && drawBtn(1);
            });
        },
        createPolyRegion: function createPolyRegion() {
            if (this.isCreating) {
                console.warn("The creating progress is still process...");
                return;
            }
            if (this.isModify) {
                console.warn("The modify progress is still process...");
                return;
            }
            if (_this.areaObjectList.length > 0) {
                console.warn("The area has been created.");
                return;
            }
            this.isCreating = true;

            var poly = _this.svgPanel.polygon().fill("#ffff99").opacity(0.5).draw({snapToGrid: 10});
            var numClick = 0;

            var event_DrawPanelDoubleClick = function event_DrawPanelDoubleClick() {
                numClick++;
                setTimeout(function (d) {
                    numClick = 0;
                }, 250);

                if (numClick == 2) {
                    //End of drwaing.
                    poly.draw('done');
                    poly.off('drawstart');

                    //Remove mouse event
                    this.removeEventListener('click', event_DrawPanelDoubleClick);

                    //Remove the duplicated point.
                    var arrPolyPoint = poly.array().value;
                    if (arrPolyPoint[arrPolyPoint.length - 1].toString() == arrPolyPoint[arrPolyPoint.length - 2].toString()) {
                        arrPolyPoint.pop();
                        poly.plot(arrPolyPoint);
                    }

                    //Record the point
                    _this.areaObjectList.push(poly);
                    _this.isModify = false;
                    _this.enabledAllButton();
                    _this.disabledSpecificButton("btn-new");

                    _this.svgControlPanel.isCreating = false;
                    _this.isRTSPMode && _this.objVXGPlayer.controls(1);
                    $('#draw').length && drawBtn(1);
                }
            };

            //When double click the panel, finish creating the poly.
            poly.on('drawstart', function (e) {
                document.getElementById('svg-panel').addEventListener('click', event_DrawPanelDoubleClick);
            });
        },

        createRectRegionByCustom: function createRectRegionByCustom(custom) {
            this.removePoly();

            var parse = custom.map(function (d) {
                return [d.x * _this.width, d.y * _this.height];
            });
            //console.warn(parse);
            var x = parse[0][0],
                y = parse[0][1],
                width = Math.abs(parse[0][0] - parse[1][0]),
                height = Math.abs(parse[0][1] - parse[2][1]);
            var tmp = _this.svgPanel.rect(width, height).fill('#ffff99').move(x, y).opacity(0.5);
            //tmp.fill("#ffff99");

            _this.areaObjectList.push(tmp);
        },

        createPolyRegionByCustom: function createPolyRegionByCustom(custom) {
            this.removePoly();
            var parse = custom.map(function (d) {
                return [d.x * _this.width, d.y * _this.height];
            });
            var tmp = _this.svgPanel.polygon(parse);
            tmp.fill("#ffff99").opacity(0.5);

            _this.areaObjectList.push(tmp);
        },

        modifyRegion: function modifyRegion() {
            if (_this.drawType == "poly") _this.svgControlPanel.modifyPolyRegion(); else if (_this.drawType == "rect") _this.svgControlPanel.modifyRectRegion();
        },
        modifyRectRegion: function modifyRectRegion() {
            //Append top-left circle
            var circleTopLeft = _this.svgPanel.circle(20).stroke({width: 1}).fill('#ccc').center(_this.areaObjectList[0].x(), _this.areaObjectList[0].y());

            //Append bottom-right circle
            var circleBottomRight = _this.svgPanel.circle(20).stroke({width: 1}).fill('#ccc').center(_this.areaObjectList[0].x() + _this.areaObjectList[0].width(), _this.areaObjectList[0].y() + _this.areaObjectList[0].height());

            //Add the mouse event in created circle
            circleTopLeft.node.addEventListener("mousedown", function () {
                _this.focusCircle = {index: 0, TopLeft: circleTopLeft, BottomRight: circleBottomRight};
                document.getElementById('svg-panel').addEventListener("mousemove", _this.svgControlPanel.changeRectLocation);
            });

            circleBottomRight.node.addEventListener("mousedown", function () {
                _this.focusCircle = {index: 1, TopLeft: circleTopLeft, BottomRight: circleBottomRight};
                document.getElementById('svg-panel').addEventListener("mousemove", _this.svgControlPanel.changeRectLocation);
            });
        },

        changeRectLocation: function changeRectLocation(e) {
            if (_this.focusCircle.index == 0) {
                //Top-Left
                _this.focusCircle.TopLeft.center(e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio);
            } else if (_this.focusCircle.index == 1) {
                //Bottom-Right
                _this.focusCircle.BottomRight.center(e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio);
            }

            //Get the Position
            var x = 0,
                y = 0,
                width = 0,
                height = 0;
            x = Math.min(_this.focusCircle.TopLeft.cx(), _this.focusCircle.BottomRight.cx());
            y = Math.min(_this.focusCircle.TopLeft.cy(), _this.focusCircle.BottomRight.cy());
            width = Math.abs(_this.focusCircle.TopLeft.cx() - _this.focusCircle.BottomRight.cx());
            height = Math.abs(_this.focusCircle.TopLeft.cy() - _this.focusCircle.BottomRight.cy());
            _this.areaObjectList[0].x(x);
            _this.areaObjectList[0].y(y);
            _this.areaObjectList[0].width(width);
            _this.areaObjectList[0].height(height);
        },
        modifyPolyRegion: function modifyPolyRegion() {
            if (_this.areaObjectList.length == 0) {
                console.warn("There are no area to modify.");
                return;
            }
            if (this.isCreating) {
                console.warn("The area creating is processing...");
                return;
            }
            console.log("Start to modify the region.");

            //Clear the circle.
            _this.svgControlPanel.clearCircle();

            //Draw the circle.
            _this.areaObjectList[0].array().value.forEach(function (element, index) {
                var createdCircle = _this.svgPanel.circle(20).stroke({width: 1}).fill('#ccc').center(element[0], element[1]);
                _this.circleList.push(createdCircle);

                //Add the mouse event in created circle
                createdCircle.node.addEventListener("mousedown", function () {
                    //index = number of circle index in array.
                    //createdCircle is the svg.js object
                    _this.focusCircle = {index: index, SVGObject: createdCircle};
                    document.getElementById('svg-panel').addEventListener("mousemove", _this.svgControlPanel.changePolyLocation);
                });
            });
        },

        clearCircle: function clearCircle() {
            for (var i = 0; i < _this.circleList.length; i++) {
                _this.circleList[i].remove();
            }
            _this.circleList.length = 0;

            if (_this.focusCircle) {
                if (_this.focusCircle.TopLeft) _this.focusCircle.TopLeft.remove();
                if (_this.focusCircle.BottomRight) _this.focusCircle.BottomRight.remove();
            }
        },

        removePoly: function removePoly() {
            //Remove the circle
            _this.svgControlPanel.clearCircle();

            //Remove the poly
            for (var i = 0; i < _this.areaObjectList.length; i++) {
                _this.areaObjectList[i].remove();
            }

            //Clear the array
            _this.areaObjectList = [];
        },

        changePolyLocation: function changePolyLocation(e) {
            _this.focusCircle.SVGObject.center(e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio);
            var focusAreaObjectList = _this.areaObjectList[0].array().value;
            focusAreaObjectList[_this.focusCircle.index] = [e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio];
            _this.areaObjectList[0].plot(focusAreaObjectList);
        },

        getPolyPoint: function getPolyPoint() {
            //Return points
            if (_this.areaObjectList[0] != undefined) {
                if (_this.drawType == "poly") {
                    var areaPoints = _this.areaObjectList[0].array().value.map(function (d) {
                        return {"x": d[0] / _this.width, "y": d[1] / _this.height};
                    });
                    return areaPoints;
                } else if (_this.drawType == "rect") {
                    var x = 0,
                        y = 0,
                        width = 0,
                        height = 0;
                    x = _this.areaObjectList[0].x();
                    y = _this.areaObjectList[0].y();
                    width = _this.areaObjectList[0].width();
                    height = _this.areaObjectList[0].height();
                    return [{
                        "x": x / _this.width,
                        "y": y / _this.height
                    }, {
                        "x": (x + width) / _this.width,
                        "y": y / _this.height
                    }, {
                        "x": (x + width) / _this.width,
                        "y": (y + height) / _this.height
                    }, {"x": x / _this.width, "y": (y + height) / _this.height}];
                }
            } else {
                console.warn("Cant not get the poly object.");
            }
        }

    };

    this.initialPlayer = function (cb) {
        this.divLiveStreaming = document.createElement("div");

        this.divTarget.setAttribute("width", _this.width);
        this.divTarget.classList.add("targetDiv");

        //Create live streaming panel
        if (this.isRTSPMode) {
            setAttribute(this.divLiveStreaming, {'id': this.playerId, 'class': 'vxgplayer', 'autostart': ''});
        } else {
            setAttribute(this.divLiveStreaming, {'style': 'width: ' + this.width + 'px; height: ' + this.height + 'px; position:relative;'});
            var image = document.createElement("img");
            setAttribute(image, {
                'id': this.playerId,
                'src': this.url,
                'onerror': 'this.src="/img/default.jpg"',
                'width': '100%',
                'height': '100%',
                'style': 'border-radius: 4px;'
            });
            this.divLiveStreaming.appendChild(image);
        }
        this.divTarget.appendChild(this.divLiveStreaming);

        if (this.isRTSPMode) {
            vxgplayer('vxg', {
                url: this.url,
                width: this.width,
                height: this.height,
                nmf_path: 'media_player.nmf',
                nmf_src: 'pnacl/media_player.nmf',
                latency: 5000,
                aspect_ratio_mode: 1,
                autohide: 3,
                controls: true,
                connection_timeout: 10000,
                connection_udp: 0,
                custom_digital_zoom: false
            }).ready(function () {
                _this.vxg = this;
                this.play();
                this.volume(0);
                this.autoreconnect(1);
                cb();
            });
        }

        this.divSvgPanel = document.createElement("div");
        setAttribute(this.divSvgPanel, {'id': 'svg-panel', 'class': 'svg-panel'});
        this.divLiveStreaming.appendChild(this.divSvgPanel);
        this.svgPanel = new SVG('svg-panel').size('100%', '100%').viewbox(0, 0, this.width, this.height);
        document.getElementById('svg-panel').addEventListener("mouseup", function (e) {
            document.getElementById('svg-panel').removeEventListener('mousemove', _this.svgControlPanel.changePolyLocation);
            document.getElementById('svg-panel').removeEventListener('mousemove', _this.svgControlPanel.changeRectLocation);
        });
        this.isRTSPMode || cb();
    };

    this.src = function () {
        if (arguments.length && arguments[0] !== undefined) {
            this.url = this.isRTSPMode ? arguments[0].videoUrl : arguments[0].snapshotUrl;
            this.isRTSPMode ? this.vxg.src(this.url) : document.getElementById(this.playerId).src = this.url;
        } else
            return this.url;
    };

    this.resize = function (width, height) {
        this.isRTSPMode ? this.vxg.size(width, height) : this.divLiveStreaming.setAttribute("style", "width:" + width + "px;height:" + height + "px;position:relative;");
        this.svgPanel.size(width, height);
        this.divSvgPanel.setAttribute("style", "width:" + width + "px;height:" + height + "px;position:absolute;");
    };

    this.initialPlayer(function () {
        callback(_this);
    });
}