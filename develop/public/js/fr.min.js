"use strict";

function SVGCreate(targetDivID, videoSrc, videoWidth, videoHeight, drawtype, callback) {

    this.divTarget = document.getElementById(targetDivID);

    this.divLiveStreaming;
    this.playerId = 'vxg';

    this.divSvgPanel;
    this.svgPanel;
    this.focusCircle;
    this.areaObjectList = [];
    this.circleList = [];

    this.videoRatio = 1;
    this.svgRatio = 1;
    this.width = videoWidth;
    this.height = videoHeight;
    this.url = videoSrc;
    this.drawType = drawtype;

    this.vxg = null;

    var _this = this;

    var setAttribute = function (elm, obj) {
        for (var i in obj) elm.setAttribute(i, obj[i]);
    };

    this.svgControlPanel = {
        isCreating: false,
        isModify: false,
        createRegion: function createRegion(custom) {
            if (custom == undefined) {
                if (_this.drawType == "poly") _this.svgControlPanel.createPolyRegion(); else if (_this.drawType == "rect") _this.svgControlPanel.createRectRegion();
            } else {
                if (_this.drawType == "poly") _this.svgControlPanel.createPolyRegionByCustom(custom); else if (_this.drawType == "rect") _this.svgControlPanel.createRectRegionByCustom(custom);
            }
            return custom;
        },
        changeRegionType: function changeRegionType(RegionType) {
            if (RegionType == "poly" || RegionType == "rect") {
                _this.drawType = RegionType;
                _this.svgControlPanel.removePoly();
                return RegionType;
            } else console.warn("Error Type");

        },
        createRectRegion: function createRectRegion() {
            if (this.isCreating) {
                console.warn("The creating progress is still process...");
                return;
            }
            if (this.isModify) {
                console.warn("The modify progress is still process...");
                return;
            }
            if (_this.areaObjectList.length > 0) {
                console.warn("The area has been created.");
                return;
            }
            this.isCreating = true;

            var poly = _this.svgPanel.rect().fill("#ffff99").opacity(0.5).draw({snapToGrid: 10});
            poly.on("drawstop", function () {
                _this.isModify = false;
                _this.enabledAllButton();
                _this.disabledSpecificButton("btn-new");
                _this.areaObjectList.push(poly);

                //console.log(poly);
                //console.log(_this.svgControlPanel.getPolyPoint());

                _this.svgControlPanel.isCreating = false;
                $('#draw').length && drawBtn(1);
            });
        },
        createPolyRegion: function createPolyRegion() {
            if (this.isCreating) {
                console.warn("The creating progress is still process...");
                return;
            }
            if (this.isModify) {
                console.warn("The modify progress is still process...");
                return;
            }
            if (_this.areaObjectList.length > 0) {
                console.warn("The area has been created.");
                return;
            }
            this.isCreating = true;

            var poly = _this.svgPanel.polygon().fill("#ffff99").opacity(0.5).draw({snapToGrid: 10});
            var numClick = 0;

            var event_DrawPanelDoubleClick = function event_DrawPanelDoubleClick() {
                numClick++;
                setTimeout(function (d) {
                    numClick = 0;
                }, 250);

                if (numClick == 2) {
                    //End of drwaing.
                    poly.draw('done');
                    poly.off('drawstart');

                    //Remove mouse event
                    this.removeEventListener('click', event_DrawPanelDoubleClick);

                    //Remove the duplicated point.
                    var arrPolyPoint = poly.array().value;
                    if (arrPolyPoint[arrPolyPoint.length - 1].toString() == arrPolyPoint[arrPolyPoint.length - 2].toString()) {
                        arrPolyPoint.pop();
                        poly.plot(arrPolyPoint);
                    }

                    //Record the point
                    _this.areaObjectList.push(poly);
                    _this.isModify = false;
                    _this.enabledAllButton();
                    _this.disabledSpecificButton("btn-new");

                    _this.svgControlPanel.isCreating = false;
                    $('#draw').length && drawBtn(1);
                }
            };

            //When double click the panel, finish creating the poly.
            poly.on('drawstart', function (e) {
                document.getElementById('svg-panel').addEventListener('click', event_DrawPanelDoubleClick);
            });
        },

        createRectRegionByCustom: function createRectRegionByCustom(custom) {
            this.removePoly();

            var parse = custom.map(function (d) {
                return [d.x * _this.width, d.y * _this.height];
            });
            //console.warn(parse);
            var x = parse[0][0],
                y = parse[0][1],
                width = Math.abs(parse[0][0] - parse[1][0]),
                height = Math.abs(parse[0][1] - parse[2][1]);
            var tmp = _this.svgPanel.rect(width, height).fill('#ffff99').move(x, y).opacity(0.5);
            //tmp.fill("#ffff99");

            _this.areaObjectList.push(tmp);
        },

        createPolyRegionByCustom: function createPolyRegionByCustom(custom) {
            this.removePoly();
            var parse = custom.map(function (d) {
                return [d.x * _this.width, d.y * _this.height];
            });
            var tmp = _this.svgPanel.polygon(parse);
            tmp.fill("#ffff99").opacity(0.5);

            _this.areaObjectList.push(tmp);
        },

        modifyRegion: function modifyRegion() {
            if (_this.drawType == "poly") _this.svgControlPanel.modifyPolyRegion(); else if (_this.drawType == "rect") _this.svgControlPanel.modifyRectRegion();
        },
        modifyRectRegion: function modifyRectRegion() {
            //Append top-left circle
            var circleTopLeft = _this.svgPanel.circle(20).stroke({width: 1}).fill('#ccc').center(_this.areaObjectList[0].x(), _this.areaObjectList[0].y());

            //Append bottom-right circle
            var circleBottomRight = _this.svgPanel.circle(20).stroke({width: 1}).fill('#ccc').center(_this.areaObjectList[0].x() + _this.areaObjectList[0].width(), _this.areaObjectList[0].y() + _this.areaObjectList[0].height());

            //Add the mouse event in created circle
            circleTopLeft.node.addEventListener("mousedown", function () {
                _this.focusCircle = {index: 0, TopLeft: circleTopLeft, BottomRight: circleBottomRight};
                document.getElementById('svg-panel').addEventListener("mousemove", _this.svgControlPanel.changeRectLocation);
            });

            circleBottomRight.node.addEventListener("mousedown", function () {
                _this.focusCircle = {index: 1, TopLeft: circleTopLeft, BottomRight: circleBottomRight};
                document.getElementById('svg-panel').addEventListener("mousemove", _this.svgControlPanel.changeRectLocation);
            });
        },

        changeRectLocation: function changeRectLocation(e) {
            if (_this.focusCircle.index == 0) {
                //Top-Left
                _this.focusCircle.TopLeft.center(e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio);
            } else if (_this.focusCircle.index == 1) {
                //Bottom-Right
                _this.focusCircle.BottomRight.center(e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio);
            }

            //Get the Position
            var x = 0,
                y = 0,
                width = 0,
                height = 0;
            x = Math.min(_this.focusCircle.TopLeft.cx(), _this.focusCircle.BottomRight.cx());
            y = Math.min(_this.focusCircle.TopLeft.cy(), _this.focusCircle.BottomRight.cy());
            width = Math.abs(_this.focusCircle.TopLeft.cx() - _this.focusCircle.BottomRight.cx());
            height = Math.abs(_this.focusCircle.TopLeft.cy() - _this.focusCircle.BottomRight.cy());
            _this.areaObjectList[0].x(x);
            _this.areaObjectList[0].y(y);
            _this.areaObjectList[0].width(width);
            _this.areaObjectList[0].height(height);
        },
        modifyPolyRegion: function modifyPolyRegion() {
            if (_this.areaObjectList.length == 0) {
                console.warn("There are no area to modify.");
                return;
            }
            if (this.isCreating) {
                console.warn("The area creating is processing...");
                return;
            }
            console.log("Start to modify the region.");

            //Clear the circle.
            _this.svgControlPanel.clearCircle();

            //Draw the circle.
            _this.areaObjectList[0].array().value.forEach(function (element, index) {
                var createdCircle = _this.svgPanel.circle(20).stroke({width: 1}).fill('#ccc').center(element[0], element[1]);
                _this.circleList.push(createdCircle);

                //Add the mouse event in created circle
                createdCircle.node.addEventListener("mousedown", function () {
                    //index = number of circle index in array.
                    //createdCircle is the svg.js object
                    _this.focusCircle = {index: index, SVGObject: createdCircle};
                    document.getElementById('svg-panel').addEventListener("mousemove", _this.svgControlPanel.changePolyLocation);
                });
            });
        },

        clearCircle: function clearCircle() {
            for (var i = 0; i < _this.circleList.length; i++) {
                _this.circleList[i].remove();
            }
            _this.circleList.length = 0;

            if (_this.focusCircle) {
                if (_this.focusCircle.TopLeft) _this.focusCircle.TopLeft.remove();
                if (_this.focusCircle.BottomRight) _this.focusCircle.BottomRight.remove();
            }
        },

        removePoly: function removePoly() {
            //Remove the circle
            _this.svgControlPanel.clearCircle();

            //Remove the poly
            for (var i = 0; i < _this.areaObjectList.length; i++) {
                _this.areaObjectList[i].remove();
            }

            //Clear the array
            _this.areaObjectList = [];
        },

        changePolyLocation: function changePolyLocation(e) {
            _this.focusCircle.SVGObject.center(e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio);
            var focusAreaObjectList = _this.areaObjectList[0].array().value;
            focusAreaObjectList[_this.focusCircle.index] = [e.offsetX * _this.svgRatio, e.offsetY * _this.svgRatio];
            _this.areaObjectList[0].plot(focusAreaObjectList);
        },

        getPolyPoint: function getPolyPoint() {
            //Return points
            if (_this.areaObjectList[0] != undefined) {
                if (_this.drawType == "poly") {
                    var areaPoints = _this.areaObjectList[0].array().value.map(function (d) {
                        return {"x": d[0] / _this.width, "y": d[1] / _this.height};
                    });
                    return areaPoints;
                } else if (_this.drawType == "rect") {
                    var x = 0,
                        y = 0,
                        width = 0,
                        height = 0;
                    x = _this.areaObjectList[0].x();
                    y = _this.areaObjectList[0].y();
                    width = _this.areaObjectList[0].width();
                    height = _this.areaObjectList[0].height();
                    return [{
                        "x": x / _this.width,
                        "y": y / _this.height
                    }, {
                        "x": (x + width) / _this.width,
                        "y": y / _this.height
                    }, {
                        "x": (x + width) / _this.width,
                        "y": (y + height) / _this.height
                    }, {"x": x / _this.width, "y": (y + height) / _this.height}];
                }
            } else {
                console.warn("Cant not get the poly object.");
            }
        }

    };

    this.initialPlayer = function (cb) {
        this.divLiveStreaming = document.createElement("div");

        this.divTarget.setAttribute("width", _this.width);
        this.divTarget.classList.add("targetDiv");

        //Create live streaming panel

        setAttribute(this.divLiveStreaming, {'style': 'width: ' + this.width + 'px; height: ' + this.height + 'px; position:relative;'});
        var image = document.createElement("img");
        setAttribute(image, {
            'id': this.playerId,
            'src': this.url,
            'onerror': 'this.src="/img/default.jpg"',
            'width': '100%',
            'height': '100%',
            'style': 'border-radius: 4px;'
        });
        this.divLiveStreaming.appendChild(image);

        this.divTarget.appendChild(this.divLiveStreaming);

        this.divSvgPanel = document.createElement("div");
        setAttribute(this.divSvgPanel, {'id': 'svg-panel', 'class': 'svg-panel'});
        this.divLiveStreaming.appendChild(this.divSvgPanel);
        this.svgPanel = new SVG('svg-panel').size('100%', '100%').viewbox(0, 0, this.width, this.height);
        document.getElementById('svg-panel').addEventListener("mouseup", function (e) {
            document.getElementById('svg-panel').removeEventListener('mousemove', _this.svgControlPanel.changePolyLocation);
            document.getElementById('svg-panel').removeEventListener('mousemove', _this.svgControlPanel.changeRectLocation);
        });
        cb();
    };

    this.src = function () {
        if (arguments.length && arguments[0] !== undefined) {
            this.url = arguments[0].snapshotUrl;
            document.getElementById(this.playerId).src = this.url;
        } else
            return this.url;
    };

    this.resize = function (width, height) {
        this.divLiveStreaming.setAttribute("style", "width:" + width + "px;height:" + height + "px;position:relative;");
        this.svgPanel.size(width, height);
        this.divSvgPanel.setAttribute("style", "width:" + width + "px;height:" + height + "px;position:absolute;");
    };

    this.initialPlayer(function () {
        callback(_this);
    });
}

function fileinput(humanList) {
    this.suspects = humanList;
    this.element = null;
    this.man = {};

    var _this = this;

    this.modal_buttons = function (state) {
        if (state) {
            $('#man_apply').prop('disabled') || $('#man_apply').button('loading');
            $('#man_revert').prop('disabled') || $('#man_revert').button('loading');
            $('#man_delete').prop('disabled') || $('#man_delete').button('loading');
            $('#man_close').prop('disabled') || $('#man_close').button('loading');
        } else {
            $('#man_apply').prop('disabled') && $('#man_apply').button('reset');
            $('#man_revert').prop('disabled') && $('#man_revert').button('reset');
            $('#man_delete').prop('disabled') && $('#man_delete').button('reset');
            $('#man_close').prop('disabled') && $('#man_close').button('reset');
        }
    }

    this.upadateSomeone = function (man) {
        if (man.id) {
            var updated = false;
            for (var i in _this.suspects) if (_this.suspects[i].id == man.id) {
                _this.suspects[i] = man;
                updated = true;
                break;
            }
            updated || _this.suspects.push(man);
        }
    };

    this.getSomeone = function (id) {
        var man = false;
        for (var i in _this.suspects) if (_this.suspects[i].id == id) {
            man = _this.suspects[i];
            break;
        }
        return man;
    }

    this.evaluation = function (score) {

        var feature = langDict.processing;
        if (typeof score == 'number') {
            if (score > 0.9) {
                feature = langDict.excellent;
            } else if (score > 0.75) {
                feature = langDict.good;
            } else if (score > 0.5) {
                feature = langDict.poor;
            } else {
                feature = langDict.bad;
            }
        }
        return feature;
    };

    this.refresh_feature = function (id) {
        if ($('#man_snapshot_row').is(':visible') && $('#human_modal').attr('data-id') == id) {
            ajax('PUT', '/agent/api', data_format("/api/va/bovia/fr/human?id=" + id, 0, 'GET', {}, null), function (man) {
                if (!man.error) {
                    var unfinished = false;

                    for (var i in man.featureTask) {
                        if (man.featureTask[i].done == 0) {
                            unfinished = true;
                        } else {
                            var checkbox = $('.feature-photo[data-id=' + man.featureTask[i].id + ']'),
                                frame = checkbox.closest('tr'),
                                feature = langDict.feature + ': ' + _this.evaluation(man.featureTask[i].score);

                            frame.find('.file-thumb-progress').addClass('kv-hidden');
                            frame.find('.file-details-cell').find('.explorer-caption').attr('title', feature).html(feature);

                            checkbox.attr({
                                'data-done': man.featureTask[i].done,
                                'data-score': man.featureTask[i].score
                            }).prop('disabled', 0);
                        }
                    }

                    _this.upadateSomeone(man);

                    unfinished && setTimeout(function () {
                        _this.refresh_feature(id);
                    }, 5000);
                }
            });
        }
    };

    this.preview = function (man) {
        _this.element && _this.element.fileinput('destroy');
        _this.element = null;
        $('#man_snapshot_row').find('.col-12').empty().html('<div class="file-loading"><input id="uploadSnapshot" name="uploadSnapshot[]" type="file" multiple accept="image"></div>');

        _this.element = $("#uploadSnapshot").fileinput({
            theme: "explorer-fas",
            allowedFileExtensions: ['jpg', 'png', 'jpeg'],
            overwriteInitial: false,
            initialPreviewAsData: true,
            initialPreview: [man.photoUrl],
            language: lang,
            browseClass: 'd-none',
            fileActionSettings: {
                showRemove: false,
                showUpload: false,
                showZoom: true,
                showDrag: false,
            }
        });

        $('.file-preview-frame').each(function (index) {
            var frame = $(this), checkbox = frame.find('input[type=checkbox]');
            if (checkbox.length) {
                checkbox.prop({'checked': 1, 'disabled': 1});
            }
        });

        $('.file-caption-main').hide();
        $('.fileinput-remove').hide();
    };

    this.launch = function (man) {
        _this.element && _this.element.fileinput('destroy');
        _this.element = null;
        $('#man_snapshot_row').find('.col-12').empty().html('<div class="file-loading"><input id="uploadSnapshot" name="uploadSnapshot[]" type="file" multiple accept="image"></div>');
        var photos = [], keys = [];
        if (Object.keys(man).length) {
            for (var i in man.featureTask) {
                photos.push(man.featureTask[i]['photo']);

                var feature = _this.evaluation(man.featureTask[i].done ? man.featureTask[i]['score'] : 'processing');

                keys.push({
                    'caption': langDict.feature + ': ' + feature,
                    'downloadUrl': man.featureTask[i]['photo'],
                    'url': "/agent/fr/upload",
                    'key': 'task,' + man.featureTask[i]['id'] + ',enabled,0,done,' + man.featureTask[i]['done'],
                    'size': man.featureTask[i]['size']
                });
            }
            for (var i in man.feature) {
                photos.push(man.feature[i]['photoUrl']);

                var feature = _this.evaluation(man.feature[i]['score']);

                keys.push({
                    'caption': langDict.feature + ': ' + feature,
                    'downloadUrl': man.feature[i]['photoUrl'],
                    'url': "/agent/fr/upload",
                    'key': 'feature,' + man.feature[i]['id'] + ',enabled,' + man.feature[i]['enabled'] + ',done,1',
                    'size': man.feature[i]['size']
                });
            }
        }
        _this.element = $("#uploadSnapshot").fileinput({
            theme: "explorer-fas",
            uploadUrl: "/agent/fr/upload",
            allowedFileExtensions: ['jpg', 'png', 'jpeg'],
            overwriteInitial: false,
            initialPreviewAsData: true,
            initialPreview: photos,
            language: lang,
            initialPreviewConfig: keys,
            uploadExtraData: function (previewId, index) {
                Object.keys(man).length || (man = {'id': $('#human_modal').attr('data-id')});
                return man;
            }
        }).on('filesorted', function (e, params) {
            //console.log('file sorted', e, params);
        }).on('filepreupload', function (e, params) {
            _this.modal_buttons(true);
        }).on('fileuploaded', function (e, params, res) {
            //has somethhin issue if 0 photo (just new create)
            if (params.filescount == 1) {
                console.log(params.filescount);
                ajax('PUT', '/agent/api', data_format("/api/va/bovia/fr/human?id=" + $('#human_modal').attr('data-id'), 0, 'GET', {}, null), function (data) {
                    data.error || (_this.upadateSomeone(data), _this.launch(data));
                });
                $.growl.notice({message: langDict.wasUploaded});
                _this.modal_buttons(false);
            }
        }).on('filedeleted', function (e, params, res) {
            $.growl.notice({message: langDict.wasDeleted});
            ajax('PUT', '/agent/api', data_format("/api/va/bovia/fr/human?id=" + $('#human_modal').attr('data-id'), 0, 'GET', {}, null), function (data) {
                data.error || (_this.upadateSomeone(data));
            });
        }).on("filepredelete", function (jqXHR) {
            return !window.confirm(langDict.doYouWantDelete);
        }).on('fileloaded', function (event, file, previewId, index, reader) {
            $('tr[id=' + previewId + ']').find('input[type=checkbox]').prop('disabled', 1);
        });

        var _refresh = true;
        $('.file-preview-frame').each(function (index) {
            var frame = $(this), key = frame.find('.kv-file-remove').attr('data-key'),
                checkbox = frame.find('input[type=checkbox]');
            if (checkbox.length && key) {
                key = key.split(',');
                checkbox.prop('checked', key[3] == '1');
                checkbox.attr('data-id', key[1]);  // id
                checkbox.attr('data-type', key[0]);  // feture or task
                checkbox.attr('data-done', key[5]);  // done

                if (key[5] == '0') {
                    frame.find('.file-thumb-progress').removeClass('kv-hidden');
                    frame.find('.progress-bar').addClass('progress-bar-animated').html(langDict.processing + '...');
                    checkbox.prop('disabled', 1);
                    if (_refresh) {
                        _refresh = false;
                        _this.refresh_feature($('#human_modal').attr('data-id'));
                    }
                }

                switch (key[0]) {
                    case "task":
                        for (var i in man.featureTask) if (man.featureTask[i].id == key[1]) {
                            checkbox.attr('data-score', man.featureTask[i].score);
                            break;
                        }
                        break;
                    case "feature":
                        for (var i in man.feature) if (man.feature[i].id == key[1]) {
                            checkbox.attr('data-score', man.feature[i].score);
                            break;
                        }
                        break;
                    default:
                        break;
                }
            }
        });
        $('.fileinput-remove').hide();
    };
}

$(document).ready(function () {
    //console.clear();
    loading(0);

    $('#task_tree').parent().height($(window).height() * 0.7);
    $('#results').height($(window).height() * 0.65);

    var url_update = new URL(window.location.href), search = url_update.searchParams.get('q');
    if(search == 'event') $('#event-nav').click();
    if(search == 'db') $('#db-nav').click();

    $(document).on('selectstart dragstart', '.material-control-description', function (e) {
        e.preventDefault();
        return false;
    });

    var object = {
        'eventPoll': {
            'tid': null,
            'after': null
        },
        'device': {},  //device config
        'group': {},
        'live': [],
        'selected': null,
        'requester': null,
        'map': null,
        '_map': null,
        'blacklist': {},    // history from task
        'history': {},    // history from event
        'humans': new fileinput([]),  // human list
        'wantedList': [],
        'tagList': [],
        'dbConditon': data_format('/api/va/bovia/fr/human/search', 0, 'POST', {'name': ''}, null),
        'eventConditon': data_format('/api/va/bovia/fr/event/search', 0, 'POST', {'config': ['0']}, 30)
    }, auto_resize = function () {
        $('#map1').height(1);

        var img = $('#event_snapshot'), width = img.closest('.col-12.col-sm-4').width(), height = (width * 9 / 16),
            map_height = height;

        $('#map1').height(map_height);
        if (object.map) object.map.invalidateSize();

        img.attr({'width': width, 'height': height}).parent().height(height);

        $('.fr-draw-face').each(function () {
            $(this).css({
                width: Math.round($(this).attr('w') * width),
                height: Math.round($(this).attr('h') * height),
                left: Math.round($(this).attr('x') * width),
                top: Math.round($(this).attr('y') * height)
            });
        });

        return {'width': width, 'height': height};

    }, event_resize = function () {
        var img = $('#original_img');
        var width = img.width(), height = img.height(),
            attr = img.attr('x') && img.attr('y') && img.attr('w') && img.attr('h');
        $('#map2').height(height);
        if (object._map) {
            object._map.invalidateSize();
            object._map.setView(new L.LatLng(gps.lat, gps.lng));
        }

        img.parent().height(height);

        if (attr) img.parent().find('span').html($('<div class="fr-draw-face"></div>').css({
            'width': parseFloat(img.attr('w')) * width,
            'height': parseFloat(img.attr('h')) * height,
            'left': parseFloat(img.attr('x')) * width,
            'top': parseFloat(img.attr('y')) * height,
            'border': '2px solid red'
        }));
    }, gender = function (code) {
        var sex = 'N/A';
        switch (code) {
            case 0:
                sex = langDict.unknown;
                break;
            case 1:
                sex = langDict.male;
                break;
            case 2:
                sex = langDict.female;
                break;
            default:
                break;
        }
        return sex;
    }, gen_age = function (birthday) {
        var age = 0;
        if (birthday) {
            age = moment().diff(birthday, 'years');
        }
        return age;
    }, gen_input = function (id, target, value, icon, disabled) {
        var placeholder = '';

        if (target == 'title') placeholder = langDict.title;
        else if (target == 'name') placeholder = langDict.name;

        return '<div class="input-group"><input type="text" placeholder="' + placeholder + '" class="form-control form-control-sm cell-input-' + target + '" data-id="' + id + '" value="' + value + '" ' + (disabled ? 'disabled' : '') + '><div class="input-group-append"> <button type="button" class="btn ' + (icon ? 'btn-outline-secondary' : 'btn-primary') + ' btn-sm cell-input-btn" data-loading-text="<span class=\'spinner-grow spinner-grow-sm\'></span>"><i class="' + (icon ? icon : 'fas fa-check') + '"></i></button></div></div>';
    }, gen_accessType = function (code) {
        var access = '<p>' + langDict.frAccessType + ':&ensp;' + langDict.fr;  + '</p>';
        if (code == 1) access = '<p>' + langDict.frAccessType + ':&ensp;' + langDict.rfid + '&ensp;<i class="fas fa-check-circle text-success"></i></p>';
        if (code == 2) access = '<p>' + langDict.frAccessType + ':&ensp;' + langDict.rfid + '&ensp;<i class="fas fa-times-circle text-danger"></i></p>';
        return access;
    } ,gen_fever = function (code) {
        var isFever = '';
        if (code == 1) isFever =  '<p>' + langDict.frFever + ':&ensp;<button class="btn btn-sm btn-danger">&emsp;' + langDict.yes + '&emsp;</button></p>';
        if (code == 2) isFever =  '<p>' + langDict.frFever + ':&ensp;<button class="btn btn-sm btn-secondary">&emsp;' + langDict.no + '&emsp;</button></p>';
        return isFever;
    }, gen_liveness = function(code){
        var liveness = '';
        if (code == 1) liveness =  '<p>' + langDict.frLiveness + ':&ensp;<button class="btn btn-sm btn-success">&emsp;' + langDict.pass + '&emsp;</button></p>';
        if (code == 2) liveness =  '<p>' + langDict.frLiveness + ':&ensp;<button class="btn btn-sm btn-danger">&emsp;' + langDict.fail + '&emsp;</button></p>';
        return liveness;
    }, recursive = function (origin, onlyGroup, prefix) {
        var real_gid = prefix + '_group_' + origin.group.id, md5_gid = md5(real_gid);

        var group_node_id = md5(prefix + '_group_' + origin.group.id), data = {
            'text': origin.group.name,
            'icon': icons.users,
            'state': {'selected': false},
            'more': origin.group,
            'children': [],
            'id': md5_gid,
            'a_attr': {'class': 'text-primary'}
        };
        var users = [];
        if (!onlyGroup) {
            users = origin.userList;
            data.data = {
                'id': origin.group.name,
                'name': '',
                'title': '',
                'score': '',
                'bulletin': '',
                'functional': '',
                'view': ''
            };
        }
        if (users.length) {
            /*-------- user sorting --------*/
            users = users.sort(function (a, b) {
                return (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0);
            });
            /*-------- end sort --------*/
            for (var i in users) {
                var user = users[i], icon = icons.user, _class = 'text-secondary',
                    real_uid = prefix + '_user_' + user.id, md5_uid = md5(real_uid);

                user.name = user.info.name;
                user.gid = origin.group.id;
                user.group = origin.group.name;
                user.layer = origin.group.layer;

                var obj = {
                    'text': user.id,
                    'icon': icon,
                    'state': {'selected': false},
                    'more': user,
                    'id': md5_uid,
                    'a_attr': {'class': _class},
                    'data': {
                        'id': user.id,
                        'name': '<input type="text" class="form-control form-control-sm" value="' + user.name + '" readonly>',
                        'title': '<input type="text" class="form-control form-control-sm" value="' + user.video.title + '" readonly>',
                        'score': '',
                        'bulletin': '',
                        'functional': '',
                        'view': ''
                    }
                };
                data.children.push(obj);
            }
        }
        /*-------- group sorting --------*/
        var chld = origin['children'];
        chld && (chld = chld.sort(function (a, b) {
            return (a.group.name > b.group.name) ? 1 : ((b.group.name > a.group.name) ? -1 : 0);
        }));
        /*-------- end sort --------*/
        for (var i in chld) data['children'].push(recursive(chld[i], onlyGroup, prefix));
        return data;
    }, gen_child_node = function (tid, follow) {
        var child = [];

        for (var i in follow) child.push({
            "text": follow[i].user.id,
            'id': md5('task_' + tid + '_' + follow[i].user.id),
            "icon": es5_includes(object.live, follow[i].user.id) ? icons.online : icons.offline,
            "state": {"selected": false},
            "more": follow[i],
            'data': {
                'id': follow[i].user.id,
                'name': '<input type="text" class="form-control form-control-sm" value="' + follow[i].user.info.name + '" readonly>',
                'title': '<input type="text" class="form-control form-control-sm" value="' + follow[i].user.video.title + '" readonly>',
                'score': '',
                'bulletin': '',
                'functional': '<div class="input-group"><button class="btn btn-sm btn-danger cell-btn-delete" task-id="' + tid + '" data-id="' + follow[i].user.id + '" data-loading-text="<span class=\'spinner-grow spinner-grow-sm\'></span>"><i class="fas fa-trash"></i></button></div>',
                'view': '<div class="input-group"><button class="btn btn-sm btn-info cell-input-view" task-id="' + tid + '" data-id="' + follow[i].user.id + '"><i class="fas fa-play"></i></button></div>'
            }
        });

        return child;

    }, gen_task_node = function (task) {

        var group = $('#task_tree').jstree('get_node', md5('task_group_' + task.groupId));

        if (group) {

            var nid = md5('task_task_' + task.id), child = gen_child_node(task.id, task.follow);

            $('#task_tree').jstree().create_node(md5('task_group_' + task.groupId), {
                "text": task.description,
                'id': nid,
                "icon": icons.task,
                "state": {"selected": false},
                "more": task,
                "children": child,
                'data': {
                    'id': '',
                    'name': '',
                    'title': '',
                    'score': gen_input(task.id, 'threshold', task.threshold, false, false),
                    'bulletin': gen_input(task.id, 'line', task.line, false, false),
                    'functional': '<div class="input-group"><button class="btn btn-sm btn-warning cell-input-task" data-id="' + task.id + '"><i class="fas fa-cog"></i></button></div>',
                    'view': ''
                }
            }, "first", function () {
                $('#task_tree').jstree('_open_to', nid);
                $('#task_tree').jstree('open_node', nid);
            });
        }

    }, task_polling = function () {

        var count = 0, task = [], merge = function () {

            var optgroup = {};

            for (var i in task) {
                var nid = md5('task_task_' + task[i].id), node = $('#task_tree').jstree('get_node', nid);

                if (!(task[i].groupId in optgroup)) optgroup[task[i].groupId] = [];
                optgroup[task[i].groupId].push(task[i]);

                if (node) {
                    node.original.more = task[i];

                    for (var j in task[i].follow) {
                        var cid = md5('task_' + task[i].id + '_' + task[i].follow[j].user.id),
                            cnode = $('#task_tree').jstree('get_node', cid),
                            icon = es5_includes(object.live, task[i].follow[j].user.id) ? icons.online : icons.offline;

                        if (cnode && cnode.icon != icon) {
                            cnode.icon = icon;
                            cnode.original.icon = icon;
                            $('#task_tree').jstree('redraw_node', cid);

                            //todo: check and update user name if need
                            //todo: check and update user title if need
                        }
                    }

                    //todo: check has removed of task from other side
                    //todo: check has changed of task from other side
                    //todo: check has removed of cnode from other side

                } else {
                    gen_task_node(task[i]);
                }
            }

            var _selected = {'task': $('#select_task').val(), 'camera': $('#select_camera').val()};

            $('#select_task').empty();
            $('#select_camera').empty();

            for (var gid in optgroup) {
                var group = $('#task_tree').jstree('get_node', md5('task_group_' + gid));
                if (group) {
                    var task_option = '<optgroup label="' + group.text + '" data-icon="' + icons.users + '">';
                    for (var i in optgroup[gid]) {
                        var camera_option = '<optgroup label="' + optgroup[gid][i].description + '" data-icon="' + icons.task + '">';
                        task_option += '<option value="' + optgroup[gid][i].id + '" data-icon="' + icons.task + '">&nbsp;' + optgroup[gid][i].description + '</option>';
                        for (var j in optgroup[gid][i].follow) {
                            camera_option += '<option value="' + optgroup[gid][i].follow[j].user.id + '" data-icon="' + (es5_includes(object.live, optgroup[gid][i].follow[j].user.id) ? icons.online : icons.offline) + '" data-subtext="' + optgroup[gid][i].follow[j].user.video.title + '">&nbsp;' + optgroup[gid][i].follow[j].user.id + '</option>';
                        }
                        $('#select_camera').append(camera_option += '</optgroup>');
                    }
                    $('#select_task').append(task_option += '</optgroup>');
                }
            }

            $('#select_task').val(_selected.task).selectpicker('refresh');
            $('#select_camera').val(_selected.camera).selectpicker('refresh');

            setTimeout(task_polling, 5000);
        };

        ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/live/list', 0, 'GET', {}, null), function (a) {
            a.error || (object.live = a.liveList);
            count += 1;
            count == 2 && merge();
        });
        ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/list', 0, 'GET', {}, null), function (a) {
            a.error || (task = a);
            count += 1;
            count == 2 && merge();
        });
    }, edit_task_form = function (node) {
        //console.log(node);

        if (node) {

            $('#task_modal').attr('data-id', node.id);

            var group = $('#task_tree').jstree('get_node', md5('task_group_' + node.groupId));

            $('#task_enabled').prop('checked', node.enabled);
            $('#task_mailing').prop('checked', node.notify);
            $('#task_name').val(node.description);
            $('#task_group').attr('data-id', node.groupId).val(group.text);
            $('#task_score').val(node.threshold);
            node.line.length && $('#task_line').val(node.line[0]);

            $('#task_follow').val([]).empty();
            for (var i in node.follow) $('#task_follow').append('<option value="' + node.follow[i].user.id + '" selected="selected">' + node.follow[i].user.id + '</option>')
            $('#task_follow').selectpicker('refresh');
        } else {
            $('#task_modal').attr('data-id', '')

            $('#task_enabled').prop('checked', 1);
            $('#task_mailing').prop('checked', 0);
            $('#task_name').val('');
            $('#task_group').attr('data-id', '').val('');
            $('#task_score').val(90);
            $('#task_follow').val([]).empty().selectpicker('refresh');
            $('#task_line').val('');
        }
    }, event_polling = $.timer(function () {
        // wait callback
        event_polling.pause();

        if (object.selected && object.eventPoll.tid) {
            var parameter = 'configId=' + object.eventPoll.tid + '&userId=' + object.selected;

            var api = '/api/va/bovia/fr/snapshot?' + parameter;
            if (object.eventPoll.after) api += '&snapshotId=' + object.eventPoll.after;
            ajax('PUT', '/agent/api', data_format(api, 0, 'GET', {}, null), function (a) {

                if (a.error) {
                    $.growl.error({message: a.error});
                } else if (Object.keys(a).length && object.selected == a.user.id) {
                    a.detectTime && $('#event_detectTime').html(moment(a.detectTime).format('YYYY-MM-DD HH:mm:ss'));

                    var size = auto_resize(), img = $('#event_snapshot');

                    if (object.map && a.latitude && a.longitude) {
                        $('#video_gps').html(a.latitude + ', ' + a.longitude);
                        handlerMarker(object.map, {
                            'id': 'fr',
                            'gps': {
                                'latitude': a.latitude,
                                'longitude': a.longitude,
                                'timestamp': a.detectTime
                            }
                        }, true, true);
                    }

                    $('#device_modal').find('img').attr('src', a.snapshotUrl);

                    if ('device' in a && 'id' in a.device)
                        $('#device_modal').attr('data-id', a.device.id);

                    $('#video_title').html(a.description);

                    img.attr({
                        'src': a.snapshotUrl,
                        'width': size.width,
                        'height': size.height
                    });

                    var svg = '', panel = {'metadata': a.metadata || [], 'roi': a.roi || []};
                    $('#draw-results-container').width(size.width).height(size.height);
                    for (var target in panel) for (var i in panel[target]) {
                        var style = '', hit = panel[target][i];
                        for (var j in hit) switch (j) {
                            case 'x':
                                style += 'left: ' + Math.round(hit[j] * size.width) + 'px; ';
                                break;
                            case 'y':
                                style += 'top: ' + Math.round(hit[j] * size.height) + 'px; ';
                                break;
                            case 'h':
                                style += 'height: ' + Math.round(hit[j] * size.height) + 'px; ';
                                break;
                            case 'w':
                                style += 'width: ' + Math.round(hit[j] * size.width) + 'px; ';
                                break;
                            case 'type':
                                style += 'border:2px solid ' + (hit[j] == 1 ? 'red' : 'blue') + '; ';
                                break;
                        }
                        hit.hasOwnProperty('type') || (style += 'border:2px solid yellow; ');
                        svg += '<div class="fr-draw-face" style="' + style + '; position: absolute;" x="' + hit.x + '" y="' + hit.y + '" w="' + hit.w + '" h="' + hit.h + '"></div>';
                    }
                    $('#draw-results-container').find('span').html(svg);

                    if (object.eventPoll.after != a.id) {
                        object.eventPoll.after = a.id;
                        var event = a.event;
                        if (event) {
                           // console.log(event);
                            var tamplate = function (lazy, data) {
                                var row = '<div class="d-flex flex-row flex-wrap input-view" style="padding: 10px 0; border-bottom:dashed #bbbbbb 2px">';
                                var content = '', html = '<tr>', _rank = {}, rankInfo = data.triggered;
                                if (data.metadata) for (var i in data.metadata) if (data.faceIndex == data.metadata[i].faceIndex) {
                                    var hit = data.metadata[i];
                                    content += ' x="' + hit.x + '"';
                                    content += ' y="' + hit.y + '"';
                                    content += ' w="' + hit.w + '"';
                                    content += ' h="' + hit.h + '" ';
                                    break;
                                }

                                var gps = {lat: '', lng: ''};
                                if (a.latitude) gps.lat = a.latitude;
                                if (a.longitude) gps.lng = a.longitude;

                                var snapshot = '';
                                if (lazy) snapshot = '<img style="border-radius: 4px;" class="lazy img-origin" data-time="' + data.detectTime + '" data-src="' + data.photoUrl + '" data-lng="' + gps.lng + '" data-lat="' + gps.lat + '" width="120" height="160" content="' + data.snapshotUrl + '" onerror="this.src=\'/img/default.jpg\';"' + content + '>';
                                else snapshot = '<img style="border-radius: 4px;" class="img-origin" data-time="' + data.detectTime + '" src="' + data.photoUrl + '" data-lng="' + gps.lng + '" data-lat="' + gps.lat + '" width="120" height="160" content="' + data.snapshotUrl + '" onerror="this.src=\'/img/default.jpg\';"' + content + '>';

                                var detail = '';
                                detail = '<div class="col-12">';
                                detail += (data.rfid) ? gen_accessType(data.rfid) : '';
                                detail += '<p>' + langDict.frTemp + ':&ensp;' + ((data.temperature) ? data.temperature : "null") + '</p>';
                                detail += (data.fever) ? gen_fever(data.fever) : '';
                                detail += (data.liveness) ? gen_liveness(data.liveness) : '';
                                detail += '<p>' + langDict.frDate + ':&ensp;' +  moment(data.detectTime).format('HH:mm:ss')  + '</p>';
                                detail += '</div>';

                                for (const i in rankInfo) _rank[rankInfo[i]['rank']] = rankInfo[i];
                                var selector = 0, selectorStr = '0';
                                for (const i in _rank) {
                                    var _id = i.toString();
                                    if (_id in _rank && _rank[_id].wanted) {
                                        selector = i;
                                        selectorStr = i.toString();
                                        break;
                                    }
                                }

                                var candidateRow = '';
                                for (const i in _rank) {
                                    var _id = i.toString();
                                    if (_id in _rank) {
                                        if (!_rank[_id].idCard) _rank[_id].idCard = uuid();
                                        _rank[_id].idCard in object.blacklist || (object.blacklist[_rank[_id].idCard] = _rank[_id]);

                                        var tmp_left = '', tmp_right = '';
                                        if (lazy) tmp_left = '<img class="lazy img-rank" data-src="' + _rank[_id].featurePhotoUrl + '" content="' + _rank[_id].idCard + '" width="90" height="120" ' + ' onerror="this.src=\'/img/default.jpg\';"><br/>' + Math.round(_rank[_id].score) + '%<br>'+ _rank[_id].name +'</div>';
                                        else tmp_left = '<img class="img-rank" src="' + _rank[_id].featurePhotoUrl + '" content="' + _rank[_id].idCard + '" time="' + data.detectTime + '" width="90" height="120" ' + ' onerror="this.src=\'/img/default.jpg\';">';
                                        tmp_left += '<div class="">' + Math.round(_rank[_id].score) + '%</div>';
                                        tmp_left += '<div class="align-self-center" style="line-height: 2em"><b>' + _rank[_id].name + '</b></div>';
                                        tmp_left = '<div class="col-5 d-flex flex-column justify-content-center align-items-center">' + tmp_left + '</div>';

                                        var wanted = '<button class="btn btn-sm btn-secondary">&emsp;' + langDict.no + '&emsp;</button>';
                                        if (_rank[selectorStr].wantedText.length) {
                                            var wantedText = '';
                                            for (const j in _rank[selectorStr].wantedText) {
                                                wantedText += _rank[selectorStr].wantedText[j] + ' ';
                                            }
                                            wanted = '<button class="btn btn-sm btn-danger" data-container="body" data-toggle="popover" data-trigger="focus" data-placement="left" data-content="' + wantedText + '">&emsp;' + langDict.yes + '&emsp;</button>';
                                        }
                                        var records = '';
                                        if (_rank[selectorStr].tagText && _rank[selectorStr].tagText.length) records += _rank[selectorStr].tagText[0];

                                        tmp_right = '<div class="col-7" style="border-left: solid #bbb 1px; padding-left: 0.5rem">';
                                        tmp_right += '<p>' + langDict.frId + ':&ensp;' + (_rank[selectorStr].idCard.split('-').length > 4 ? '' : _rank[selectorStr].idCard) + '</p>';
                                        tmp_right += '<p>' + langDict.frGender + ':&ensp;' + gender(_rank[selectorStr].gender) + '</p>';
                                        tmp_right += '<p>' + langDict.frAge + ':&ensp;' + gen_age(_rank[selectorStr].birthday) + '</p>';
                                        tmp_right += '<p>' + langDict.frWanted + ':&ensp;' + wanted + '</p>';
                                        tmp_right += '<p class="text-danger" style="margin: 0;">' + langDict.frRecord + ':&ensp;' + records + '</p>';
                                        tmp_right += '</div>';

                                        candidateRow += '<div class="d-flex col-12 col-lg-8" style="border: solid #bbb 1px; margin: 0.5em;padding:1rem 0; border-radius: 15px;">' + tmp_left + tmp_right + '</div>';
                                    }
                                }

                                var content = '<div class="col-6 col-lg-3 col-xl-2 d-flex justify-content-center align-items-center">'+ snapshot +'</div>';
                                content += '<div class="col-6 col-lg-3 col-xl-3 align-self-center">'+ detail +'</div>';
                                content += '<div class="col-12 col-lg-6 col-xl-7 d-flex" style="overflow-y: auto">'+ candidateRow +'</div>';
                                content = '<div class="d-flex flex-wrap input-view">' + content + '</div><hr>';
                                return content;
                            };

                            var tbody = '';
                            for (var i in event) tbody += tamplate(i > 2, event[i]);
                            if (!$('#results').find('input-view').length) $('#results_head').html('<hr><div class="align-self-center"><h5>' + langDict.regconize_result + '</h5></div><hr>');
                            $('#results').prepend(tbody);
                            if($('.input-view').length > 80) $('.input-view').last().remove();
                            //todo: position not fix when scrolling issue
                            $('[data-toggle="popover"]').popover();
                        }
                    }
                }
                // wait callback
                event_polling.play();
            });
        }
    }).set({time: 3000, autostart: false}), edit_man_form = function (man) {

        if (man) {

            object.humans.launch(man);

            $('#human_modal').attr('data-id', man.id);

            $('#man_enabled').prop('checked', man.enabled);
            $('#man_name').val(man.name);
            $('#man_gender').val(man.gender).selectpicker('refresh');
            $('#man_idCard').val(man.idCard);
            $('#man_rfid').val(man.rfid);
            $('#man_birthday').val(moment(man.birthday).format('YYYY-MM-DD'));
            $('#man_birthPlace').val(man.birthPlace);
            $('#man_city').val(man.city);
            $('#man_address').val(man.address);
            $('#man_phone').val(man.phone);
            $('#man_job').val(man.job);
            $('#man_wanted').val(man.wanted).selectpicker('refresh');
            $('#man_tag').val(man.tag).selectpicker('refresh');

        } else {
            object.humans.launch({});

            $('#human_modal').attr('data-id', '');

            $('#man_enabled').prop('checked', 1);
            $('#man_name').val('');
            $('#man_gender').val(0).selectpicker('refresh');
            $('#man_idCard').val('');
            $('#man_rfid').val('');
            $('#man_birthday').val(moment('2015-09-01T00:00:00Z').format('YYYY-MM-DD'));
            $('#man_birthPlace').val('');
            $('#man_city').val('');
            $('#man_address').val('');
            $('#man_phone').val('');
            $('#man_job').val('');
            $('#man_wanted').val([]).selectpicker('refresh');
            $('#man_tag').val([]).selectpicker('refresh');
        }
    }, draw_db_row = function (data, checked) {
        var snapshot = '/img/default.jpg', wantedText = '', tagText = '';

        try {
            snapshot = data['feature'][0]['photoUrl'];
        } catch (e) {

        }

        var checkbox = '<div class="checkbox"> <label>' + '<input type="checkbox" class="selection" data-id="' + data.id + '" ' + (checked ? 'checked' : '') + '>' + '<span class="cr" style="width: 1.5em; height: 1.5em;">' + '<i class="cr-icon fas fa-check" style="font-size: 12pt"></i></span></label></div>';

        if (data.wantedText) for (var i in data.wantedText) wantedText += (data.wantedText[i] + '&ensp;');
        if (data.tagText) for (var i in data.tagText) tagText += (data.tagText[i] + '&ensp;');

        var str = '<div class="align-self-center" style="padding: 0 15px">' + checkbox + '</div>';
        str += '<div class="align-self-center">' + '<div style="width: 160px"><img style="max-width: 100%; height: auto;" data-id="' + data.id + '" class="db-profile" src="' + snapshot + '" onerror="this.src=\'/img/default.jpg\';"></div>' + '</div>';
        str += '<div style="padding: 0 10px"><div class="align-self-center"><span class="form-control" style="background-color: transparent; border: transparent; font-weight: 500; display: inline; font-size: 1.2em">' + data.name + '</span></div><div class="align-self-center form-control" style="background-color: transparent; border: transparent;font-size: 1.2em"><span>' + gen_age(data.birthday) + '</span> ' + langDict.yearsOld + ',&ensp;<span>' + gender(data.gender) + '</span></div><div class="align-self-center form-control text-danger" style="background-color: transparent; border: transparent;font-size: 1.2em">' + wantedText + '</div><div class="align-self-center form-control text-warning" style="background-color: transparent; border: transparent;font-size: 1.2em">' + tagText + '</div></div>';
        str = '<div class="d-flex flex-row">' + str + '</div>';

        return str;
    }, task_view = function (tid, id) {
        if (object.selected != id) {

            object.selected = id;
            event_polling.pause();

            object.map && (object.map.remove(), markers = {"_lastOne": null, "_lastLength": 0});
            object.map = map_initial('map1');
            $('#event_snapshot').attr('src', '/img/default.jpg');

            $('#draw-results-container').find('span').empty();
            $('#event_detectTime').html('');

            $('#device_modal').attr('data-id', '').find('img').attr('src', '/img/default.jpg');
            $('#player').attr({'x': '', 'y': '', 'h': '', 'w': ''});
            $('#minFaceDim').val('');
            $('#scoreThreshold').val('');
            $('#confidenceThreshold').val('');
            $('#candidateScoreThreshold').val('');
            $('#device_follow').val('');

            $('#video_title').html('');
            $('#video_gps').html('');
            // $('#results').html('<div class="col text-center"><br><br><br><i class="fa fa-spinner fa-pulse fa-5x"></i></div>');
            $('#results_head').html('<hr><div class="align-self-center"><h5>' + langDict.regconize_result + '</h5></div><hr><div class="col text-center"><br><br><br><i class="fa fa-spinner fa-pulse fa-5x"></i></div>');
            object.eventPoll.tid = tid;
            object.eventPoll.after = 0;
            event_polling.play();
        }

        $('#task_container').hide();
        $('#event_container').show();

        auto_resize();
    }, utc_converter = function () {
        $('.utc-time').each(function () {
            $(this).html(moment($(this).html()).format(' YYYY-MM-DD HH:mm:ss')).removeClass('utc-time');
        });
    }, draw_human_row = function (data, cb) {
        ajax('PUT', '/agent/fr-human-row', {'payload': data}, function (a) {
            cb(a);
        });
    }, updateUrl = function (target) {
        if (target != ''){
            var frUrl = new URL(window.location.href);
            var data = [['q',target]];
            var search = new URLSearchParams(data);
            frUrl.search = search;
            history.pushState('','',frUrl.href);
        }else
            window.history.replaceState(null, null, window.location.pathname);
    };

    ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/wanted/list', 0, 'GET', {}, null), function (a) {
        if (a.error) {
            $.growl.error({message: a.error});
        } else {
            object.wantedList = a.wantedList;

            for (var i in object.wantedList) {
                $('#man_wanted').append('<option value="' + object.wantedList[i].id + '">' + object.wantedList[i].name + '</option>');
                $('#select_wanted').append('<option value="' + object.wantedList[i].id + '">' + object.wantedList[i].name + '</option>');
                $('#select_dbWanted').append('<option value="' + object.wantedList[i].id + '">' + object.wantedList[i].name + '</option>');
            }

            $('#man_wanted').selectpicker('refresh');
            $('#select_wanted').selectpicker('refresh');
            $('#select_dbWanted').selectpicker('refresh');
        }
    });

    ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/tag/list', 0, 'GET', {}, null), function (a) {
        if (a.error) {
            $.growl.error({message: a.error});
        } else {
            object.tagList = a.tagList;

            for (var i in object.tagList) {
                $('#man_tag').append('<option value="' + object.tagList[i].id + '">' + object.tagList[i].name + '</option>');
                $('#select_tag').append('<option value="' + object.tagList[i].id + '">' + object.tagList[i].name + '</option>');
                $('#select_dbTag').append('<option value="' + object.tagList[i].id + '">' + object.tagList[i].name + '</option>');

                var div = document.createElement('div');
                var tagGroup = $('[name="tag[]"]').first().closest('.form-group');
                var cloneGroup = tagGroup.clone();

                cloneGroup.find('.tag-add').removeClass('tag-add btn-success').addClass('tag-remove btn-danger').html('<i class="fas fa-minus"></i>');
                cloneGroup.find('input').val(object.tagList[i].name).attr('data-id', object.tagList[i].id).addClass('tag-input');

                if (object.tagList[i].locked) {
                    cloneGroup.find('.btn').prop('disabled', 1);
                    cloneGroup.find('input').prop('disabled', 1);
                }

                div.classList.add('col-6');
                div.appendChild(cloneGroup[0]);
                $('#tag-list').append(div);
            }

            $('#man_tag').selectpicker('refresh');
            $('#select_tag').selectpicker('refresh');
            $('#select_dbTag').selectpicker('refresh');
        }
    });

    ajax('PUT', '/agent/api', data_format('/api/user/tree', 0, 'GET', {}, null), function (a) {
        if (a.error) $.growl.error({message: a.error}); else {
            var task = recursive(a, true, 'task'),
                group = recursive(a, true, 'group'),
                user = recursive(a, false, 'user');

            $('#task_tree').jstree({
                "plugins": ["wholerow", "changed", "grid", 'ui', 'search'],
                'core': {
                    'data': task,
                    'themes': {'name': 'proton', 'responsive': true, 'variant': 'large'},
                    'check_callback': true
                },
                "grid": {
                    columns: [
                        {'header': '&nbsp;', 'value': 'id', 'width': '30%'},
                        {'header': langDict.name, 'value': 'name', 'width': '15%'},
                        {'header': langDict.title, 'value': 'title', 'width': '15%'},
                        {'header': langDict.score, 'value': 'score', 'width': '10%'},
                        {'header': langDict.bulletin, 'value': 'bulletin', 'width': '20%'},
                        {'header': langDict.setting, 'value': 'functional', 'width': '5%'},
                        {'header': langDict.viewer, 'value': 'view', 'width': '5%'}
                    ],
                    resizable: true,
                    width: '100%',
                }
            }).bind("loaded.jstree", function (event, data) {
                task_polling();

                try {
                    $(this).jstree('open_node', md5('task_group_' + $('[name="_group"]').attr('content').split('_')[1]));
                } catch (e) {
                    //$(this).jstree('open_all');
                }
            }).on('select_node.jstree', function (event, data) {
                es5_includes([icons.online, icons.offline], data.node.icon) && $('#task_keyword').attr('data-id', data.node.original.more.id).val(data.node.text);
            }).bind("dblclick.jstree", function (event) {
                var node = $(event.target).closest("li");
                if (node.length) {
                    node = $('#task_tree').jstree('get_node', node[0].id);
                    if (node && es5_includes([icons.online, icons.offline], node.icon)) {
                        var parent = $('#task_tree').jstree('get_node', node.parent);
                        task_view(parent.original.more.id, node.original.more.user.id);
                    }
                }
            });

            $('#user_tree').jstree({
                "plugins": ["wholerow", "changed", "grid", 'ui', 'checkbox', 'search'],
                'core': {
                    'data': user,
                    'themes': {'name': 'proton', 'responsive': true, 'variant': 'large'},
                    'check_callback': true
                },
                "grid": {
                    columns: [
                        {'header': '&nbsp;', 'value': 'id', 'width': '40%'},
                        {'header': langDict.name, 'value': 'name', 'width': '30%'},
                        {'header': langDict.title, 'value': 'title', 'width': '30%'}
                    ],
                    resizable: true,
                    width: '100%',
                }
            }).bind("loaded.jstree", function (event, data) {
                try {
                    $(this).jstree('open_node', md5('user_group_' + $('[name="_group"]').attr('content').split('_')[1]));
                } catch (e) {
                    //$(this).jstree('open_all');
                }
            });

            $('#device_tree').jstree({
                "plugins": ["wholerow", "changed", "grid", 'ui', 'search'],
                'core': {
                    'data': user,   //todo: id duplicate
                    'themes': {'name': 'proton', 'responsive': true, 'variant': 'large'},
                    'check_callback': true
                },
                "grid": {
                    columns: [
                        {'header': '&nbsp;', 'value': 'id', 'width': '40%'},
                        {'header': langDict.name, 'value': 'name', 'width': '30%'},
                        {'header': langDict.title, 'value': 'title', 'width': '30%'}
                    ],
                    resizable: true,
                    width: '100%',
                }
            }).bind("loaded.jstree", function (event, data) {
                try {
                    $(this).jstree('open_node', md5('user_group_' + $('[name="_group"]').attr('content').split('_')[1]));
                } catch (e) {
                    //$(this).jstree('open_all');
                }
            }).on('select_node.jstree', function (event, data) {
                if (data.node.icon != icons.users) {
                    $('#device_follow').val(data.node.original.more.id);
                    $('#_user_modal').modal('hide');
                    $('#device_modal').show();
                }
            });

            $('#group_tree').jstree({
                "plugins": ["wholerow", "changed", 'ui', 'search'],
                'core': {
                    'data': group,
                    'themes': {'name': 'proton', 'responsive': true, 'variant': 'large'},
                    'check_callback': true
                }
            }).bind("loaded.jstree", function (event, data) {
                try {
                    $(this).jstree('open_node', md5('group_group_' + $('[name="_group"]').attr('content').split('_')[1]));
                } catch (e) {
                    //$(this).jstree('open_all');
                }
            }).on('select_node.jstree', function (event, data) {
                if ($('#task_tab').is(':visible')) {
                    $('#task_group').attr('data-id', data.node.original.more.id).val(data.node.text);
                } else if ($('#event_tab').is(':visible')) {
                    $('#select_group').empty().append('<option value="' + data.node.original.more.id + '">' + data.node.original.text + '</option>');
                    $('#select_group').selectpicker('refresh');
                }

                $('#group_modal').modal('hide');
            });
        }
    });

    $('#task_keyword').on('keyup', function (e) {
        $(this).val().length == 0 && $('#task_tree').jstree('search', '');
    });

    $('[id$=_search_btn]').on('click', function (e) {
        var btn = $(this), tree = $('#' + btn.attr('id').split('_')[0] + '_tree'),
            val = btn.closest('.input-group').find('input').val();
        val && (btn.button('loading'), setTimeout(function () {
            try {
                tree.jstree(true).search(val);
                tree.find('.jstree-search:eq(0)')[0].scrollIntoView();
            } catch (e) {
                $.growl.warning({message: langDict.notFound});
            }
            btn.button('reset');
        }, 300));
    });

    $(document).on('click', '[class*=cell-input-]', function (e) {
        $(this).focus();
    });

    $(document).on('click', '.cell-input-task', function (e) {
        var tid = $(this).attr('data-id'), nid = md5('task_task_' + tid),
            node = $('#task_tree').jstree('get_node', nid);

        if (node) {

            $('#task_revert').show();
            $('#task_delete').show();

            node = node.original.more;
            edit_task_form(node);

            $('#task_modal').modal({
                backdrop: 'static',
                keyboard: true,
                show: true
            });
        }
    });

    $(document).on('click', '#task_add', function (e) {

        $('#task_revert').hide();
        $('#task_delete').hide();

        edit_task_form(0);

        $('#task_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $('select[id=task_follow]').on('show.bs.select', function (e) {
        $('#user_tree').jstree(true).search('');
        $('#task_modal').hide();

        $('#user_tree').jstree('deselect_all');
        var selected = $('#task_follow').val();
        for (var i in selected) $('#user_tree').jstree('select_node', md5('user_user_' + selected[i]));

        $('#user_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $('.select-group-modal').on('click', function (e) {
        $('#group_tree').jstree(true).search('');
        $('#group_tree').jstree('deselect_all');
        $('#task_tab').is(':visible') && $('#task_modal').hide();

        $('#group_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $('.select-user-modal').on('click', function (e) {
        $('#device_tree').jstree(true).search('');
        $('#device_tree').jstree('deselect_all');
        $('#device_modal').is(':visible') && $('#device_modal').hide();

        $('#_user_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $('#_user_modal').on('hidden.bs.modal', function (e) {
        $('#device_modal').show();
    });

    $('#user_modal,#group_modal').on('shown.bs.modal hidden.bs.modal', function (e) {
        switch (e.type) {
            case 'shown':
                var _tree = '#group_tree';
                e.target.id == 'user_modal' && (_tree = '#user_tree');
                $(_tree).find('.jstree-clicked:eq(0)')[0] && $(_tree).find('.jstree-clicked:eq(0)')[0].scrollIntoView();
                break;
            case 'hidden':
                $('#task_tab').is(':visible') && $('#task_modal').show();
                break;
        }
    });

    $('#users_apply').on('click', function (e) {
        $('#task_follow').val([]).empty();
        var users = [], selected = $('#user_tree').jstree('get_selected');
        for (var i in selected) {
            var node = $('#user_tree').jstree('get_node', selected[i]).original;
            node.icon == icons.user && $('#task_follow').append('<option value="' + node.more.id + '" selected="selected">' + node.more.id + '</option>')
        }
        $('#task_follow').selectpicker('refresh');
    });

    $('#task_view').on('click', function (e) {
        if ($('#task_container').is(':visible')) {
            $('#task_container').hide();
            $('#event_container').show();
            auto_resize();
        } else {
            $('#task_container').show();
            $('#event_container').hide();
        }
    });
    $('#task_keyword').on('click', function (e) {
        if ($('#event_container').is(':visible')) {
            $('#task_container').show();
            $('#event_container').hide();
        }
    });

    $(document).on('click', '.cell-input-btn', function (e) {
        var obj = {}, btn = $(this), input = btn.closest('.input-group').find('input'), tid = input.attr('data-id');

        var nid = md5('task_task_' + tid), node = $('#task_tree').jstree('get_node', nid);

        if (input.hasClass('cell-input-threshold')) {

            if (node.original.more.threshold != input.val()) {

                obj = {
                    'id': tid,
                    'threshold': parseFloat(input.val())
                };

            } else
                $.growl.warning({message: langDict.notChanged});

        } else if (input.hasClass('cell-input-line')) {

            if (node.original.more.line.length == 0 || node.original.more.line[0] != input.val()) {

                obj = {
                    'id': tid,
                    'line': [input.val()]
                };
            }
        }

        if (Object.keys(obj).length) {
            btn.button('loading');

            ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr', 0, 'PUT', obj, null), function (a) {

                if (a.error) {
                    $.growl.error({message: a.error});
                } else {

                    if (obj.threshold) {
                        node.original.more.threshold = obj.threshold;
                        node.data.score = gen_input(tid, 'threshold', obj.threshold);
                    }

                    if (obj.line) {
                        node.original.more.line = obj.line;
                        node.data.bulletin = gen_input(tid, 'line', obj.line[0], false, false);
                    }

                    $('#task_tree').jstree('redraw_node', nid);
                    $.growl.notice({message: langDict.wasModified});
                }

                btn.button('reset');
            });
        }
    });

    $(document).on('click', '.cell-btn-delete', function (e) {
        var btn = $(this), tid = btn.attr('task-id'), id = btn.attr('data-id'), cid = md5('task_' + tid + '_' + id),
            node = $('#task_tree').jstree('get_node', cid), parent = $('#task_tree').jstree('get_node', node.parent);

        node && parent && bootbox.confirm({
            'title': langDict.aruYouSure,
            'message': langDict.doYouWantDelete + '<a href="#" onclick="return false;">' + node.text + '</a> ',
            'buttons': {
                'cancel': {'label': '<i class="fa fa-times"></i> ' + langDict.cancel},
                'confirm': {'label': '<i class="fa fa-check"></i> ' + langDict.apply}
            },
            'callback': function (confirm) {
                if (confirm) {
                    btn.button('loading');

                    var obj = {'id': tid, 'follow': []}, _follow = [];
                    for (var i in parent.original.more.follow) if (parent.original.more.follow[i].user.id != id) {
                        obj.follow.push(parent.original.more.follow[i].user.id);
                        _follow.push(parent.original.more.follow[i]);
                    }

                    ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr', 0, 'PUT', obj, null), function (a) {
                        if (a.error) {
                            btn.button('reset');
                            $.growl.error({message: a.error});
                        } else {
                            parent.original.more.follow = _follow;
                            $('#task_tree').jstree('delete_node', cid);

                            $.growl.notice({message: langDict.wasDeleted});
                        }
                    });
                }
            }
        });
    });

    $('.task-btn').on('click', function (e) {
        var btn = $(this), tid = $('#task_modal').attr('data-id'), obj = {}, btn_state = function (state) {
            if (state) {
                $('#task_apply').button('loading');
                $('#task_revert').button('loading');
                $('#task_delete').button('loading');
                $('#task_close').button('loading');
            } else {
                $('#task_apply').button('reset');
                $('#task_revert').button('reset');
                $('#task_delete').button('reset');
                $('#task_close').button('reset');
            }
        };

        switch (btn.attr('id')) {
            case 'task_apply':
                if (tid) {
                    var nid = md5('task_task_' + tid), node = $('#task_tree').jstree('get_node', nid),
                        data = node.original.more, follow = $('#task_follow').val();

                    if (follow.length != data.follow.length) {
                        obj.follow = follow;
                    } else
                        for (var i in data.follow) if (!es5_includes(follow, data.follow[i].user.id)) { // deselected
                            obj.follow = follow;
                            break;
                        }

                    if (data.enabled != +($('#task_enabled').prop('checked'))) obj.enabled = +($('#task_enabled').prop('checked'));
                    if (data.groupId != $('#task_group').attr('data-id')) obj.groupId = $('#task_group').attr('data-id');
                    if (data.description != $('#task_name').val()) obj.description = $('#task_name').val();
                    if (data.threshold != $('#task_score').val()) obj.threshold = parseFloat($('#task_score').val());
                    if (data.notify != +($('#task_mailing').prop('checked'))) obj.notify = +($('#task_mailing').prop('checked'));

                    if (data.line.length == 0 && $('#task_line').val()) {
                        obj.line = [$('#task_line').val()];
                    } else if (data.line.length && $('#task_line').val() != data.line[0]) {
                        obj.line = [$('#task_line').val()];
                    }

                    if (Object.keys(obj).length) {
                        btn_state(true);

                        obj.id = tid;

                        ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr', 0, 'PUT', obj, null), function (a) {
                            if (a.error) {
                                $.growl.error({message: a.error});
                            } else {
                                node.original.more = a;

                                if (obj.description) {
                                    node.text = obj.description;
                                    node.original.text = obj.description;
                                    node.original.more.description = obj.description;
                                    $('#task_keyword').val(obj.description);

                                    $('#select_task option[value=' + tid + ']').html(obj.description);
                                    $('#select_task').selectpicker('refresh');
                                }

                                if (obj.threshold)
                                    node.data.score = gen_input(tid, 'threshold', obj.threshold);

                                if (obj.line)
                                    node.data.bulletin = gen_input(tid, 'line', obj.line[0], false, false);

                                if (obj.follow) {
                                    // delete each children after append
                                    var _count = node.children.length;
                                    while (_count) {
                                        _count--;
                                        $('#task_tree').jstree('delete_node', node.children[_count]);
                                    }

                                    var child = gen_child_node(tid, a.follow);

                                    for (var cid in child) $('#task_tree').jstree().create_node(nid, child[cid], "first", function () {
                                    });
                                    child.length && $('#task_tree').jstree('_open_to', child[0].id);
                                }

                                if (obj.groupId) {
                                    $('#task_tree').jstree(true).move_node(nid, md5('task_group_' + obj.groupId), 'first', function () {
                                    });
                                } else
                                    $('#task_tree').jstree('redraw_node', nid);
                                $.growl.notice({message: langDict.wasModified});
                            }

                            btn_state(false);
                        });
                    } else {
                        $.growl.warning({message: langDict.notChanged});
                    }
                } else {
                    if ($('#task_name').val().trim().length == 0) {
                        $.growl.warning({message: langDict.noname});
                    } else if ($('#task_group').val().trim().length == 0) {
                        $.growl.warning({message: langDict.noParent});
                    } else if ($('#task_score').val().trim().length == 0) {
                        $.growl.warning({message: langDict.noThreshold});
                    } else {
                        btn_state(true);

                        obj.enabled = +($('#task_enabled').prop('checked'));
                        obj.description = $('#task_name').val();
                        obj.groupId = $('#task_group').attr('data-id');
                        obj.threshold = parseFloat($('#task_score').val());
                        obj.follow = $('#task_follow').val();
                        obj.notify = +($('#task_mailing').prop('checked'));

                        ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr', 0, 'POST', obj, null), function (a) {
                            if (a.error) {
                                $.growl.error({message: a.error});
                            } else {
                                $('#task_modal').modal('hide');
                                gen_task_node(a);
                                $.growl.notice({message: langDict.wasCreated});
                            }

                            btn_state(false);
                        });
                    }
                }
                break;
            case 'task_revert':
                var nid = md5('task_task_' + tid), node = $('#task_tree').jstree('get_node', nid);
                if (node) edit_task_form(node.original.more);
                break;
            case 'task_delete':
                if (tid) {
                    var nid = md5('task_task_' + tid), node = $('#task_tree').jstree('get_node', nid);
                    $('#task_modal').hide();

                    bootbox.confirm({
                        'title': langDict.aruYouSure,
                        'message': langDict.doYouWantDelete + '<a href="#" onclick="return false;">' + node.text + '</a> ',
                        'buttons': {
                            'cancel': {'label': '<i class="fa fa-times"></i> ' + langDict.cancel},
                            'confirm': {'label': '<i class="fa fa-check"></i> ' + langDict.apply}
                        },
                        'callback': function (confirm) {
                            if (confirm) {
                                $('#task_apply').button('loading');
                                $('#task_revert').button('loading');
                                $('#task_delete').button('loading');
                                $('#task_close').button('loading');

                                ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr', 0, 'DELETE', {'id': tid}, null), function (a) {
                                    if (a.error)
                                        $.growl.error({message: a.error});
                                    else {
                                        $('#task_tree').jstree().delete_node(nid, function () {
                                        });

                                        $('#task_apply').button('reset');
                                        $('#task_revert').button('reset');
                                        $('#task_delete').button('reset');
                                        $('#task_close').button('reset');

                                        edit_task_form(0);
                                        $('#task_modal').modal('hide');
                                        $.growl.notice({message: langDict.wasDeleted});
                                    }
                                });
                            } else
                                $('#task_modal').show();
                        }
                    });
                }
                break;
            case 'task_close':
                edit_task_form(0);
                break;
        }
    });

    $('#device_modal').on('shown.bs.modal hidden.bs.modal', function (e) {
        switch (e.type) {
            case 'shown':
                var width = $('#player').width(), height = (width * 9 / 16);
                new SVGCreate('player', $('#event_snapshot').attr('src'), width, height, 'rect', function (svg) {
                    object.roi = svg;

                    var _roi = {'x': 1, 'y': 1, 'w': 0, 'h': 0};

                    for (var i in _roi) if ($('#player').attr(i))
                        _roi[i] = parseFloat($('#player').attr(i));

                    object.roi.svgControlPanel.createRegion([
                        {'x': _roi.x, 'y': _roi.y},
                        {'x': _roi.x + _roi.w, 'y': _roi.y},
                        {'x': _roi.x + _roi.w, 'y': _roi.y + _roi.h},
                        {'x': _roi.x, 'y': _roi.y + _roi.h}]);
                });
                break;
            case 'hidden':
                $('#player').empty();
                object.roi = null;
                break;
        }
    });

    $('.roi-btn').on('click', function (e) {
        if (object.roi && !object.roi.svgControlPanel.isCreating) {
            object.roi.svgControlPanel.isCreating = true;
            object.roi.svgControlPanel.getPolyPoint() && object.roi.svgControlPanel.removePoly();
            var poly = object.roi.svgPanel.rect().fill("#f06").opacity(0.5).draw({snapToGrid: 10});
            poly.on("drawstop", function () {
                object.roi.areaObjectList.push(poly);
                object.roi.svgControlPanel.isCreating = false;
                object.roi.svgControlPanel.getPolyPoint();
            });
        }
    });

    $('#device_apply').on('click', function (e) {
        var btn = $(this), id = object.selected,
            origin = $.extend(true, {}, object.device);

        var obj = {
            'id': object.selected,
            'type': 'ai'
        }

        if (origin.fr) {
            // support fr

            if (object.roi) {
                var roi = object.roi.svgControlPanel.getPolyPoint();

                if (roi) {

                    origin.fr.roi = [{
                        'x': roi[0].x,
                        'y': roi[0].y,
                        'w': roi[1].x - roi[0].x,
                        'h': roi[2].y - roi[1].y
                    }]

                    for (var i in origin.fr.roi[0]) if (origin.fr.roi[0][i] > 1) origin.fr.roi[0][i] = 1;
                } else {
                    $.growl.warning({message: langDict.noRoi});
                    return false;
                }
            }

            $('#minFaceDim').val() && (origin.fr.minFaceDim = parseInt($('#minFaceDim').val()));
            $('#scoreThreshold').val() && (origin.fr.scoreThreshold = parseFloat($('#scoreThreshold').val()));
            $('#confidenceThreshold').val() && (origin.fr.confidenceThreshold = parseFloat($('#confidenceThreshold').val()));
            $('#candidateScoreThreshold').val() && (origin.fr.candidateScoreThreshold = parseFloat($('#candidateScoreThreshold').val()));
            $('#device_follow').val() && (origin.fr.source = $('#device_follow').val());

            obj.config = origin;
            obj.config.enabled = +($('#fr_enabled').prop('checked'));
        }

        btn.button('loading');
        ajax('PUT', '/agent/api', data_format("/api/user/config", 0, "PUT", obj, null), function (a) {
            if (a.error)
                $.growl.error({message: a.error});
            else {
                $.growl.notice({message: langDict.wasModified});
                object.device = origin;
            }
            btn.button('reset');
        });
    });

    $(document).on('click', '.cell-input-view', function (e) {
        var tid = $(this).attr('task-id'), id = $(this).attr('data-id');
        task_view(tid, id);
    });

    $('#results').on('scroll', function (e) {
        $('.lazy').lazy();
    });

    $('#device_btn').on('click', function (e) {
        const id = $('#device_modal').attr('data-id'), btn = $(this);

        object.device = {};

        if (object.selected) {

            btn.button('loading');

            ajax('PUT', '/agent/api', data_format("/api/user/config?id=" + object.selected + '&type[]=ai', 0, "GET", {}, null), function (a) {
                if (a.error)
                    $.growl.error({message: a.error});
                else {
                    object.device = a.ai.config;
                    //console.log(object.device);
                    try {
                        $('#minFaceDim').val(object.device.fr.minFaceDim);
                        $('#scoreThreshold').val(object.device.fr.scoreThreshold);
                        $('#confidenceThreshold').val(object.device.fr.confidenceThreshold);
                        $('#candidateScoreThreshold').val(object.device.fr.candidateScoreThreshold);

                        $('#fr_enabled').prop('checked', object.device.enabled);
                        $('#device_follow').val(object.device.fr.source);

                        $('#player').attr({
                            'x': object.device.fr.roi[0].x,
                            'y': object.device.fr.roi[0].y,
                            'h': object.device.fr.roi[0].h,
                            'w': object.device.fr.roi[0].w
                        });
                    } catch (e) {
                        console.warn(e);
                    }

                    $('#device_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }
                btn.button('reset');
            });
        } else {
            //$.growl.warning({message: langDict.noneSelectedText});
            $.growl.warning({message: 'Device not uploaded configuration'});
        }
    });

    var gps = {
        'lat': '',
        'lng': ''
    };

    $(document).on('mouseenter click', '.table .img-origin', function (e) {
        switch (e.type) {
            case 'click':
                var img = $(this), attr = img.attr('x') && img.attr('y') && img.attr('w') && img.attr('h');

                if (attr) {
                    $('#snapshot_img').attr('src', img.data('src'));
                    $('#original_img').attr({
                        'src': img.attr('content'),
                        'x': img.attr('x'),
                        'y': img.attr('y'),
                        'w': img.attr('w'),
                        'h': img.attr('h')
                    });

                    $('#map2').height(1);
                    object._map && (object._map.remove());
                    object._map = map_initial('map2');

                    if (img.attr('data-lat') && img.attr('data-lng')) {
                        gps = {
                            'lat': img.attr('data-lat'),
                            'lng': img.attr('data-lng')
                        };

                        new L.marker(gps, {
                            'icon': L.ExtraMarkers.icon({
                                icon: 'fa-star',
                                markerColor: 'red',
                                shape: 'circle',
                                prefix: 'fas'
                            })
                        }).addTo(object._map).bindPopup('<label>' + gps.lat + ', ' + gps.lng + '</label>&emsp;');
                        object._map.setView(new L.LatLng(gps.lat, gps.lng));
                    }

                    $('#original_latitude').html(gps.lat);
                    $('#original_longitude').html(gps.lng);

                    if($(this).attr('id')){
                        var vid = $(this).attr('id').split('_')[1];

                        $('#prvious_event').css('display', 'block').attr('data-target', $(this).attr('data-previous'));
                        $('#next_event').css('display', 'block').attr('data-target', $(this).attr('data-next'));

                        $('#original_info1').html($('#e_'+vid).html());
                        $('#original_faceark1').html($('#faceark_'+vid).html());

                        var h_keep = '<label class="custom-control overflow-checkbox">' +
                            '<input type="checkbox" class="overflow-control-input history-keep" data-id="'+ vid +'" ' + (($(this).attr('data-keep') > 0) ? 'checked' : '') + ' >' +
                            '<span class="overflow-control-indicator"></span>' +
                            '<span class="material-control-description">' + langDict.preservation + '</span> ' +
                            '</label>';
                        var h_misjudged = '<label class="custom-control overflow-checkbox">' +
                            '<input type="checkbox" class="overflow-control-input history-misjudged" data-id="'+ vid +'" ' + (($(this).attr('data-misjudged') > 0) ? 'checked' : '') + ' >' +
                            '<span class="overflow-control-indicator"></span>' +
                            '<span class="material-control-description">' + langDict.misjudged + '</span> ' +
                            '</label>';
                        var info = '<tr><th>' + langDict.source + '</th><td>' + $('#lprsource_'+vid).text() + '</td></tr>';
                        info += '<tr><th>' + langDict.lprDate + '</th><td>' + $('#lprtime_'+vid).text() + '</td></tr>';
                        info += '<tr><th>' + langDict.manage + '</th><td>' + h_keep + h_misjudged + '</td></tr>';
                        $('#original_info2').html(info);
                    }else if($(this).data('task')){
                        var vid = $(this).data('task');

                        $('#prvious_event').css('display', 'none');
                        $('#next_event').css('display', 'none');
                        $('#original_info1').html($('#t_'+vid).html());
                        $('#original_info2').html($('#tinfo_'+vid).html());
                    } else{
                        $('#prvious_event').css('display', 'none');
                        $('#next_event').css('display', 'none');
                    }

                    var rid = $(this).attr('id').split('_')[1] , triggered;
                    for (var i in object.history) if (object.history[i].id == rid) {
                        triggered = object.history[i].triggered;
                        break;
                    }
                    $('#candidateList').empty();
                    for(const candidate in triggered){
                        var data = triggered[candidate];
                        var wanted = '<button class="btn btn-sm btn-secondary">&emsp;' + langDict.no + '&emsp;</button>', tagText = '';
                        for(const i in data.tagText) tagText += data.tagText[i];
                        if(data.wanted.length > 0) wanted = '<button class="btn btn-sm btn-danger">&emsp;' + langDict.yes + '&emsp;</button>';
                        var html = '' +
                            '<div style="margin: 1em; border: solid #bbb 1px; border-radius: 4px;">' +
                            '<img event-id="'+ rid +'" content="'+ data.idCard +'" id="'+ rid +'" class="img-rankList" data-src="'+ data.featurePhotoUrl +'" width="160" height="200" onerror="this.src=\'/img/default.jpg\';" style="border-radius: 4px; cursor: pointer; margin: 1em;" src="'+ data.featurePhotoUrl +'">' +
                            '<p align="center">'+ Math.round(triggered[candidate].score) +'%</p>' +
                            '<hr>' +
                            '<div style="margin: 1em; line-height: 2em;">' +
                            '   <div class="d-flex justify-content-center"><h6><b>'+ data.name + '</b></h6></div>' +
                            '   <div style="white-space:nowrap"><span>'+ langDict['frId'] +':&ensp;</span><span>'+ data.idCard +'</span></div>' +
                            '   <div><span>'+ langDict['frGender'] +':&ensp;</span><span>'+ gender(data.gender) +'</span></div>' +
                            '   <div><span>'+ langDict['frAge'] +':&ensp;</span><span>'+ gen_age(triggered[0].birthday) + langDict['yearsOld'] + '</span></div>' +
                            '   <div class="text-warning"><span>'+ langDict['frWanted'] +':&ensp;</span><span>'+ wanted +'</span></div>' +
                            '   <div class="text-danger"><span>'+ langDict['tag'] +':&ensp;</span><span>'+ tagText +'</span></div>' +
                            '</div>' +
                            '</div>';
                        $('#candidateList').append(html);
                    }

                    $('#original_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    }).find('.modal-title').html(moment(img.attr('data-time')).format('YYYY-MM-DD HH:mm:ss'));
                }
                break;
            case 'mouseenter':
                $(this).css('cursor', 'zoom-in');
                break;
        }
    });

    $('#original_modal').on('shown.bs.modal hidden.bs.modal', function (e) {
        var img = $('#original_img');

        switch (e.type) {
            case 'shown':
                var width = img.width(), height = img.height(),
                    attr = img.attr('x') && img.attr('y') && img.attr('w') && img.attr('h');

                $('#map2').height(height);
                if (object._map) object._map.invalidateSize();

                img.parent().height(height);

                if (attr) img.parent().find('span').html($('<div class="fr-draw-face"></div>').css({
                    'width': parseFloat(img.attr('w')) * width,
                    'height': parseFloat(img.attr('h')) * height,
                    'left': parseFloat(img.attr('x')) * width,
                    'top': parseFloat(img.attr('y')) * height,
                    'border': '2px solid red'
                }));

                break;
            case 'hidden':
                img.removeAttr('x y w h').parent().find('span').empty();
                break;
        }
    });

    $('#original_img').bind('load', event_resize);

    $(document).on('click mouseenter mouseleave dblclick', '.img-rankList', function (e) {
        var img = $(this), data;
        for (var i in object.history) if (object.history[i].id == img.attr('event-id')) {
            var triggered = object.history[i].triggered;
            for (var j in triggered) if (triggered[j].featurePhotoUrl == img.attr('data-src')) {
                data = triggered[j];
                break;
            }
            break;
        }

        switch (e.type) {
            case 'dblclick':
                if (data) {
                    data.enabled = 1;
                    edit_man_form(data);

                    object.humans.preview(data);

                    $('#man_snapshot_row').show();
                    $('#man_apply').hide();
                    $('#man_revert').hide();
                    $('#man_delete').hide();

                    $('#human_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }
                break;
        }
    });
    $(document).on('click mouseenter mouseleave dblclick', '.table .img-rank', function (e) {
        var img = $(this), _man = function (img) {
            var data = null;

            if ($('#task_tab').is(':visible')) {
                data = object.blacklist[img.attr('content')];
            } else if ($('#event_tab').is(':visible')) {
                for (var i in object.history) if (object.history[i].id == img.attr('event-id')) {
                    var triggered = object.history[i].triggered;
                    for (var j in triggered) if (triggered[j].featurePhotoUrl == img.attr('data-src')) {
                        data = triggered[j];
                        break;
                    }
                    break;
                }
            }
            return data;
        };

        var man = _man(img)

        switch (e.type) {
            case 'dblclick':
                if (man) {
                    man.enabled = 1;
                    edit_man_form(man);

                    object.humans.preview(man);

                    $('#man_snapshot_row').show();
                    $('#man_apply').hide();
                    $('#man_revert').hide();
                    $('#man_delete').hide();

                    $('#human_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }
                break;
            case 'click':
                var row = img.closest('tr'), inEvent = row.closest('#events').length;

                row.find('img').css('border', "");
                img.css('border', "solid 2px red");

                var tds = inEvent ? '<td colspan="6"></td>' : '<td colspan="10"></td>';
                if (man) {

                    man.idCard.split('-').length > 4 && (man.idCard = '');

                    var wanted = '<button class="btn btn-sm btn-secondary">&emsp;' + langDict.no + '&emsp;</button>',
                        records = '';

                    try {
                        if (man.wantedText.length) {
                            var wantedText = '';
                            for (var i in man.wantedText) {
                                wantedText += man.wantedText[i] + ' ';
                            }
                            wanted = '<button class="btn btn-sm btn-danger" data-container="body" data-toggle="popover" data-trigger="focus" data-placement="left" data-content="' + wantedText + '">&emsp;' + langDict.yes + '&emsp;</button>';
                        }
                    } catch (e) {

                    }
                    man.tag && man.tag.length && (records = man.tagText[0]);

                    if (inEvent)
                        tds = '<td colspan="2">' + man.name + '</td><td>' + gender(man.gender) + '</td><td colspan="2">' + man.idCard + '</td><td>' + gen_age(man.birthday) + '</td><td colspan="2">' + wanted + '</td><td colspan="2">' + records + '</td>';
                    else
                        tds = '<td>' + man.name + '</td><td>' + gender(man.gender) + '</td><td>' + man.idCard + '</td><td>' + gen_age(man.birthday) + '</td><td>' + wanted + '</td><td>' + records + '</td><td>' + moment(img.attr('time')).format('HH:mm:ss') + '</td>';

                    row.next('tr').next('tr').html(tds);

                } else
                    row.next('tr').next('tr').html(tds);

                break;
            case 'mouseenter':
                $(this).css('cursor', 'pointer');
                break;
        }
    });
    // ##### End task event #####
    // ##### Start DB #####
    var db_table_btn = function (action) {
        $('#dbSearchBtn').button(action);
        $('.dt-buttons').find('button').each(function () {
            $(this).button(action);
        });
    }, dbTable = $('#dbTable').DataTable({
        "processing": true,
        "serverSide": true,
        "deferLoading": 0,
        "dom": 'lBprtip',
        "lengthMenu": [5, 10, 25, 50, 100],
        "iDisplayLength": 5,
        'initComplete': function () {
            $('.dt-buttons').find('.btn-secondary').removeClass('btn-secondary');
        },
        "buttons": [{
            "text": langDict['selectAll'],
            'className': 'btn btn-success',
            "action": function () {
                dbTable.rows()[0].length && $('#dbTable > tbody > tr').each(function () {
                    $(this).find('input[type=checkbox]').prop('checked', 1)
                });
            }
        }, {
            "text": langDict['diselectAll'],
            'className': 'btn btn-warning',
            "action": function () {
                dbTable.rows()[0].length && $('#dbTable > tbody > tr').each(function () {
                    $(this).find('input[type=checkbox]').prop('checked', 0)
                });
            }
        }, {
            "text": langDict['delete'],
            'className': 'btn btn-danger',
            "action": function () {
                if (dbTable.rows()[0].length) {
                    var selected = [], name = '';
                    $('#dbTable > tbody > tr').each(function () {
                        var checkbox = $(this).find('input[type=checkbox]');
                        if (checkbox.prop('checked'))
                            selected.push(checkbox.attr('data-id'));
                    });

                    if (selected.length) {
                        db_table_btn('loading');
                        var data = data_format('/api/va/bovia/fr/human/delete', 0, "POST", {'id': selected}, null);

                        ajax('PUT', '/agent/api', data, function (a) {
                            if (a.error) {
                                $.growl.error({message: a.error});
                            } else {
                                $.growl.notice({message: langDict.wasDeleted});
                                //ui remove only, server side need implement delete request
                                for (var i in selected) {
                                    dbTable.row(selected[i]).remove();
                                    $('tr[id=human' + selected[i] + ']').remove();
                                }
                            }
                            db_table_btn('reset');
                        });
                    } else
                        $.growl.warning({message: langDict.noneSelectedText});
                }
            }
        }, {
            "text": langDict['insert'],
            'className': 'btn btn-primary',
            "action": function () {

                $('#man_snapshot_row').hide();
                $('#man_apply').show();
                $('#man_revert').hide();
                $('#man_delete').hide();

                edit_man_form(0);

                $('#human_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }
        }],
        "language": {"url": 'files/' + lang + '.json'},
        "columnDefs": [{"targets": [0], "data": 'man'}],
        "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
            $('img', nRow).lazyLoadXT();
        },
        "ajax": $.fn.dataTable.pipeline(object.dbConditon, function (a) {
            object.humans.suspects = a.origin;
        }), "drawCallback": function (settings) {
            utc_converter()
            $('#dbTable_head_info').html($('#dbTable_info').html());
        }
    });

    // video_search(dbTable, object.dbConditon, function (a) {object.humans.suspects = a.origin;});

    $('[id^=condition_]*').on('click', function () {
        var checked = $(this).prop('checked'), target = $(this).attr('id').split('_')[1];
        checked ? $('#' + target + '_row').show() : $('#' + target + '_row').hide();
    });

    $(document).on('click mouseenter', '.table .db-profile ', function (e) {
        var id = $(this).attr('data-id');

        switch (e.type) {
            case 'click':
                var man = object.humans.getSomeone(id);

                edit_man_form(man);

                $('#man_snapshot_row').show();
                $('#man_apply').show();
                $('#man_revert').show();
                $('#man_delete').show();

                $('#human_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });

                break;
            case 'mouseenter':
                $(this).css('cursor', 'pointer');
                break;
        }
    });

    $('#human_modal').on('hidden.bs.modal', function (e) {
        $(this).attr('data-id', '');
    });

    //file-input preview modal
    $(document).on('show.bs.modal hide.bs.modal', '#kvFileinputModal', function (e) {
        switch (e.type) {
            case 'show':
                $('#human_modal').hide();
                break;
            case 'hide':
                $('#human_modal').show();
                break;
        }
    });

    $('.human-btn').on('click', function (e) {
        switch ($(this).attr('id')) {
            case 'man_apply':
                var id = $('#human_modal').attr('data-id'), method = 'PUT', obj = {
                    'enabled': +($('#man_enabled').prop('checked')),
                    'name': $('#man_name').val().trim(),
                    'gender': parseInt($('#man_gender').val()),
                    'idCard': $('#man_idCard').val().trim(),
                    'birthPlace': $('#man_birthPlace').val().trim(),
                    'birthday': moment($('#man_birthday').val().trim()).format('YYYY-MM-DDTHH:mm:ssZ'),
                    'city': $('#man_city').val().trim(),
                    'address': $('#man_address').val().trim(),
                    'phone': $('#man_phone').val().trim(),
                    'job': $('#man_job').val().trim(),
                    'rfid': $('#man_rfid').val().trim()
                };

                if (id) {   //edit
                    var origin = object.humans.getSomeone(id),
                        wanted = ($('#man_wanted').val() || []), tag = ($('#man_tag').val() || []);

                    obj.id = id;

                    // fixed by me if api give null value
                    origin.wanted || (origin.wanted = []);
                    origin.tag || (origin.tag = []);

                    if (obj.enabled == origin.enabled) delete obj.enabled;
                    if (obj.name == origin.name) delete obj.name;
                    if (obj.gender == origin.gender) delete obj.gender;
                    if (obj.idCard == origin.idCard) delete obj.idCard;
                    if (moment(origin.birthday).format('YYYY-MM-DDTHH:mm:ssZ') == obj.birthday) delete obj.birthday;
                    if (obj.birthPlace == origin.birthPlace) delete obj.birthPlace;
                    if (obj.city == origin.city) delete obj.city;
                    if (obj.address == origin.address) delete obj.address;
                    if (obj.phone == origin.phone) delete obj.phone;
                    if (obj.job == origin.job) delete obj.job;
                    if (obj.rfid == origin.rfid) delete obj.rfid;

                    if (origin.wanted.length != wanted.length) {
                        obj.wanted = wanted;
                    } else {
                        for (var j in origin.wanted) if (!es5_includes(wanted, origin.wanted[j])) { // deselected
                            obj.wanted = wanted;
                            break;
                        }
                    }

                    if (origin.tag.length != tag.length) {
                        obj.tag = tag;
                    } else {
                        for (var j in origin.tag) if (!es5_includes(tag, origin.tag[j])) { // deselected
                            obj.tag = tag;
                            break;
                        }
                    }

                    if (origin.imported) {
                        $.growl.warning({message: langDict.imported});
                        return false;
                    } else if (Object.keys(obj).length == 1) {
                        $.growl.warning({message: langDict.notChanged});
                        return false;
                    }

                } else {
                    method = 'POST';
                }

                object.humans.modal_buttons(true);

                ajax('PUT', '/agent/api', data_format("/api/va/bovia/fr/human", 0, method, obj, null), function (a) {
                    if (a.error)
                        $.growl.error({message: a.error});
                    else {
                        // exists human
                        if (dbTable.rows('#human' + a.id).data()[0]) {

                            object.humans.upadateSomeone(a);

                            var tr = dbTable.row('#human' + a.id), rowindex = tr.index();
                            //dbTable.cell({row: rowindex, column: 0}).data(draw_db_row(a));

                            draw_human_row(a, function (cb) {
                                dbTable.cell({row: rowindex, column: 0}).data(cb.row);
                                utc_converter();
                            });

                        } else if (method == 'POST') {// new human
                            //var page = dbTable.page.info('page').page + 1;
                            //console.log(page);

                            object.humans.suspects.push(a);

                            // draw_human_row(a, function (cb) {
                            //     dbTable.row.add({'man': cb.row}).node().id = 'human' + a.id;
                            //     utc_converter();
                            //     dbTable.draw(false);
                            // });

                            $('#human_modal').attr('data-id', a.id);
                            $('#man_revert').show();
                            $('#man_delete').show();
                            $('#man_snapshot_row').show();
                            object.humans.launch({});

                            //update all table
                            video_search(dbTable, object.dbConditon, function (b) {
                                if (!b.error) {
                                    object.humans.suspects = b.origin;
                                    // let modify again, because db table has refresh
                                    object.humans.upadateSomeone(a);
                                }
                            });
                        }

                        $.growl.notice({message: method == 'POST' ? langDict.wasCreated : langDict.wasModified});
                    }
                    object.humans.modal_buttons(false);
                });

                break;
            case 'man_revert':
                var man = object.humans.getSomeone($('#human_modal').attr('data-id'));
                edit_man_form(man);
                break;
            case 'man_delete':
                $('#human_modal').hide();
                bootbox.confirm({
                    'title': langDict.aruYouSure,
                    'message': langDict.doYouWantDelete + '<a href="#" onclick="return false;">' + $('#man_name').val().trim() + '</a> ',
                    'buttons': {
                        'cancel': {'label': '<i class="fa fa-times"></i> ' + langDict.cancel},
                        'confirm': {'label': '<i class="fa fa-check"></i> ' + langDict.apply}
                    },
                    'callback': function (confirm) {
                        if (confirm) {
                            object.humans.modal_buttons(true);

                            var id = $('#human_modal').attr('data-id'),
                                data = data_format('/api/va/bovia/fr/human/delete', 0, "POST", {'id': [id]}, null);

                            ajax('PUT', '/agent/api', data, function (a) {
                                if (a.error) {
                                    $.growl.error({message: a.error});
                                } else {
                                    //ui remove only, server side need implement delete request
                                    id = 'human' + id;
                                    dbTable.row(id).remove();
                                    $('tr[id=' + id + ']').remove();

                                    edit_man_form(0);
                                    $('#human_modal').attr('data-id', '').modal('hide');
                                    $.growl.notice({message: langDict.wasDeleted});
                                }
                                object.humans.modal_buttons(false);
                            });
                        } else
                            $('#human_modal').show();
                    }
                });
                break;
            case 'man_close':
                $('#human_modal').attr('data-id', '');
                break;
        }
    });

    $(document).on('click', '.feature-photo', function (e) {
        var refresh_feature = function (id) {
            ajax('PUT', '/agent/api', data_format("/api/va/bovia/fr/human?id=" + id, 0, 'GET', {}, null), function (man) {
                if (man.error)
                    chkbox.prop('checked', 0);
                else {
                    object.humans.launch(man);

                    //update someone
                    object.humans.upadateSomeone(man);
                }
            });
        };

        var chkbox = $(this), id = chkbox.attr('data-id'), type = chkbox.attr('data-type'), obj = {},
            human = $('#human_modal').attr('data-id');

        if (chkbox.attr('data-done') == '1') {

            if (chkbox.attr('data-score')) {
                var score = parseFloat(chkbox.attr('data-score'));
                if (score < 0.5) {
                    chkbox.prop('checked', 0);
                    $.growl.warning({message: langDict.feature + ' ' + langDict.bad});
                    return;
                }
            }

            chkbox.prop('disabled', true);
            object.humans.modal_buttons(true);
            obj.enabled = +(chkbox.prop('checked'));
            type == 'task' ? obj.featureTaskId = id : obj.id = id;
            ajax('PUT', '/agent/api', data_format("/api/va/bovia/fr/human/feature", 0, type == 'task' ? "POST" : "PUT", obj, null), function (a) {
                if (a.error) {
                    chkbox.prop('checked', !obj.enabled);
                    $.growl.error({message: a.error});
                } else {
                    $.growl.notice({message: (obj.enabled ? langDict.add : langDict.remove)});
                    refresh_feature(human);
                }
                chkbox.prop('disabled', 0);
                object.humans.modal_buttons(false);
            });
        } else {
            $.growl.warning({message: langDict.noFeature})
            refresh_feature(human);
        }
    });

    $('#dbSearchBtn').on('click', function (e) {
        var btn = $(this), data = {};
        $('#condition_dbName').prop('checked') && $('#select_dbName').val().trim().length && (data['name'] = $('#select_dbName').val().trim());
        $('#condition_dbIdCard').prop('checked') && $('#select_dbIdCard').val().trim().length && (data['idCard'] = $('#select_dbIdCard').val().trim());
        $('#condition_dbTag').prop('checked') && $('#select_dbTag').val().length && (data['tag'] = $('#select_dbTag').val());
        $('#condition_dbWanted').prop('checked') && $('#select_dbWanted').val().length && (data['wanted'] = $('#select_dbWanted').val());

        if ((data.wanted || data.tag) && !data.name) {
            $.growl.warning({message: langDict.noname});
            return false;
        } else if (Object.keys(data).length) {
            btn.button('loading');
            object.dbConditon = data_format('/api/va/bovia/fr/human/search', 0, 'POST', data, null);
            video_search(dbTable, object.dbConditon, function (a) {
                if (!a.error) {
                    object.humans.suspects = a.origin;
                    $.growl.notice({message: langDict['result'] + ': ' + a.total + ' ' + langDict.row});
                }
                btn.button('reset');
            });
        } else
            $.growl.warning({message: langDict.noInputData});
    });

    //#### End DB ####
    //#### Start Event Table ####
    date_range_init(moment().subtract(6, 'days'), moment());

    var event_table_btn = function (action) {
        $('#eventSearchBtn').button(action);
        $('.dt-buttons').find('button').each(function () {
            $(this).button(action);
        });
    }, eventTable = $('#events').DataTable({
        "processing": true,
        "serverSide": true,
        "deferLoading": 0,
        "dom": 'lBprtip',
        "lengthMenu": [10, 25, 50, 100],
        "iDisplayLength": 25,
        'initComplete': function () {
            $('.dt-buttons').find('.btn-secondary').removeClass('btn-secondary');
        },
        "buttons": [{
            "text": langDict['selectAll'],
            'className': 'btn btn-success',
            "action": function () {
                eventTable.rows()[0].length && $('#events > tbody > tr').each(function () {
                    $(this).find('input[type=checkbox][class=selection]').prop('checked', 1)
                });
            }
        }, {
            "text": langDict['diselectAll'],
            'className': 'btn btn-warning',
            "action": function () {
                eventTable.rows()[0].length && $('#events > tbody > tr').each(function () {
                    $(this).find('input[type=checkbox][class=selection]').prop('checked', 0)
                });
            }
        }, {
            "text": langDict['delete'],
            'className': 'btn btn-danger',
            "action": function () {
                if (eventTable.rows()[0].length) {
                    var selected = [], name = '';
                    $('#events > tbody > tr').each(function () {
                        var checkbox = $(this).find('input[type=checkbox][class=selection]');
                        if (checkbox.prop('checked'))
                            selected.push({'id': checkbox.attr('data-id'), 'configId': checkbox.attr('data-task')});
                    });

                    if (selected.length) {
                        event_table_btn('loading');
                        var data = data_format('/api/va/bovia/fr/event/delete', 0, "POST", {'event': selected}, null);

                        ajax('PUT', '/agent/api', data, function (a) {
                            if (a.error) {
                                $.growl.error({message: a.error});
                            } else {
                                $.growl.notice({message: langDict.wasDeleted});
                                //ui remove only, server side need implement delete request
                                for (var i in selected) {
                                    var row_id = 'history' + selected[i].id + '_' + selected[i].configId;
                                    eventTable.row(row_id).remove();
                                    $('tr[id=' + row_id + ']').remove();
                                }
                            }
                            event_table_btn('reset');
                        });
                    } else
                        $.growl.warning({message: langDict.noneSelectedText});
                }
            }
        }, {
            "text": langDict['preservation'],
            'className': 'btn btn-success',
            "action": function () {
                if (eventTable.rows()[0].length) {
                    var selected = [], name = '';
                    $('#events > tbody > tr').each(function () {
                        var checkbox = $(this).find('input[type=checkbox][class=selection]');
                        if (checkbox.prop('checked'))
                            selected.push({'id': checkbox.attr('data-id'), 'configId': checkbox.attr('data-task')});
                    });

                    if (selected.length) {
                        event_table_btn('loading');
                        var data = data_format('/api/va/bovia/fr/event/update', 0, "POST", {
                            'event': selected,
                            'keep': 1
                        }, null);

                        ajax('PUT', '/agent/api', data, function (a) {
                            if (a.error) {
                                $.growl.error({message: a.error});
                            } else {
                                $.growl.notice({message: langDict.wasModified});
                                //ui remove only, server side need implement delete request
                                for (var i in selected) {
                                    var row_id = 'history' + selected[i].id + '_' + selected[i].configId;
                                    $('tr[id=' + row_id + ']').find('.history-keep[type=checkbox]').prop('checked', 1);
                                }
                            }
                            event_table_btn('reset');
                        });
                    } else
                        $.growl.warning({message: langDict.noneSelectedText});
                }
            }
        }, {
            "text": langDict['disposable'],
            'className': 'btn btn-warning',
            "action": function () {
                if (eventTable.rows()[0].length) {
                    var selected = [], name = '';
                    $('#events > tbody > tr').each(function () {
                        var checkbox = $(this).find('input[type=checkbox][class=selection]');
                        if (checkbox.prop('checked'))
                            selected.push({'id': checkbox.attr('data-id'), 'configId': checkbox.attr('data-task')});
                    });

                    if (selected.length) {
                        event_table_btn('loading');
                        var data = data_format('/api/va/bovia/fr/event/update', 0, "POST", {
                            'event': selected,
                            'keep': 0
                        }, null);

                        ajax('PUT', '/agent/api', data, function (a) {
                            if (a.error) {
                                $.growl.error({message: a.error});
                            } else {
                                $.growl.notice({message: langDict.wasModified});
                                //ui remove only, server side need implement delete request
                                for (var i in selected) {
                                    var row_id = 'history' + selected[i].id + '_' + selected[i].configId;
                                    $('tr[id=' + row_id + ']').find('.history-keep[type=checkbox]').prop('checked', 0);
                                }
                            }
                            event_table_btn('reset');
                        });
                    } else
                        $.growl.warning({message: langDict.noneSelectedText});
                }
            }
        }],
        "language": {"url": 'files/' + lang + '.json'},
        autoWidth: false,
        "columnDefs": [
            {'data': 'selection', "targets": [0], "orderable": false, "className": "text-center", 'width': '6%'},
            {'data': 'body', "targets": [1], "orderable": false, 'width': '75%'},
        ],
        "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
            $('img', nRow).lazyLoadXT();
        },
        "ajax": $.fn.dataTable.pipeline(object.eventConditon, function (a) {
            object.history = a.origin;
        }), "drawCallback": function (settings) {
            utc_converter();
            $('#events_head_info').html($('#events_info').html());
        }
    });

    // video_search(eventTable, object.eventConditon, function (a) { object.history = a.origin; });

    // $(document).on('scroll', function (e) {
    //     $('.utc-time').each(function () {
    //         $(this).html(moment($(this).html()).format(' YYYY-MM-DD HH:mm:ss')).removeClass('utc-time');
    //     });
    // });

    $('#condition_task').on('click', function (e) {
        if ($(this).prop('checked')) {
            $('#condition_group').prop('checked', 0);
            $('#group_row').hide();
        }
    });

    $('#condition_group').on('click', function (e) {
        if ($(this).prop('checked')) {
            $('#condition_task').prop('checked', 0);
            $('#task_row').hide();
        }
    });

    $('#eventSearchBtn').on('click', function (e) {
        var btn = $(this), data = {};

        $('#condition_task').prop('checked') && $('#select_task').val() && (data['config'] = [$('#select_task').val()]);
        $('#condition_camera').prop('checked') && $('#select_camera').val() && (data['user'] = [$('#select_camera').val()]);
        $('#condition_group').prop('checked') && $('#select_group').val() && (data['group'] = [$('#select_group').val()]);
        $('#condition_wanted').prop('checked') && $('#select_wanted').val().length && (data['wanted'] = $('#select_wanted').val());
        $('#condition_tag').prop('checked') && $('#select_tag').val().length && (data['tag'] = $('#select_tag').val());

        $('#condition_name').prop('checked') && $('#select_name').val().length && (data['name'] = $('#select_name').val());
        $('#condition_idCard').prop('checked') && $('#select_idCard').val().length && (data['idCard'] = $('#select_idCard').val());

        $('#condition_misjudged').prop('checked') && (data['misjudged'] = 1);
        $('#condition_keep').prop('checked') && (data['keep'] = 1);

        if ($('#condition_time').prop('checked')) {
            data['startTime'] = $('#search_time').data('daterangepicker').startDate.format('YYYY-MM-DDTHH:mm:ssZ');
            data['stopTime'] = $('#search_time').data('daterangepicker').endDate.format('YYYY-MM-DDTHH:mm:ssZ');
        }

        if (Object.keys(data).length) {
            btn.button('loading');
            object.eventConditon = data_format('/api/va/bovia/fr/event/search', 0, 'POST', data, 30);
            video_search(eventTable, object.eventConditon, function (a) {
                if (!a.error) {
                    object.history = a.origin;
                    $.growl.notice({message: langDict.result + ': ' + a.total + ' ' + langDict.row});
                }
                btn.button('reset');
            });
        } else
            $.growl.warning({message: langDict.noInputData});
    });

    $(document).on('click', '#next_event, #prvious_event', function (e){
        var target = $(this).attr('data-target');
        switch (target) {
            case 'event_0':
                $('#original_modal').modal('hide');
                $.growl.notice({message: langDict.reachtop});
                $('html, body').animate({scrollTop:0}, 1000);
                break;
            case 'event_999999':
                $('#original_modal').modal('hide');
                $.growl.notice({message: langDict.reachbottom});
                $('html, body').animate({scrollTop:$(document).height()}, 1000);
                break;
            default:
                $('#'+target).click();
        }
    });

    $('.tag-list').on('click', function (e) {
        //console.log(object.tagList);

        $('#tag_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.tag-add, .tag-remove, .tag-apply, .tag-revert', function (event) {
        var btn = $(this), target = btn.closest('.input-group'), id = target.find('.tag-input').attr('data-id'),
            name = target.find('input').val().trim();

        var reset = function () {
            for (var i in object.tagList) if (object.tagList[i].id == id) {
                target.find('.tag-revert').addClass('d-none');
                target.find('.tag-input').val(object.tagList[i].name);
                target.find('.tag-apply').removeClass('btn-primary tag-apply').addClass('btn-danger tag-remove').html('<i class="fas fa-minus"></i>');
                break;
            }
        };

        if (btn.hasClass('tag-revert')) {
            reset();
        } else if (btn.hasClass('tag-add')) {
            if (name.length) {

                //avoid clone loading button
                var clone = target.closest('.form-group').clone();

                btn.button('loading');
                ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/tag', 0, 'POST', {'name': name}, null), function (a) {
                    if (a.error) {
                        $.growl.error({message: a.error});
                    } else {

                        var div = document.createElement('div');

                        clone.find('.tag-add').removeClass('tag-add btn-success').addClass('tag-remove btn-danger').html('<i class="fas fa-minus"></i>');
                        clone.find('input').attr('data-id', a.id).addClass('tag-input');
                        div.classList.add('col-6');
                        div.appendChild(clone[0]);
                        $('#tag-list').prepend(div);

                        object.tagList.push(a);

                        $('#man_tag').prepend('<option value="' + a.id + '">' + a.name + '</option>').selectpicker('refresh');
                        $('#select_tag').prepend('<option value="' + a.id + '">' + a.name + '</option>').selectpicker('refresh');
                        $('#select_dbTag').prepend('<option value="' + a.id + '">' + a.name + '</option>').selectpicker('refresh');

                        $.growl.notice({message: langDict.wasCreated});
                    }
                    btn.button('reset');
                });
            } else $.growl.warning({message: langDict.noInputData});
        } else if (btn.hasClass('tag-remove')) {

            btn.button('loading');

            ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/tag', 0, 'DELETE', {'id': id}, null), function (a) {
                if (a.error) {
                    $.growl.error({message: a.error});
                    btn.button('reset');
                } else {
                    target.closest('.col-6').remove();

                    //remove tag from client side
                    $('#man_tag option[value=' + id + ']').remove();
                    $('#select_tag option[value=' + id + ']').remove();
                    $('#select_dbTag option[value=' + id + ']').remove();

                    $('#man_tag').selectpicker('refresh');
                    $('#select_tag').selectpicker('refresh');
                    $('#select_dbTag').selectpicker('refresh');

                    var i = object.tagList.length;
                    while (i > 0) {
                        i--;
                        if (object.tagList[i].id == id) {
                            object.tagList.splice(i, 1);
                            break;
                        }
                    }
                    $.growl.notice({message: langDict.wasDeleted});
                }
            });

        } else if (btn.hasClass('tag-apply')) {
            if (name.length) {

                target.find('.tag-apply').button('loading');
                target.find('.tag-revert').button('loading');

                ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/tag', 0, 'PUT', {
                    'id': id,
                    'name': name
                }, null), function (a) {

                    target.find('.tag-apply').button('reset');
                    target.find('.tag-revert').button('reset');

                    if (a.error) {
                        $.growl.error({message: a.error});
                    } else {
                        $('#man_tag option[value=' + id + ']').html(name);
                        $('#select_tag option[value=' + id + ']').html(name);
                        $('#select_dbTag option[value=' + id + ']').html(name);

                        $('#man_tag').selectpicker('refresh');
                        $('#select_tag').selectpicker('refresh');
                        $('#select_dbTag').selectpicker('refresh');

                        for (var i in object.tagList) if (object.tagList[i].id == id) {
                            object.tagList[i].name = name;
                            break;
                        }
                        reset();
                        $.growl.notice({message: langDict.wasModified});
                    }
                });
            } else $.growl.warning({message: langDict.noInputData});
        }
    });
    $(document).on('keyup', '.tag-input', function (e) {
        var input = $(this), id = input.attr('data-id'), parent = input.parent();

        for (var i in object.tagList) if (object.tagList[i].id == id) {
            if (object.tagList[i].name != input.val()) {
                parent.find('.tag-remove').removeClass('btn-danger tag-remove').addClass('btn-primary tag-apply').html('<i class="fas fa-check"></i>');
                parent.find('.tag-revert').removeClass('d-none');
            } else {
                parent.find('.tag-apply').removeClass('btn-primary tag-apply').addClass('btn-danger tag-remove').html('<i class="fas fa-minus"></i>');
                parent.find('.tag-revert').addClass('d-none');
            }
            break;
        }
    });

    $(document).on('click', '.history-keep, .history-misjudged', function (e) {
        var checkbox = $(this),
            obj = {'event': [{'id': checkbox.attr('data-id')}]};

        if (checkbox.hasClass('history-keep')) {
            obj.keep = +(checkbox.prop('checked'));
        } else if (checkbox.hasClass('history-misjudged')) {
            obj.misjudged = +(checkbox.prop('checked'));
        }

        ajax('PUT', '/agent/api', data_format('/api/va/bovia/fr/event/update', 0, "POST", obj, null), function (a) {
            if (a.error) {
                $.growl.error({message: a.error});
                checkbox.prop('checked', !checkbox.prop('checked'))
            } else {
                $.growl.notice({message: langDict.wasModified});
                $('*[data-id=' + obj.event[0].id + ']').each(function( index ) {
                    if($(this).hasClass('history-keep')) $(this).prop('checked', obj.keep);
                    if($(this).hasClass('history-misjudged')) $(this).prop('checked', obj.misjudged);
                });
                $("#event_" + obj.event[0].id).attr('data-keep', obj.keep);
                $("#event_" + obj.event[0].id).attr('data-misjudged', obj.misjudged);
            }
        });
    });

    $(window).resize(function (e) {
        auto_resize();
        //object.roi && object.roi.resize(width, heigh);
    });

    $('select[id=select_group]').on('show.bs.select', function (e) {
        $('#group_tree').jstree(true).search('');
        $('#group_tree').jstree('deselect_all');

        // var selected = $(this).val();
        // for (var i in selected) $('#group_tree').jstree('select_node', md5('group_group_' + selected[i]));

        $('#group_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var target = e.target.hash;
        if (target == '#task_tab') {auto_resize();updateUrl('');}
        if (target == '#event_tab') updateUrl('event');
        if (target == '#db_tab') updateUrl('db');
        if (target == '#info') event_resize();

    });
});