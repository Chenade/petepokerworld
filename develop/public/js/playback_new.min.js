/**
 * Created by Cloud on 2016/12/8.
 */
$(document).ready(function () {
    loading(true);
    $('#searchBtn').button('loading');
    $('.overflow-auto').height($(window).height() * 0.7);
    var object = {
            'user': [],
            'group': [],
            'video':{
                'type': 'minutes',
                'list':[],      //current data-id time range videolist
                'index':0,      //object.video.list playing index
                'time': '',     //current data-id
                'id': '',       //current video id
                'live_id':'',
                'speed':1,
                'rewind': false
            },
            'videolist':{
                'hour':{},
                'min':{},
                'sec':{}
            }
        },
        playbackList = [],
        downloaded = [],
        gps = {},
        foucs = {},
        map1,
        start = moment().subtract(6, 'days'), end = moment();
    var plyr = null, hls = null, controls = [
        'play-large', // The large play button in the center
        'restart', // Restart playback
        'rewind', // Rewind by the seek time (default 10 seconds)
        'play', // Play/pause playback
        'fast-forward', // Fast forward by the seek time (default 10 seconds)
        'progress', // The progress bar and scrubber for playback and buffering
        'current-time', // The current time of playback
        'duration', // The full duration of the media
        'mute', // Toggle mute
        'volume', // Volume control
        'captions', // Toggle captions
        'settings', // Settings menu
        'airplay', // Airplay (currently Safari only)
        'fullscreen', // Toggle fullscreen
    ];
    var find = new Date(), timeoutID, intervalRewind, api_record = 0, dirrecord;

    //function
    var gen_input = function (id, value) {
        return '<div class="input-group"><input type="text" class="form-control form-control-sm" data-id="' + id + '" value="' + value + '" disabled></div>';
    }, time_pad = function (time) {
        if(time < 10)
            return "0"+time.toString();
        else
            return time
    }, getCursorPosition = function (e) {
        var posx = 0;
        var posy = 0;
        if (!e) var e = window.event;
        if (e.pageX || e.pageY)     {
            posx = e.pageX- document.documentElement.scrollLeft- document.body.scrollLeft;
            posy = e.pageY- document.documentElement.scrollTop- document.body.scrollTop;
        }
        else if (e.clientX || e.clientY)     {
            posx = e.clientX ;
            posy = e.clientY ;
        }
        return posx;
    }, getElementByPoint = function (parent, x, y) {
        if ( x < parent.width() && y < parent.height() ) {
            return document.elementFromPoint( x + parent.offset().left- window.pageXOffset, y + parent.offset().top- window.pageYOffset );
        } else {
            return null;
        }
    }, recursive = function (origin, onlyGroup, prefix) {
        var data = {
            'text': origin.group.name,
            'icon': icons.users,
            'state': {'selected': false},
            'more': origin.group,
            'children': [],
            'id': prefix + '_group_' + origin.group.id,
            'a_attr': {'class': 'text-primary'}
        };
        var users = [];
        if (!onlyGroup) {
            users = origin.userList;
            data.data = {
                'id': origin.group.name,
                'title': ''
            };
        }
        if (users.length) {
            /*-------- user sorting --------*/
            users = users.sort(function (a, b) {
                return (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0);
            });
            /*-------- end sort --------*/
            for (var i in users) {
                var user = users[i];

                user.gid = origin.group.id;
                user.group = origin.group.name;

                var obj = {
                    'text': user.id,
                    'icon': icons.camera,
                    'state': {'selected': false},
                    'more': user,
                    'id': prefix + '_user_' + user.id,
                    'a_attr': {'class': 'text-secondary'},
                    'data': {
                        'id': user.id,
                        'name': gen_input(user.id, user.info.name),
                        'title': gen_input(user.id, user.video.title)
                    }
                };
                data.children.push(obj);
            }
        }
        /*-------- group sorting --------*/
        var chld = origin['children'];
        chld && (chld = chld.sort(function (a, b) {
            return (a.group.name > b.group.name) ? 1 : ((b.group.name > a.group.name) ? -1 : 0);
        }));
        /*-------- end sort --------*/
        for (var i in chld) data['children'].push(recursive(chld[i], onlyGroup, prefix));
        return data;
    }, time_search_initalize = function () {
        // var height = $('#position').height();
        // console.log(height);
        // $("button[data-direction='up']").css('top', height * -2);
        // $("button[data-direction='down']").css('top', height *2);

        $('#datetimepicker1').datetimepicker({
            format:"YYYY-MM-DD HH:mm",
            defaultDate:new Date(),
            maxDate: new Date(),
            locale: lang,
        });
    }, initalize_timeline = function(date,refresh) {
        find = date;
        $("#father-timeline").remove();
        $("#timeline-container").append("<div class=\"father-timeline\" id=\"father-timeline\"></div>");

        $('#read').html(moment(date).format('YYYY-MM-DD HH:mm:ss'));
        var live_id = moment(date).format('YYYY-MM-DDTHH:mm:ssZ'), id = '';
        if (object.video.type == 'hours') id = moment(date).format('YYYY-MM-DDTHH:00:00Z');
        if (object.video.type == 'minutes') id = moment(date).format('YYYY-MM-DDTHH:mm:00Z');
        if (object.video.type == 'seconds') id = live_id;
        $("#father-timeline").append("<div data-id=\"" + id + "\" data-video=\"default\" data-url=\"default\" class=\"sub tic\" ></div>");
        $("#father-timeline").append("<div data-id=\"" + live_id + "\" data-video=\"Live\" data-url=\"Live\" class=\"sub tic\" ></div>");

        for (var i = 0; i< 120;i++) {
            Draw_tic();
            refreshtimeline();
            if($("#read").html() != moment(date).format('YYYY-MM-DD HH:mm:ss')) {
                $("#father-timeline div:first-child").remove();
                break;
            }
        }

        downloadapi(date);
        if(refresh) refreshvideo();

        $("#father-timeline").draggable({
            axis:"x",
            refreshPositions: true,
            start: function(e, ui) {
                timeoutID = window.setInterval(( function() {
                    refreshtimeline();
                }), 1);
                $('#plyr')[0].pause();
                dirrecord = getCursorPosition(e);
            },
            drag: function(e, ui){
                //get drag direction
                var dirnew = (getCursorPosition(e)), direction = (dirnew >= dirrecord) ? "R" : "L";
                if (Math.abs(dirnew - dirrecord) > 3) dirrecord = dirnew-1;
                if(direction == "L") Draw_tic('NEW');
                else Draw_tic();
            },
            stop: function(e, ui) {
                if ($("#father-timeline").position().left > 150)  $("#father-timeline").css('left','0');
                window.clearInterval(timeoutID);
                refreshtimeline();
                refreshvideo();
                downloadapi(object.video.time);
            }
        });
    }, refreshtimeline = function(){
        var left = ($(".finger").position().left + $(".finger").width()) - $('.tic').width()*2;
        var m = getElementByPoint($("#timeline-container"), left, 27);
        if(m!=null){
            if (m.className.includes("tic")) {
                $("#read").html(moment(m.dataset.id).format('YYYY-MM-DD HH:mm:ss'));
                $("#datepicker").val(moment(m.dataset.id).format('YYYY-MM-DD'));
                $("#month").val(moment(m.dataset.id).month() +1).selectpicker('refresh');
                $("#day").val(moment(m.dataset.id).date()).selectpicker('refresh');
                $("#hour").val(moment(m.dataset.id).hours()).selectpicker('refresh');
                if(object.video.type != 'hours') $("#min").val(moment(m.dataset.id).minutes()).selectpicker('refresh');
                var left_ = getElementByPoint($("#timeline-container"), 0, 27);
                var right = getElementByPoint($("#timeline-container"), ($(".finger").position().left + $(".finger").width())*2, 27);
                $("#left_time").html((left_ != null) ? moment(left_.dataset.id).format('YYYY-MM-DD HH:mm:ss') : '');
                $("#right_time").html((right != null) ? moment(right.dataset.id).format('YYYY-MM-DD HH:mm:ss') : '');
            }
        }
    }, refreshvideo = function(){
        refreshtimeline();
        var left = ($(".finger").position().left + $(".finger").width()) - $('.tic').width()*2;
        var m = getElementByPoint($("#timeline-container"), left, 27);
        //remove playing class
        $(".cur").css('background-color','rgb(0, 102, 102)');
        $("div").removeClass("cur");
        if(m!=null){
            if(m.classList.contains('finger')) {
                $("#Go_Live").click();
                initalize_timeline(find, false);
            }
            else if(m.dataset.video && m.dataset.video != 'undefined'){
                object.video.list = m.dataset.video.split('_');
                object.video.index = 0;
                object.video.time = m.dataset.id;
                getVideo(object.video.list[object.video.index]);
            }
        }
    }, getVideo  = function(id){
        if(id){
            if(id == 'default'){
                $('#startTime').html('');
                $('#stopTime').html('');
                $('#device_info_type').html('');
                $('#file_size').html('');
                $('#type').html('');
                $('#video_title').val('');
                $('#download').attr('onclick', '');
                $('#live_tag').css('display', 'none');
                $("#gps_list").empty();
                $(".cur").css('background-color','darkgreen');
                $("div").removeClass("cur");
                plyr && (plyr.destroy(), plyr = null);
                $('#player').html('<video preload="none" id="plyr" width="'+$('#map1').width()+'" height="'+$('#map1').height()+'" poster="img/bovia.png" autoplay controls crossorigin></video>');
                plyr_progress();
                $.growl.notice({message: langDict['selectedTime'] + langDict['noPlayback']});

            }else if(id != 'default' && id != object.video.id){
                foucs = {};
                ajax('PUT', '/agent/api', data_format('/api/video?id=' + id, 0, 'GET', {}, null), function (a) {
                    if(!a.error){
                        foucs = a;
                        object.video.id = id;
                        $('#startTime').html(moment(a.startTime).local().format('YYYY-MM-DD HH:mm:ss'));
                        $('#stopTime').html(a.stopTime ? moment(a.stopTime).local().format('YYYY-MM-DD HH:mm:ss') : '');
                        $('#device_info_type').html(a.device.info.type);
                        $('#file_size').html(formatBytes(a.size, 0, 1024));
                        $('#type').html(a.type);

                        // $('#startTime2').html(moment(a.startTime).local().format('YYYY-MM-DD HH:mm:ss'));
                        // $('#stopTime2').html(a.stopTime ? moment(a.stopTime).local().format('YYYY-MM-DD HH:mm:ss') : '');
                        // $('#device_info_type2').html(a.device.type);
                        // $('#file_size2').html(formatBytes(a.size, 0, 1024));
                        // $('#type2').html(a.type);

                        $('#video_title').val(a.title);
                        $('#download').attr('onclick', 'window.location.href=\'' + a.downloadUrl + '\'');
                        $('#screenShot').attr('data-userId', a.user.id);

                        plyr = new Plyr('#plyr', {
                            controls: controls,
                            speed: {selected: object.video.speed, options: [0.5, 1, 2, 4, 8, 16]},
                            volume: 0,
                        });

                        if (foucs.type.toLowerCase() == 'hls') {
                            $('#live_tag').css('display', 'block');
                            object.video.speed = 1;
                            if (Hls.isSupported()) {
                                hls = new Hls();
                                hls.loadSource(foucs.videoUrl);
                                hls.attachMedia(document.querySelector('#plyr'));
                                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                                    plyr.play();
                                });
                            } else if (navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i)) {
                                plyr.source = {
                                    "type": 'video',
                                    "poster": foucs['snapshotUrl'],
                                    "sources": [{"src": foucs['videoUrl'], "type": 'video/mp4'}]
                                };
                            }
                        } else {
                            $('#live_tag').css('display', 'none');
                            $('#plyr').attr({'poster': foucs.snapshotUrl, 'src': foucs.videoUrl});
                        }
                        $('#plyr')[0].playbackRate = object.video.speed;

                        //update gps info
                        gps = {}, gps_text = '';
                        ajax('PUT', '/agent/api', data_format('/api/video/gps?vid=' + a.id, 0, 'GET', {}, null), function (b) {
                            if (!b.error) {
                                $("#gps_list").empty();
                                $('#gps_list').animate({scrollTop: 0});
                                if(b['gpsList']){
                                    for (var i in b['gpsList']) {
                                        var local = moment(b['gpsList'][i]['timestamp']).format('YYYY-MM-DD HH:mm:ss');
                                        gps_text += '<li class="list-group-item" id="gpsItem_' + moment(b['gpsList'][i]['timestamp']).unix() + '">' + local + ':&nbsp;&nbsp;' + b['gpsList'][i]['latitude'] + ',  ' + b['gpsList'][i]['longitude'] + '</li>';
                                        gps[local] = b['gpsList'][i];
                                    }
                                }else
                                    $("#gps_list").empty();
                            }
                            $('#gps_list').html(gps_text);

                            $('#map1').height($('video').height());
                            var gps_height = $("#plyr_container").height() - $('#map1').height()
                            $('#gps_container').height(gps_height);
                            $('#gps_list').width($('#gps_list').parent().width());
                            if (!map1) map1 = map_initial('map1');

                            if (markers['_lastOne'] != null) {
                                map1.removeLayer(markers['map1'][markers['_lastOne']]['point']);
                                for (var i in map1._layers) if (map1._layers[i]._path != undefined) {
                                    try {
                                        map1.removeLayer(map1._layers[i]);
                                    } catch (e) {
                                        console.warn("problem with " + e + map1._layers[i]);
                                    }
                                }
                                markers['_lastOne'] = null;
                            }

                            var video = $('#plyr').get(0), temp = null, last_li = null;

                            if (Object.keys(gps).length == 1) {
                                for (var i in gps) {
                                    handlerMarker(map1, {
                                        'id': a.id,
                                        'gps': gps[i]
                                    }, false, true, null, gps);
                                }
                            } else if (Object.keys(gps).length >= 1) {
                                video.ontimeupdate = function (e) {
                                    var tsmp = moment(a['startTime']).add(Math.floor(video.currentTime), 'second').format('YYYY-MM-DD HH:mm:ss'),
                                        unix = moment(tsmp).unix();

                                    if (temp != tsmp && gps[tsmp]) {
                                        last_li && last_li.removeClass('active');
                                        $('#gpsItem_' + unix).addClass('active');
                                        if( $('#autoScroll').prop('checked')) {
                                            var target = document.getElementById('gpsItem_' + unix);
                                            // target.parentNode.scrollTop = target.offsetTop - target.offsetHeight;
                                            $('#gps_list').animate({scrollTop: target.offsetTop - target.offsetHeight});
                                            // document.getElementById('gpsItem_' + unix).parentNode.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'start' });
                                        }
                                        handlerMarker(map1, {
                                            'id': a.id,
                                            'gps': gps[tsmp]
                                        }, true, true, tsmp, gps);
                                        temp = tsmp;
                                        last_li = $('#gpsItem_' + unix);
                                    }
                                };
                            }
                        });
                    }
                });
            }
        }
    }, Draw_tic = function(option){
        var unit = object.video.type;
        if(option){
            if(moment(find).diff(new Date(), unit) < 0){
                $("*[data-video=Live]").remove();
                $("*[data-url=Live]").remove();
                var id = moment($("#father-timeline div:last-child").data("id")).add(1,unit).format('YYYY-MM-DDTHH:mm:ssZ'), tmp;

                if(unit == 'hours') tmp = moment(id).hours();
                if(unit == 'minutes') tmp = moment(id).minutes();
                var new_class = (tmp % 6 == 0) ? "tic" : "tic sub", live_class = (new_class == "tic") ? "sub tic" : "tic";

                $("#father-timeline").append("<div data-id=\""+ id +"\" data-video=\"default\" data-url=\"default\" class=\""+ new_class +"\"></div>");
                $("#father-timeline").append("<div data-id=\""+ id +"\" data-video=\"Live\" data-url=\"Live\" class=\""+ live_class +"\" ></div>");

                find = id;
                downloadapi(find);
            }
        }else{
            var id = moment($("#father-timeline div:first-child").data("id")).subtract(1,unit).format('YYYY-MM-DDTHH:mm:ssZ'), tmp,
                time = Date.parse(id);

            if(unit == 'hours') tmp = moment(id).hours();
            if(unit == 'minutes') tmp = moment(id).minutes();
            var new_class = (tmp % 6 == 0) ? "tic" : "tic sub", live_class = (new_class == "tic") ? "sub tic" : "tic";

            $("#father-timeline div:first-child").before("<div data-id=\""+ id +"\" data-video=\"default\" data-url='default' class=\""+ new_class +"\"></div>");
        }
    }, searchtime = function(date){
        while(!$("#read").html().includes(date)){
            Draw_tic();
            refreshtimeline();
        }
    }, downloadapi = function(starttime){
        var data = {}, startHour = 0, startMin = 0;

        data['postId']    = $('#select_users').val();
        data['startTime'] = moment(starttime).subtract(3,'hours').format('YYYY-MM-DDTHH:mm:ssZ');
        data['stopTime']  = moment(starttime).format('YYYY-MM-DDTHH:mm:ssZ');

        ajax('PUT', '/agent/api', data_format('/api/video/search', 0, 'POST', data, null), function (a) {
            a.videoList.forEach(function(value, index){
                if(!a.videoList[index].stopTime) object.video.live_id = a.videoList[index].id;
                var tmpHour = Date.parse(moment(a.videoList[index].startTime).format('YYYY-MM-DDTHH:00:00Z'));
                if(tmpHour != startHour){
                    if(!(tmpHour in  object.videolist.hour))  object.videolist.hour[tmpHour] = [];
                    startHour = tmpHour;
                }
                if(!(a.videoList[index].id in object.videolist.hour[startHour])) object.videolist.hour[startHour][a.videoList[index].id] = "";
                object.videolist.hour[startHour][a.videoList[index].id] = a.videoList[index].stopTime;

                var tmpMin = Date.parse(moment(a.videoList[index].startTime).format('YYYY-MM-DDTHH:mm:00Z'));
                if(tmpMin != startMin){
                    if(!(tmpMin in  object.videolist.min))  object.videolist.min[tmpMin] = [];
                    startMin = tmpMin;
                }
                if(!(a.videoList[index].id in object.videolist.min[startMin])) object.videolist.min[startMin][a.videoList[index].id] = "";
                object.videolist.min[startMin][a.videoList[index].id] = a.videoList[index].stopTime;

                var tmpSec = Date.parse(a.videoList[index].startTime);
                if(!(tmpSec in  object.videolist.sec))  object.videolist.sec[tmpSec] = [];
                if(!(a.videoList[index].id in object.videolist.sec[tmpSec])) object.videolist.sec[tmpSec][a.videoList[index].id] = "";
                object.videolist.sec[tmpSec][a.videoList[index].id] = a.videoList[index].stopTime;
            });
            updatevideoline();
        });
        api_record = Date.parse(data['startTime']);
    }, updatevideoline = function(){
        var videolist_ = [];
        if(object.video.type == 'seconds') videolist_ = object.videolist.sec;
        if(object.video.type == 'minutes') videolist_ = object.videolist.min;
        if(object.video.type == 'hours') videolist_ = object.videolist.hour;
        var videos = '', stopTime = 0, tic  = document.getElementsByClassName('tic');
        for(var i = tic.length -1 ; i > 0; i--){
            if(tic[i].dataset.url == "Live"){
                tic[i].dataset.video = object.video.live_id + '_';
                tic[i].style.backgroundColor = 'darkgreen';
            }else{
                var time = Date.parse(tic[i].dataset.id);
                if(time < api_record) {
                    downloadapi(api_record);
                    break;
                }

                tic[i].style.backgroundColor = '#bbb';
                if ((time in videolist_) && (videolist_[time].length)) {
                    videos = '';
                    for(index in videolist_[time]) {
                        if(videolist_[time][index]) {
                            videos += index + '_';
                            stopTime = Date.parse(videolist_[time][index]) - 5000;
                        }
                    }
                    for(var j = i; j < tic.length; j++){
                        var tmp = Date.parse(tic[j].dataset.id);
                        if(tmp <= stopTime){
                            tic[j].dataset.video = videos;
                            tic[j].style.backgroundColor = 'darkgreen';
                        }
                        else
                            break;
                    }
                }
            }
        }
        refreshvideo();
    }, clearVideo = function(){
        object.video.type = 'minutes';
        object.video.speed = 1;
        $('#plyr_container').css('display', 'none');
        $('#load_container').css('display', 'block');
        $('#digitalZoom').val(1);
        $("#father-timeline").remove();
        $('#gps_list').empty();
        $("#plyr")[0].pause();
        hls && (hls.stopLoad(), hls.destroy(), hls = null);
        plyr && (plyr.destroy(), plyr = null);
        $('#player').html('<video preload="none" id="plyr" autoplay controls crossorigin></video>');
        plyr_progress();
    }, plyr_progress = function(){
        $("#plyr").bind('timeupdate', function () {
            $("div[data-video*='"+object.video.id+"']").addClass("cur");
            $(".cur").css("background-color", "yellow");
            var tsmp = moment(foucs.startTime).add(Math.floor($('#plyr')[0].currentTime), 'second').format('YYYY-MM-DD HH:mm:ss');
            $("#read").html(tsmp);

            // var left = ($(".finger").position().left + $(".finger").width()) - $('.tic').width()*2,
            //     m    = getElementByPoint($("#timeline-container"), left, 27);
            // if(m != null){
            //     if(moment(tsmp).format('YYYY-MM-DD HH:mm:00') != moment(m.dataset.id).format('YYYY-MM-DD HH:mm:00')){
            //         var moving = (Date.parse(moment(tsmp).format('YYYY-MM-DD HH:mm:00')) > Date.parse(moment(m.dataset.id).format('YYYY-MM-DD HH:mm:00'))) ? $("#father-timeline").position().left  - 2 : $("#father-timeline").position().left  + 2;
            //         $("#father-timeline").css('left',moving);
            //     }
            // }
            if( $("#stopTime").html() == "" ){

            }
        });
        $("#plyr").on('ratechange', function () {
            object.video.speed = $("#plyr")[0].playbackRate;
        });
        $("#plyr").on('pause', function () {
            clearInterval(intervalRewind);
        });
        $("#plyr").bind('play', function () {
            if(object.video.rewind) $('#rewind').click();
        });
        $('#plyr').on('ended',function(){
            if( $("#stopTime").html() == "" ){
                initalize_timeline(new Date(), false);
                $("#Go_Live").click();
            }else{
                if(object.video.index < (object.video.list.length - 2)){
                    object.video.index += 1;
                    getVideo(object.video.list[object.video.index]);
                }else{
                    var move = setInterval((function(){
                        Draw_tic('NEW');
                        $('#plyr')[0].pause();
                        var left = ($(".finger").position().left + $(".finger").width()) - $('.tic').width()*2;
                        var m = getElementByPoint($("#timeline-container"), left, 27);
                        var moving = $("#father-timeline").position().left  - 1 ;
                        $("#father-timeline").css('left',moving);
                        refreshtimeline();
                        if(m!= null){
                            object.video.time = m.dataset.id;
                            if(m.dataset.video != 'default' && !(m.dataset.video.includes(object.video.id))){
                                clearInterval(move);
                                refreshvideo();
                            }
                            if(m.dataset.url == 'Live'){
                                $("#Go_Live").click();
                                clearInterval(move);
                            }
                        }
                    }),100);
                }
            }
        });
    };

    date_range_init(start, end);
    time_search_initalize();

    //todo: remove DataTable
    var initialed = false, init = data_format('/api/video/search', 0, 'POST', {
        'startTime': "2020-12-31T18:32:01+08:00",
        'stopTime': "2021-12-31T18:35:01+08:00"
    }, 'video');

    var table = $('#videos').DataTable({
        "processing": true,
        "serverSide": true,
        "autoWidth": true,
        "dom": 'lBprtip',
        "lengthMenu": [10, 25, 50, 100],
        "language": {"url": 'files/' + lang + '.json'},
        "iDisplayLength": 25,
        "buttons": [{}],
        "columnDefs": [{"targets": [0]},],
        "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
            $('img', nRow).lazyLoadXT();
        }, 'fnInitComplete': function (oSettings, json) {
            $('.dt-buttons').find('button').each(function () {
                $(this).removeClass('btn-secondary').attr('data-loading-text', '<span class=\'spinner-grow spinner-grow-sm\'></span>');
            });
            loading(false);
        }, "ajax": $.fn.dataTable.pipeline(init, function (a) {
            $('#videos_wrapper').css('display', 'none');
            if (!a.error) {
                playbackList = a.origin;
            }
        })
    });

    ajax('PUT', '/agent/api', data_format('/api/user/tree', 0, 'GET', {}, null), function (a) {
        if (a.error) $.growl.error({message: a.error}); else {

            object.user = recursive(a, false, 'user');
            object.group = recursive(a, true, 'group');

            $('#user_tree').jstree({
                "plugins": ["wholerow", "changed", "search", "grid", 'ui'],
                "search": {"show_only_matches": false, "show_only_matches_children": false},
                'core': {
                    'data': object.user,
                    'themes': {
                        'name': 'proton',
                        'responsive': true,
                        'variant': 'large'
                    }, "dnd": {
                        'copy_modifier': false,
                        'check_while_dragging': true
                    }, 'check_callback': true
                },
                "grid": {
                    columns: [
                        {'header': '&nbsp;', 'value': 'id', 'width': '50%'},
                        {'header': langDict.name, 'value': 'name', 'width': '30%'},
                        {'header': langDict.title, 'value': 'title', 'width': '30%'}
                    ],
                    resizable: true,
                    width: '100%',
                }
            }).bind("loaded.jstree changed.jstree", function (event, data) {
                try {
                    $(this).jstree('open_node', 'user_group_' + $('[name="_group"]').attr('content').split('_')[1]);
                } catch (e) {
                    //$(this).jstree('open_all');
                }
            }).on('select_node.jstree', function (event, data) {
                var target = data.node.original, payload = {}, condition = false;

                if(data.node.children.length < 1) {
                    if(target.more.id != $('#select_users').val()) condition = true;
                    $('#select_users').empty().append('<option value="' + target.more.id + '">' + target.text + '</option>').selectpicker('refresh');
                    $('#select_users').val(target.more.id).selectpicker('refresh');
                    $('#user_modal').modal('hide');
                }

                if (condition) {
                    clearVideo();
                    // $('#condition_npa').prop('checked') && $('#select_npa').val().length && (payload['npa'] = [$('#select_npa').val()], condition = true);
                    payload['postID'] = $('#select_users').val();
                    payload['index'] = 0;
                    payload['count'] = 1;

                    ajax('PUT', '/agent/api', data_format('/api/video/search', 0, 'POST', payload, null), function (a) {
                        if(!a.error){
                            if(a.total > 0){
                                $('#load_container').css('display', 'none');
                                $('#plyr_container').css('display', 'block');
                                foucs = a.videoList[0];
                                object.video.speed = 1;
                                object.videolist.hour = [], object.videolist.min = [], object.videolist.sec = [];
                                // initalize_timeline(new Date(),false);
                                // setTimeout(function () { $("#Go_Live").click(); },1000);
                                setTimeout(function () { initalize_timeline(new Date(), false); },1000);

                                getVideo(foucs.id);
                            }else{
                                $.growl.notice({message: langDict['selectedDevice'] + langDict['noPlayback']});
                            }
                        }
                    });
                }
            });

            $('#group_tree').jstree({
                "core": {
                    "check_callback": true,
                    'themes': {'name': 'proton', "variant": "large"},
                    "data": object.group
                }, "plugins": ["wholerow", "changed", "search"],
                "search": {"show_only_matches": false, "show_only_matches_children": false}
            }).bind("loaded.jstree changed.jstree", function (event, data) {
                try {
                    $(this).jstree('open_node', 'group_group_' + $('[name="_group"]').attr('content').split('_')[1]);
                } catch (e) {
                    //$(this).jstree('open_all');
                }
            }).on('select_node.jstree', function (event, data) {
                var target = data.node.original;
                $('#select_group').empty().append('<option value="' + target.more.id + '">' + target.text + '</option>').selectpicker('refresh');
                $('#group_modal').modal('hide');
            });

            $('#searchBtn').button('reset');
        }
    });

    // $(document).on('click', '#videos .play-icon', function (e) {
    //     switch (e.type) {
    //         case 'click':
    //             var id = $(this).attr('data-id');
    //
    //             $('#video_info').empty();
    //             $('#video_info2').empty();
    //             $("#gps_list").empty();
    //             foucs = {};
    //             $('#video_title').val('');
    //
    //             for (var i in playbackList) {
    //                 if (playbackList[i]['id'] == id) {
    //
    //                     foucs = playbackList[i];
    //
    //                     $('#player_modal').find('.modal-title').text(foucs.user.id);
    //                     $('#video_title').val(foucs.title);
    //                     $('#video_content').html(foucs.content);
    //                     var info = '<tr><th>' + langDict.startTime + '</th><td id="startTime">' + moment(foucs.startTime).local().format('YYYY-MM-DD HH:mm:ss') + '</td></tr>';
    //                     info += '<tr><th>' + langDict.endTime + '</th><td id="stopTime">' + (foucs.stopTime ? moment(foucs.stopTime).local().format('YYYY-MM-DD HH:mm:ss') : '') + '</td></tr>';
    //                     info += '<tr><th>' + langDict.deviceModel + '</th><td id="device_info_type">' + foucs.device.info.type + '</td></tr>';
    //                     info += '<tr><th>' + langDict.fileSize + '</th><td id="file_size">' + formatBytes(foucs.size, 0, 1024) + '</td></tr>';
    //                     info += '<tr><th>' + langDict.fileType + '</th><td id="type">' + foucs.type + '</td></tr>';
    //                     $('#video_info').append(info);
    //
    //                     var info = '<tr><th>' + langDict.startTime + '</th></tr><tr><td id="startTime2">' + moment(foucs.startTime).local().format('YYYY-MM-DD HH:mm:ss') + '</td></tr>';
    //                     info += '<tr><th>' + langDict.endTime + '</th></tr><tr><td id="stopTime2">' + (foucs.stopTime ? moment(foucs.stopTime).local().format('YYYY-MM-DD HH:mm:ss') : '') + '</td></tr>';
    //                     info += '<tr><th>' + langDict.deviceModel + '</th></tr><tr><td id="device_info_type2">' + foucs.device.info.type + '</td></tr>';
    //                     info += '<tr><th>' + langDict.fileSize + '</th></tr><tr><td id="file_size2">' + formatBytes(foucs.size, 0, 1024) + '</td></tr>';
    //                     info += '<tr><th>' + langDict.fileType + '</th></tr><tr><td id="type2">' + foucs.type + '</td></tr>';
    //                     $('#video_info2').append(info);
    //                     $('#download').attr('onclick', 'window.location.href=\'' + foucs.downloadUrl + '\'');
    //                     $('#screenShot').attr('data-userId', foucs.user.id);
    //                     break;
    //                 }
    //             }
    //
    //             $('#player_modal').modal({
    //                 backdrop: 'static',
    //                 keyboard: true,
    //                 show: true
    //             });
    //             break;
    //     }
    // });
    $(document).on('click', '#video_btn', function (e) {
        var btn = $(this), obj = {'id': foucs.id};
        if ($('#video_title').val() != foucs.title) {
            obj.title = $('#video_title').val();
            btn.button('loading');
            ajax('PUT', '/agent/api', data_format('/api/video', 0, 'PUT', obj, null), function (a) {
                if (a.error) $.growl.error({message: a.error}); else {
                    $.growl.notice({message: langDict.wasModified});
                    foucs.title = obj.title;
                    $('.video-title[data-id=' + obj.id + ']').val(obj.title);
                }
                btn.button('reset');
            });
        } else
            $.growl.warning({message: langDict.notChanged});
    });
    $(document).on('click', '#table_btn', function (e) {
        var btn = $(this), title = btn.closest('.input-group').find('input'), vid = title.attr('id').split('_')[1],
            temp;
        for (var i in playbackList) if (playbackList[i]['id'] == vid) {
            temp = i;
            break;
        }
        if (title.val() != playbackList[temp]['title']) {
            btn.button('loading');
            ajax('PUT', '/agent/api', data_format('/api/video', 0, 'PUT', {
                'id': vid,
                'title': title.val()
            }, null), function (a) {
                a.error ? $.growl.error({message: a.error}) : ($.growl.notice({message: langDict['wasModified']}), playbackList[temp]['title'] = title.val());
                btn.button('reset');
            });
        }
    });

    // $('#player_modal').on('show.bs.modal shown.bs.modal hidden.bs.modal', function (e) {
    //
    //     switch (e.type) {
    //         case 'show' :
    //             object.video.speed = 1;
    //             object.videolist.hour = [], object.videolist.min = [], object.videolist.sec = [];
    //             var q = setInterval(function(){ Draw_tic('NEW'); },50000);
    //             var r = setInterval(function(){ downloadapi(moment(find)); },600000);
    //
    //             plyr = new Plyr('#plyr', {
    //                 controls: controls,
    //                 speed: {selected: object.video.speed, options: [0.5, 1, 2, 4, 8, 16]},
    //                 volume: 0,
    //             });
    //
    //             if (foucs.type.toLowerCase() == 'hls') {
    //
    //                 if (Hls.isSupported()) {
    //                     hls = new Hls();
    //                     hls.loadSource(foucs.videoUrl);
    //                     hls.attachMedia(document.querySelector('#plyr'));
    //                     hls.on(Hls.Events.MANIFEST_PARSED, function () {
    //                         plyr.play();
    //                     });
    //                 } else if (navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i)) {
    //                     plyr.source = {
    //                         "type": 'video',
    //                         "poster": foucs['snapshotUrl'],
    //                         "sources": [{"src": foucs['videoUrl'], "type": 'video/mp4'}]
    //                     };
    //                 }
    //             } else {
    //                 $('#plyr').attr({'poster': foucs.snapshotUrl, 'src': foucs.videoUrl});
    //             }
    //             object.video.id = foucs.id;
    //
    //
    //             break;
    //
    //         case 'shown':
    //             //initalize timeline
    //             initalize_timeline(find,false);
    //             setTimeout(function () { $("#Go_Live").click(); },1000);
    //
    //             //player progress
    //             $("#plyr").bind('timeupdate', function () {
    //                 $("div[data-video*='"+object.video.id+"']").addClass("cur");
    //                 $(".cur").css("background-color", "yellow");
    //                 var tsmp = moment(foucs.startTime).add(Math.floor($('#plyr')[0].currentTime), 'second').format('YYYY-MM-DD HH:mm:ss');
    //                 $("#read").html(tsmp);
    //
    //                 // var left = ($(".finger").position().left + $(".finger").width()) - $('.tic').width()*2,
    //                 //     m    = getElementByPoint($("#timeline-container"), left, 27);
    //                 // if(m != null){
    //                 //     if(moment(tsmp).format('YYYY-MM-DD HH:mm:00') != moment(m.dataset.id).format('YYYY-MM-DD HH:mm:00')){
    //                 //         var moving = (Date.parse(moment(tsmp).format('YYYY-MM-DD HH:mm:00')) > Date.parse(moment(m.dataset.id).format('YYYY-MM-DD HH:mm:00'))) ? $("#father-timeline").position().left  - 2 : $("#father-timeline").position().left  + 2;
    //                 //         $("#father-timeline").css('left',moving);
    //                 //     }
    //                 // }
    //             });
    //             $("#plyr").on('ratechange', function () {
    //                object.video.speed = $("#plyr")[0].playbackRate;
    //             });
    //             $('#plyr').on('ended',function(){
    //                 if( $("#stopTime").html() == "" ){
    //                     $("#Go_Live").click();
    //                 }else{
    //                     if(object.video.index < (object.video.list.length - 2)){
    //                         object.video.index += 1;
    //                         getVideo(object.video.list[object.video.index]);
    //                     }else{
    //                         var move = setInterval((function(){
    //                             $('#plyr')[0].pause();
    //                             var left = ($(".finger").position().left + $(".finger").width()) - $('.tic').width()*2;
    //                             var m = getElementByPoint($("#timeline-container"), left, 27);
    //                             var moving = $("#father-timeline").position().left  - 2 ;
    //                             $("#father-timeline").css('left',moving);
    //                             refreshtimeline();
    //                             if(m!= null){
    //                                 if(m.dataset.id == moment(object.video.time).add(1, object.video.type).format('YYYY-MM-DDTHH:mm:ssZ')) {
    //                                     object.video.time = m.dataset.id;
    //                                     if(m.dataset.video != 'default' && !(m.dataset.video.includes(object.video.id))){
    //                                         clearInterval(move);
    //                                         refreshvideo();
    //                                     }
    //                                 }
    //                                 if(m.dataset.video == 'Live'){ clearInterval(move); $("#Go_Live").click();}
    //                             }
    //                         }),100);
    //                     }
    //                 }
    //             });
    //             break;
    //
    //         case 'hidden':
    //             $("#father-timeline").remove();
    //             $("#plyr")[0].pause();
    //             clearInterval(q);
    //             clearInterval(r);
    //             hls && (hls.stopLoad(), hls.destroy(), hls = null);
    //             plyr && (plyr.destroy(), plyr = null);
    //             $('#player').html('<video preload="none" id="plyr" autoplay controls crossorigin></video>');
    //             break;
    //     }
    // });
    $(document).on('click mouseenter mouseleave', '[id^=gpsItem_]*', function (e) {
        if ($(this).attr('id').split('_').length == 2) switch (e.type) {
            case 'click':
                var tsmp = $(this).attr('id').split('_')[1], instance = $('#plyr').get(0);
                instance.currentTime = (tsmp - Date.parse(foucs['startTime'])/1000);
                break;
            case 'mouseenter':
                $(this).css('cursor', 'pointer');
                $(this).css('border', "solid 2px #666");
                break;
            case 'mouseleave':
                $(this).css('border', "");
                break;
        }
    });
    // $('[id^=condition_]*').on('click', function () {
    //     var checked = $(this).prop('checked'), target = $(this).attr('id').split('_')[1];
    //     (checked) ? $('#' + target + '_row').show() : $('#' + target + '_row').hide();
    //     $('#searchBtn').prop('disabled', !($('#condition_group').prop('checked') || $('#condition_users').prop('checked') || $('#condition_time').prop('checked') || $('#condition_npa').prop('checked')));
    // });
    $('[id$=_search_btn]').on('click', function (e) {
        var btn = $(this), tree = $('#' + btn.attr('id').split('_')[0] + '_tree'),
            val = btn.closest('.input-group').find('input').val();
        val && (btn.button('loading'), setTimeout(function () {
            try {
                tree.jstree(true).search(val);
                tree.find('.jstree-search:eq(0)')[0].scrollIntoView();
            } catch (e) {
                $.growl.warning({message: langDict.notFound});
            }
            btn.button('reset');
        }, 300));
    });

    // $('#select_group').on('show.bs.select', function (e, clickedIndex, isSelected, previousValue) {
    //     $('#group_search').val('');
    //     $('#group_tree').jstree(true).search('');
    //     $('#group_modal').modal({
    //         backdrop: 'static',
    //         keyboard: true,
    //         show: true
    //     });
    // });
    $('#select_users').on('show.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        $('#user_search').val('');
        $('#user_tree').jstree(true).search('');
        $('#user_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.video-keep', function (e) {
        ajax('PUT', '/agent/api', data_format("/api/video/update", 0, "POST", {
            "id": [$(this).attr('data-id')],
            "keep": $(this).prop('checked') ? 1 : 0
        }, null), function (a) {
            if (a.error) {
                $.growl.error({message: a.error});
            } else {
                $.growl.notice({message: langDict.wasModified});
            }
        });
    });
    $('#users_apply').on('click', function () {
        var tree = $('#user_tree'), selected = tree.jstree('get_selected'), selection = $('#select_users');
        selection.empty();
        for (var i in selected) {
            var node = tree.jstree().get_node(selected[i]).original;
            (node.icon != icons.users) && selection.append('<option selected>' + node.more.id + '</option>');
        }
        selection.selectpicker('refresh');
    });
    // $('#searchBtn').on('click', function () {
    //     var btn = $(this), data = {}, condition = false;
    //     $('#condition_group').prop('checked') && $('#select_group').val().length && (data['group'] = [$('#select_group').val()], condition = true);
    //     $('#condition_users').prop('checked') && $('#select_users').val().length && (data['postID'] = $('#select_users').val(), condition = true);
    //     $('#condition_npa').prop('checked') && $('#select_npa').val().length && (data['npa'] = [$('#select_npa').val()], condition = true);
    //     if ($('#condition_time').prop('checked')) {
    //         data['startTime'] = $('#search_time').data('daterangepicker').startDate.format('YYYY-MM-DDTHH:mm:ssZ');
    //         data['stopTime'] = $('#search_time').data('daterangepicker').endDate.format('YYYY-MM-DDTHH:mm:ssZ');
    //         condition = true;
    //     }
    //     if (condition) {
    //         btn.button('loading');
    //         initialed = false;
    //         var conditions = data_format('/api/video/search', 0, 'POST', data, null);
    //         video_search(table, conditions, function (a) {
    //             if (!a.error) {
    //                 playbackList = a.origin;
    //                 initialed || ($.growl.notice({message: langDict['result'] + ': ' + a.total + ' ' + langDict['videos']}), initialed = true);
    //             }
    //             btn.button('reset');
    //         });
    //     }
    //
    // });

    $(window).resize(function() {
        refreshtimeline();
    });

    //play modal control btn
    $('#screenShot').on('click', function (){

        var video = $('#plyr').get(0);
        var canvas = document.createElement('canvas');
        canvas.width = 960;
        canvas.height = 540;

        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        var dataURI = canvas.toDataURL('image/png'),
            downloadURI = dataURI.replace('image/png', 'image/octet-stream');
        var filename = $(this).data("userid") + "_" + $("#read").html() + ".png";


        var download = document.createElement('a');
            download.setAttribute('href', downloadURI);
            download.setAttribute('download', filename);

            download.style.display = 'none';
            document.body.appendChild(download);
            download.click();
            document.body.removeChild(download);
    });
    // $('#map_show').on('click', function (){
    //     $('.map_hide').css('display','none');
    //     $('.map_show').css('display','inline');
    //     $('#left_content').removeClass("col-lg-9");
    //     $('#left_content').addClass("col-lg-6");
    //     $('#right_content').removeClass("col-lg-3");
    //     $('#right_content').addClass("col-lg-6");
    //     initalize_timeline(find,false);
    //     refreshvideo();
    //     $('#map1').height($('video').height());
    //     $('#gps_container').height($('#map1').height());
    //
    // });
    // $('#map_hide').on('click', function (){
    //     $('.map_hide').css('display','inline');
    //     $('.map_show').css('display','none');
    //     $('#left_content').removeClass("col-lg-6");
    //     $('#left_content').addClass("col-lg-9");
    //     $('#right_content').removeClass("col-lg-6");
    //     $('#right_content').addClass("col-lg-3");
    //     initalize_timeline(find,false);
    //     refreshvideo();
    // });
    $('#Go_Live').on('click', function (){
        object.video.speed = 1;
        $('#plyr')[0].pause();
        ajax('PUT', '/agent/api', data_format('/api/video/search', 0, 'POST', {'postID': $('#select_users').val(), 'index': 0, 'count':1}, null), function (a) {
            if(!a.error){
                if(a.total > 0){
                    $(".cur").css('background-color','rgb(0, 102, 102)');
                    $("div").removeClass("cur");

                    if (a.videoList[0].type.toLowerCase() == 'hls') {
                        foucs = a.videoList[0];
                        object.video.live_id = foucs.id;
                        getVideo(object.video.live_id);
                        $("div[data-url='Live']").attr('data-video',object.video.live_id);
                    } else
                        $.growl.notice({message: langDict['deviceOffline']});
                }else{
                    $.growl.notice({message: langDict['selectedDevice'] + langDict['noPlayback']});
                }
            }
        });
        // getVideo(object.video.live_id);
        // initalize_timeline(new Date(),false);
        //
        // setTimeout(function(){
        //     getVideo(object.video.live_id);
        // },500);
    });
    $(".datepicker").on('change',function () {

        if($("#month").val() == "2") {
            $("#day option[value='31']").css('display', 'none');
            $("#day option[value='30']").css('display', 'none');
            var tmp = $("#year").val();
            if((tmp % 100 != 0 || tmp % 400 == 0) && tmp % 4 != 0) $("#day option[value='29']").css('display', 'none');
            else $("#day option[value='29']").css('display', 'block');
        }
        else {
            $("#day option[value='30']").css('display', 'block');
            if($("#month").val() == "1" || $("#month").val() == "3" || $("#month").val() == "5" || $("#month").val() == "7" || $("#month").val() == "8" || $("#month").val() == "10" || $("#month").val() == "12")
                $("#day option[value='31']").css('display', 'block');
            else
                $("#day option[value='31']").css('display', 'none');
        }
        $('#day').selectpicker('refresh');
    });
    $("#timeSearch").on('click',function () {
        var str = $('#datetimepicker1').val() + ":00";
        var search = moment(str).format('YYYY-MM-DD HH:mm:ss'), today = moment(new Date()).format('YYYY-MM-DD HH:mm:ss');
        if(moment(search).diff(today) < 0)
            find = str;
        else{
            $.growl.error({message: langDict.future});
            find = new Date();
        }
        initalize_timeline(find,true);
    });
    $("#unit").on('change',function () {
        var type = $(this).val();
        object.video.type = type;
        $("#min").empty();
        if(type == 'hours')
            $("#min").append('<option value="0">00</option>');
        else{
            for(var i = 0; i < 60; i++){
                (i < 10) ? $("#min").append('<option value="'+i+'">0'+i+'</option>') : $("#min").append('<option value="'+i+'">'+i+'</option>');
            }
        }
        $("#min").selectpicker('refresh');
        setTimeout(function () {
            initalize_timeline(new Date(), true);
        }, 700);
    });
    $('#digitalZoom').on('change', function () {
        $('#zoom').html($(this).val());
        $('#plyr').css('transform', 'scale('+ $(this).val() +')');
        $('#plyr').css('position', 'absolute');
    });
    $("#resetZoom").on('click',function () {
        $('#zoom').html(1);
        $('#digitalZoom').val(1);
        $('#plyr').css('transform', 'scale(1)');
        $('#plyr').css('left', '0');
        $('#plyr').css('top', '0');
    });
    $("#rewind").on('click',function () {
        object.video.rewind = true;
        $('#forward').css('display', 'block');
        $('#rewind').css('display', 'none');
        var plyr_ = $("#plyr")[0];
        intervalRewind = setInterval(function(){
            plyr_.playbackRate = 1.0;
            if(plyr_.currentTime == 0){
                clearInterval(intervalRewind);
                plyr_.pause();
            }
            else{
                plyr_.currentTime += -.1;
            }
        },100);
    });
    $("#forward").on('click',function () {
        object.video.rewind = false;
        $('#rewind').css('display', 'block');
        $('#forward').css('display', 'none');
        clearInterval(intervalRewind);
    });

    $('#position').on('click', function () {
        $('.position').each(function () {
            $(this).toggle("slide", {direction: $(this).data('direction')});
        });
    });

    $('.position').on('click', function () {
        var plyr_direction = $(this).data('direction'),
            left = parseInt($('#plyr').css('left')),
            top = parseInt($('#plyr').css('top')),
            step = 5 * $('#digitalZoom').val();

        switch (plyr_direction) {
            case 'left':
                $('#plyr').css('left', (left - step)+'px' );
                break;
            case 'right':
                $('#plyr').css('left', (left + step)+'px' );
                break;
            case 'down':
                $('#plyr').css('top', (top + step)+'px' );
                break;
            case 'up':
                $('#plyr').css('top', (top - step)+'px' );
                break;
        }
    });
});