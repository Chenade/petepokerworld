$(document).ready(function(){

    $('[data-admin=news]').addClass('active');

    var table = $('#newsTable').DataTable({
        ajax: '/api/news/adminlist',
        columns: [
            { data: 'id' },
            { data: 'title' },
            { data: 'start_at' },
            { data: 'end_at' },
            { data: 'ord' },
            { data: 'operate' },
        ],
        "drawCallback": function (settings) {
            $( ".date-convert" ).each(function( index ) {
                var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD hh:mm:ss");
                $( this ).text(_tmp);
              });
        },
    });

    let start_at = $("#datetimepicker_start").flatpickr({
        altInput: true,
        dateFormat: "Y-m-   d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    let end_at = $("#datetimepicker_end").flatpickr({
        altInput: true,
        dateFormat: "Y-m-   d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });
    
    $('#newsTable_filter').addClass('row');
    var addBtn = '<button type="button" class="btn btn-primary" id="addBtn">新增</button>';
    var search = $('#newsTable_filter').html();
    $('#newsTable_filter').html(search+addBtn);

    $(document).on('click', '#addBtn', function () {
        $('.save-btn').data("action", "add");
        $('.save-btn').data("id", "");
        $('#md-method').text("新增");
        $("[data-action='delete']").hide();
        $('#news_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.edit-btn', function () {
        var id = $(this).data('id');

        ajax('GET', '/api/news/'+id, {}, function (a) {
            if(a.success){
                $('#edit_title').val(a.data.title);
                $('#edit_content').val(a.data.content.substr(1,a.data.content.length -2));
                $('#edit_link').val(a.data.link);
                $('#edit_link_alt').val(a.data.link_alt);
                $('#edit_ord').val(a.data.ord);
                start_at.setDate(moment.unix(a.data.start_at).format("YYYY/MM/DD hh:mm:ss"));
                end_at.setDate(moment.unix(a.data.end_at).format("YYYY/MM/DD hh:mm:ss"));
                $('#md-method').text("編輯");
                $('.save-btn').data("action", "edit");
                $('.save-btn').data("id", a.data.id);
                $(".delete-btn[data-action='delete']").show();
                $(".delete-btn[data-action='delete']").data('id', a.data.id);

                $('#news_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }else
                $.growl.error({message: a.message})
        });
    });

    $(document).on('click', '.save-btn', function () {
        var data = {
            'title': $('#edit_title').val(),
            'content': $('#edit_content').val(),
            'link': $('#edit_link').val(),
            'link_alt': $('#edit_link_alt').val(),
            'start_at': moment($('#datetimepicker_start').val()).unix(),
            'end_at': moment($('#datetimepicker_end').val()).unix(),
            'ord': $('#edit_ord').val(),
            'token': getCookie('Authorization')
        };
        var url = '/api/news/create', _method = 'POST';
        var action = $(this).data('action');
        if(action == 'edit')
        {
            data['id'] = $(this).data('id');
            url = '/api/news/'+$(this).data('id'), _method = 'PUT';
        }
        ajax(_method, url, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.delete-btn', function () {
        var id = $(this).data('id'), token = getCookie('Authorization');
        $('#news_modal').modal('hide');
        bootbox.confirm({
            size:"small",
            title:"刪除最新消息",
            message:"是否確定刪除最新消息 #"+ id,
            centerVertical:true,
            buttons: {
                confirm: {label: 'Yes',className: 'btn-danger'},
                cancel: {label: 'No',className: 'btn-secondary'}
            },
            callback:function(result){
                if(result){
                    ajax('DELETE', '/api/news/'+id+'/'+token, {}, function (a) {
                        console.log(a);
                        if(a.success){
                            document.cookie = "Authorization="+a.token;
                            window.location.reload();
                        }else
                            $.growl.error({message: a.message})
                    });
                }else{
                    $('#news_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }
            }
        });
        
    });
});
