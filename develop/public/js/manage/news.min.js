$(document).ready(function(){

    var tid = "news";

    var uploadImage = function(id){
        var imgclean = $('#file');

        data = new FormData();
        data.append('image', $('#file')[0].files[0]);
        data.append('token', getCookie('Authorization'));

        var imgname  =  $('#file').val();
        var size  =  $('#file')[0].files[0].size;

        var ext =  imgname.substr( (imgname.lastIndexOf('.') +1) );
        console.log(imgname, ext);
        if(ext=='jpg' || ext=='jpeg' || ext=='png' || ext=='gif' || ext=='PNG' || ext=='JPG' || ext=='JPEG')
        {
            if(size<=1000000)
            {
                $.growl.warning({message: '圖片上傳中'});
                $.ajax({
                    url: "/api/image/" + tid + "/" + id + "/store",
                    type: "POST",
                    data: data,
                    enctype: 'multipart/form-data',
                    processData: false,  // tell jQuery not to process the data
                    contentType: false   // tell jQuery not to set contentType
                }).done(function(a) {
                    if(a.success){
                        document.cookie = "Authorization="+a.token;
                        displayImage(id);
                        $.growl.notice({message: '圖片上傳成功'})
                        imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                    }else
                        $.growl.error({message: a.message})
                });
                return false;
            }
            else
            {
                imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                alert('Sorry File size exceeding from 1 Mb');
            }
        }
        else
        {
            imgclean.replaceWith( imgclean = imgclean.clone( true ) );
            alert('Sorry Only you can uplaod JPEG|JPG|PNG|GIF file type ');
        }
    }, uploadThumbnail = function(id){
        var imgclean = $('#file-t');

        data = new FormData();
        data.append('image', $('#file-t')[0].files[0]);
        data.append('token', getCookie('Authorization'));

        var imgname  =  $('#file-t').val();
        var size  =  $('#file-t')[0].files[0].size;

        var ext =  imgname.substr( (imgname.lastIndexOf('.') +1) );
        if(ext=='jpg' || ext=='jpeg' || ext=='png' || ext=='gif' || ext=='PNG' || ext=='JPG' || ext=='JPEG')
        {
            if(size<=1000000)
            {
                $.growl.warning({message: '圖片上傳中'});
                $.ajax({
                    url: "/api/" + tid + "/" + id + "/uploadThumbnail",
                    type: "POST",
                    data: data,
                    enctype: 'multipart/form-data',
                    processData: false,  // tell jQuery not to process the data
                    contentType: false   // tell jQuery not to set contentType
                }).done(function(a) {
                    if(a.success){
                        document.cookie = "Authorization="+a.token;
                        // displayThumbnail(id);
                        $.growl.notice({message: '圖片上傳成功'});
                        getinfo(id);
                        imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                    }else
                        $.growl.error({message: a.message})
                });
                return false;
            }
            else
            {
                imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                alert('Sorry File size exceeding from 1 Mb');
            }
        }
        else
        {
            imgclean.replaceWith( imgclean = imgclean.clone( true ) );
            alert('Sorry Only you can uplaod JPEG|JPG|PNG|GIF file type ');
        }
    }, displayImage = function(id){
        ajax('GET', '/api/image/' + tid + '/' + id + '/get', {}, function (a) {
            if(a.success){
                $('#display-img').empty();
                a.data.forEach(el => {
                    var box = '<div class="col-10 col-lg-4 d-flex flex-column align-items-center" style="margin: 10px; padding: 10px; border-radius: 10px; background-color: #e5e5e5;">';
                    box += '<div class="d-flex justify-content-center align-items-center" style="height: 180px;">';
                    box += '    <img src="/upload/Image/' + el.uuid_name + '" style="max-height: 95%;max-width: 95%">';
                    box += '</div>';
                    box += '<button type="button" class="btn btn-danger delete-image" data-id="' + el.id +'" data-pid="'+ id +'" style="margin: 0"><i class="far fa-solid fa-trash-can"></i></button>';
                    box += '</div>';
                    $('#display-img').append(box);
                });
            }else
                $.growl.error({message: a.message})
        });
    }, getinfo = function(id){
        ajax('GET', '/api/' + tid + '/'+id, {}, function (a) {
            if(a.success){
                $('#edit_category').val(a.data.category).selectpicker('refresh');
                $('#edit_title').val(a.data.title);
                $('#edit_content').val(a.data.content.substr(1,a.data.content.length -2).replaceAll('<br>', '\n'));
                $('#edit_link').val(a.data.link);
                $('#edit_link_alt').val(a.data.link_alt);
                $('#edit_ord').val(a.data.ord);
                start_at.setDate(moment.unix(a.data.start_at).format("YYYY/MM/DD hh:mm:ss"));
                end_at.setDate(moment.unix(a.data.end_at).format("YYYY/MM/DD hh:mm:ss"));
                $('#md-method').text("編輯");
                $('.save-btn').data("action", "edit");
                $('.save-btn').data("id", a.data.id);
                $(".delete-btn[data-action='delete']").show();
                $(".delete-btn[data-action='delete']").data('id', a.data.id);

                $('#file').data('id', a.data.id);
                $('#file-t').data('id', a.data.id);
                displayImage(a.data.id);
                $('.image-box').show();

                $('#display-img').empty();
                var box = '<img src="/upload/Image/' + a.data.image + '" style="max-height: 95%;max-width: 95%">';
                $('#display-thumb').html(box);

                $('#' + tid + '_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
            }else
                $.growl.error({message: a.message})
        });
    };

    $('[data-admin=' + tid + ']').addClass('active');

    let start_at = $("#datetimepicker_start").flatpickr({
        altInput: true,
        dateFormat: "Y-m-   d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    let end_at = $("#datetimepicker_end").flatpickr({
        altInput: true,
        dateFormat: "Y-m-   d",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date(),
    });

    var table = $('#' + tid + 'Table').DataTable({
        ajax: '/api/' + tid + '/adminlist',
        columns: [
            { data: 'id' },
            { data: 'title' },
            { data: 'start_at' },
            { data: 'end_at' },
            { data: 'ord' },
            { data: 'operate' },
        ],
        "drawCallback": function (settings) {
            $( ".date-convert" ).each(function( index ) {
                var _tmp = moment.unix($(this).text()).format("YYYY/MM/DD hh:mm:ss");
                $( this ).text(_tmp);
              });
        },
    });
    
    $('#' + tid + 'Table_filter').addClass('row');
    var addBtn = '<button type="button" class="btn btn-primary" id="addBtn">新增</button>';
    var search = $('#' + tid + 'Table_filter').html();
    $('#' + tid + 'Table_filter').html(search+addBtn);

    $(document).on('click', '#addBtn', function () {
        $('#edit_category').val(1).selectpicker('refresh');
        $('#edit_title').val("");
        $('#edit_content').val("");
        $('#edit_link').val("");
        $('#edit_link_alt').val("");
        $('#edit_ord').val("");
        start_at.setDate(moment.unix((new Date() / 1000)).format("YYYY/MM/DD hh:mm:ss"));
        end_at.setDate(moment.unix((new Date() / 1000)).format("YYYY/MM/DD hh:mm:ss"));
        $('.save-btn').data("action", "add");
        $('.save-btn').data("id", "");
        $('#md-method').text("新增");
        $("[data-action='delete']").hide();
        $('.image-box').hide();
        $('#' + tid + '_modal').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    });

    $(document).on('click', '.edit-btn', function () {
        var id = $(this).data('id');
        getinfo(id);
    });

    $(document).on('click', '.save-btn', function () {
        var data = {
            'category': $('#edit_category').val(),
            'title': $('#edit_title').val(),
            'content': $('#edit_content').val().replaceAll('\n', '<br>'),
            'link': $('#edit_link').val(),
            'link_alt': $('#edit_link_alt').val(),
            'start_at': moment($('#datetimepicker_start').val()).unix(),
            'end_at': moment($('#datetimepicker_end').val()).unix(),
            'ord': $('#edit_ord').val(),
            'token': getCookie('Authorization')
        };
        var url = '/api/' + tid + '/create', _method = 'POST';
        var action = $(this).data('action');
        if(action == 'edit')
        {
            data['id'] = $(this).data('id');
            url = '/api/' + tid + '/'+$(this).data('id'), _method = 'PUT';
        }
        ajax(_method, url, data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                table.ajax.reload();
                getinfo(a.message);
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.delete-btn', function () {
        var id = $(this).data('id'), token = getCookie('Authorization');
        $('#' + tid + '_modal').modal('hide');
        bootbox.confirm({
            size:"small",
            title:"刪除最新消息",
            message:"是否確定刪除最新消息 #"+ id,
            centerVertical:true,
            buttons: {
                confirm: {label: 'Yes',className: 'btn-danger'},
                cancel: {label: 'No',className: 'btn-secondary'}
            },
            callback:function(result){
                if(result){
                    ajax('DELETE', '/api/' + tid + '/' + id + '/' + token, {}, function (a) {
                        console.log(a);
                        if(a.success){
                            document.cookie = "Authorization="+a.token;
                            table.ajax.reload();
                        }else
                            $.growl.error({message: a.message})
                    });
                }else{
                    $('#' + tid + '_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }
            }
        });
    });

    $(document).on('click', '.delete-image', function () {
        var id = $(this).data('id'), pid = $(this).data('pid'), token = getCookie('Authorization');
        $('#' + tid + '_modal').modal('hide');
        bootbox.confirm({
            size:"small",
            title:"刪除圖片",
            message:"是否確定刪除此圖片",
            centerVertical:true,
            buttons: {
                confirm: {label: 'Yes',className: 'btn-danger'},
                cancel: {label: 'No',className: 'btn-secondary'}
            },
            callback:function(result){
                if(result){
                    ajax('DELETE', '/api/image/'+id+'/'+token, {}, function (a) {
                        if(a.success){
                            document.cookie = "Authorization="+a.token;
                            displayImage(pid);
                        }else
                            $.growl.error({message: a.message})
                        $('#' + tid + '_modal').modal({
                            backdrop: 'static',
                            keyboard: true,
                            show: true
                        });
                    });
                }else{
                    $('#' + tid + '_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }
            }
        });
    });

    $('#file').change(function(){
        var id = $(this).data('id');
        uploadImage(id);
    });

    $('#file-t').change(function(){
        var id = $(this).data('id');
        uploadThumbnail(id);
    });
});
