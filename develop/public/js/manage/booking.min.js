$(document).ready(function(){
    var object = {};
    var gen_booking_card = function(info){
        status = '<div class="col-4" style="color: sandybrown;white-space: nowrap"><i class="fa fa-info-circle"></i>&ensp;Upcoming</div>';
        if (info.status == 1) status = '<div class="col-4" style="color: green; white-space: nowrap"><i class="fa fa-check-circle"></i>&ensp;Completed</div>';
        if (info.status == 2) status = '<div class="col-4" style="color: red;white-space: nowrap"><i class="fas fa-exclamation-triangle"></i>&ensp;Cancelled</div>';

        var content = '<div class="d-flex"><div class="col-8 tag">#'+info.id+'</div>' + status + '</div>';
        content += '<hr class="nopadding"><div class="col-12"><span class="booking-name">' + info.name + '</span>&emsp;<span class="booking-mobile">' + info.mobile + '</span></div>';
        content += '<div class="col-12"><span class="booking-email">' + info.email + '</span></div>';
        content += '<div class="d-flex booking-info"><div class="col-10">' + info.type + '</div><div class="col-2">' + info.count + '</div></div>';
        content += '<div class="d-flex booking-info" style="border-bottom: dashed #bbb 2px;">' +
            '<div class="col-5">' + info.start + '</div>' +
            '<div class="col-5">' + info.end + '</div>' +
            '<div class="col-2">' + info.count + '晚</div>' +
            '</div>';
        content += '<div class="col-12 d-flex justify-content-end">' +
            '<button class="btn btn-sm btn-primary booking-btn" data-action="edit" data-id="'+ info.id +'">編輯</button>' +
            '<button class="btn btn-sm btn-danger booking-btn" data-action="delete" data-id="'+ info.id +'">刪除</button>' +
            '</div>';
        content = '<div class="booking-box">' + content + '</div>';
        return content;
    };

    $.ajax({
        url: '/api/manage/booking/list/9',
        method: 'GET',
        dataType: 'json',
        success: function (a) {
            for(const i in a.data) {
                var div = '<div class="col-12 col-lg-6 col-xl-4 booking-area" id="booking_' + a.data[i].id + '">' + gen_booking_card(a.data[i]) + '</div>';
                $('#bookingList').append(div);
            }
        },
        error: function (a) {
            console.log(a);
        },
    });
    $.ajax({
        url: '/api/manage/booking/list/0',
        method: 'GET',
        dataType: 'json',
        success: function (a) {
            for(const i in a.data) {
                var div = '<div class="col-12 col-lg-6 col-xl-4 booking-area" id="booking_' + a.data[i].id + '">' + gen_booking_card(a.data[i]) + '</div>';
                $('#bookingList_upcoming').append(div);
            }
        },
        error: function (a) {
            console.log(a);
        },
    });
    $.ajax({
        url: '/api/manage/booking/list/1',
        method: 'GET',
        dataType: 'json',
        success: function (a) {
            for(const i in a.data) {
                var div = '<div class="col-12 col-lg-6 col-xl-4 booking-area" id="booking_' + a.data[i].id + '">' + gen_booking_card(a.data[i]) + '</div>';
                $('#bookingList_complete').append(div);
            }
        },
        error: function (a) {
            console.log(a);
        },
    });
    $.ajax({
        url: '/api/manage/booking/list/2',
        method: 'GET',
        dataType: 'json',
        success: function (a) {
            for(const i in a.data) {
                var div = '<div class="col-12 col-lg-6 col-xl-4 booking-area" id="booking_' + a.data[i].id + '">' + gen_booking_card(a.data[i]) + '</div>';
                $('#bookingList_cancelled').append(div);
            }
        },
        error: function (a) {
            console.log(a);
        },
    });

    $(document).on('click', '.booking-btn', function (){
        var btn = $(this),action = btn.data('action'), tid = btn.data('id');
        switch (action) {
            case 'edit':
                $.ajax({
                    url: '/api/manage/booking/'+tid,
                    method: 'GET',
                    dataType: 'json',
                    success: function (a) {
                        var info = a.data;
                        $('#booking_name').val(info.name);
                        $('#booking_mobile').val(info.mobile);
                        $('#booking_email').val(info.email);
                        $('#booking_type').val(info.type);
                        $('#booking_count').val(info.count);
                        $('#booking_start').val(info.start);
                        $('#booking_end').val(info.end);
                        $('.action-btn').attr('data-id', info.id);
                    },
                    error: function (a) {
                        console.log(a);
                    },
                });
                $('#booking_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
                break;
            case 'delete':
                bootbox.confirm({
                    size:"small",
                    title:"取消訂單",
                    message:"是否確定取消訂單" + tid,
                    centerVertical:true,
                    buttons: {
                        confirm: {label: 'Yes',className: 'btn-danger'},
                        cancel: {label: 'No',className: 'btn-secondary'}
                    },
                    callback:function(result){
                        if(result){
                            $.ajax({
                                url: '/api/manage/booking/' + tid,
                                method: 'DELETE',
                                dataType: 'json',
                                success: function (a) {
                                    $.growl.notice({message: 'success'});
                                    $('.booking-area[id="booking_' + a.data + '"]').remove();
                                },
                                error: function (a) {
                                    console.log(a);
                                },
                            });
                        }
                    }
                });
                break;
        }
    });

    $(".action-btn").on("click", function() {
        var btn = $(this), tid= btn.data('id');
        switch (btn.data('action')) {
            case 'apply':
                var condition = false, data = {};

                $('#booking_name').val().length && (data['name'] = $('#booking_name').val(), condition = true);
                $('#booking_mobile').val().length && (data['mobile'] = $('#booking_mobile').val(), condition = true);
                $('#booking_email').val().length && (data['email'] = $('#booking_email').val(), condition = true);
                $('#booking_type').val().length && (data['type'] = $('#booking_type').val(), condition = true);
                $('#booking_start').val().length && (data['start'] = $('#booking_start').val(), condition = true);
                $('#booking_end').val().length && (data['end'] = $('#booking_end').val(), condition = true);

                if(condition){
                    $.ajax({
                        url: '/api/manage/booking/'+tid,
                        method: 'PUT',
                        dataType: 'json',
                        data: data,
                        success: function (a) {
                            $.growl.notice({message: 'success'});
                            $('#booking_'+a.data.id).html(gen_booking_card(a.data));
                        },
                        error: function (a) {
                            console.log(a);
                        },
                    });
                }else
                    $.growl.warning({message: 'nothing change'});
                break;
            case 'delete':
                $('#member_modal').modal('hide');
                bootbox.confirm({
                    size:"small",
                    title:"刪除會員資料",
                    message:"是否確定刪除會員" + $('#account_'+tid).text(),
                    centerVertical:true,
                    buttons: {
                        confirm: {label: 'Yes',className: 'btn-danger'},
                        cancel: {label: 'No',className: 'btn-secondary'}
                    },
                    callback:function(result){
                        if(result){
                            $.ajax({
                                url: '/api/manage/booking/'+tid,
                                method: 'DELETE',
                                dataType: 'json',
                                success: function (a) {
                                    $.growl.notice({message: 'success'});
                                    $('.booking-area[id="booking_' + a.data + '"]').remove();
                                },
                                error: function (a) {
                                    console.log(a);
                                },
                            });
                        }else{
                            $('#booking_modal').modal({
                                backdrop: 'static',
                                keyboard: true,
                                show: true
                            });
                        }
                    }
                });
                break;
        }
    });

    $(".search").on("keyup", function() {
        var value = $(this).val(), target = $(this).data('target');
        if(value != ''){
            $('#'+target+' .booking-area').css('display', 'none');
            $('#'+target+' .booking-area[id*="'+$(this).val()+'"]').css('display', 'block');
        }else
            $('#'+target+' .booking-area').css('display', 'block');
    });
});
