$(document).ready(function(){
    
    var tid = "course";

    var uploadImage = function(id){
        var imgclean = $('#file');

        data = new FormData();
        data.append('image', $('#file')[0].files[0]);
        data.append('token', getCookie('Authorization'));

        var imgname  =  $('input[type=file]').val();
        var size  =  $('#file')[0].files[0].size;

        var ext =  imgname.substr( (imgname.lastIndexOf('.') +1) );
        if(ext=='jpg' || ext=='jpeg' || ext=='png' || ext=='gif' || ext=='PNG' || ext=='JPG' || ext=='JPEG')
        {
            if(size<=1000000)
            {
                $.ajax({
                    url: "/api/image/" + tid + "/" + id + "/store",
                    type: "POST",
                    data: data,
                    enctype: 'multipart/form-data',
                    processData: false,  // tell jQuery not to process the data
                    contentType: false   // tell jQuery not to set contentType
                }).done(function(a) {
                    if(a.success){
                        document.cookie = "Authorization="+a.token;
                        displayImage(id);
                        $.growl.notice({message: '圖片上傳成功'})
                        imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                    }else
                        $.growl.error({message: a.message})
                });
                return false;
            }
            else
            {
                imgclean.replaceWith( imgclean = imgclean.clone( true ) );
                alert('Sorry File size exceeding from 1 Mb');
            }
        }
        else
        {
            imgclean.replaceWith( imgclean = imgclean.clone( true ) );
            alert('Sorry Only you can uplaod JPEG|JPG|PNG|GIF file type ');
        }
    }, displayImage = function(id){
        ajax('GET', '/api/image/' + tid + '/' + id + '/get', {}, function (a) {
            if(a.success){
                $('#display-img').empty();
                a.data.forEach(el => {
                    var box = '<div class="col-10 col-sm-3 d-flex flex-column align-items-center" style="margin: 10px; padding: 10px; border-radius: 10px; background-color: #e5e5e5;">';
                    box += '<div class="d-flex justify-content-center align-items-center" style="height: 180px;">';
                    box += '    <img src="/upload/Image/' + el.uuid_name + '" style="max-height: 95%;max-width: 95%">';
                    box += '</div>';
                    box += '<button type="button" class="btn btn-danger delete-image" data-id="' + el.id +'" data-pid="'+ id +'" style="margin: 0"><i class="far fa-solid fa-trash-can"></i></button>';
                    box += '</div>';
                    $('#display-img').append(box);
                });
            }else
                $.growl.error({message: a.message})
        });
    };

    $('[data-admin=' + tid + ']').addClass('active');

    ajax('GET', '/api/course', {}, function (a) {
        if(a.success){
            console.log(a);
            if(a.data)
            {
                $('#edit_content').val(a.data.content.substr(1,a.data.content.length -2));

                $('#file').data('id', a.data.id);
                displayImage(a.data.id);
                $('.image-box').show();
            }
        }else
            $.growl.error({message: a.message})
    });

    $(document).on('click', '.save-btn', function () {
        var data = {
            'content': $('#edit_content').val(),
            'token': getCookie('Authorization')
        };
        ajax('POST', '/api/course', data, function (a) {
            if(a.success){
                document.cookie = "Authorization="+a.token;
                $.growl.notice({message: '儲存成功'})
            }else
                $.growl.error({message: a.message})
        }); 
    });

    $(document).on('click', '.delete-image', function () {
        var id = $(this).data('id'), pid = $(this).data('pid'), token = getCookie('Authorization');
        $('#' + tid + '_modal').modal('hide');
        bootbox.confirm({
            size:"small",
            title:"刪除圖片",
            message:"是否確定刪除此圖片",
            centerVertical:true,
            buttons: {
                confirm: {label: 'Yes',className: 'btn-danger'},
                cancel: {label: 'No',className: 'btn-secondary'}
            },
            callback:function(result){
                if(result){
                    ajax('DELETE', '/api/image/'+id+'/'+token, {}, function (a) {
                        if(a.success){
                            document.cookie = "Authorization="+a.token;
                            displayImage(pid);
                        }else
                            $.growl.error({message: a.message})
                        $('#' + tid + '_modal').modal({
                            backdrop: 'static',
                            keyboard: true,
                            show: true
                        });
                    });
                }else{
                    $('#' + tid + '_modal').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                }
            }
        });
    });

    $('#file').change(function(){
        var id = $(this).data('id');
        uploadImage(id);
    });
});
