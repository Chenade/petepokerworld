$(document).ready(function(){
    var object = {};
    var gen_member_card = function(info){
        var div = '<th scope="row" class="align-middle">'+ info.id + '</th>';
        div += '<td class="align-middle">'+ info.name + '</td>';
        div += '<td class="align-middle"  id="account_'+info.id+'">'+ info.account + '</td>';
        div += '<td class="align-middle mobile-hide" >'+ info.idcard + '</td>';
        div += '<td class="align-middle mobile-hide">'+ info.mobile + '</td>';
        div += '' +
            '<td class="align-middle">' +
            '   <button class="btn btn-sm btn-success table-btn booking" data-action="booking" data-booking="'+ info.booking +'">訂單</button>&emsp;' +
            '</td>';
        div += '' +
            '<td class="align-middle">' +
            '   <button class="btn btn-sm btn-primary table-btn" data-action="edit" data-id="'+ info.id +'">編輯</button>&emsp;' +
            '   <button class="btn btn-sm btn-danger table-btn" data-action="delete" data-id="'+ info.id +'">刪除</button>' +
            '</td>';

        // div += '<td class="align-middle"></td>';
        return div;
    };

    $.ajax({
        url: '/api/manage/member/list',
        method: 'GET',
        dataType: 'json',
        success: function (a) {
            for(const i in a.data) {
                var tr = '<tr id="row_'+a.data[i].id+'">'+gen_member_card(a.data[i])+'</tr>';
                $('#memberList').append(tr);
            }
        },
        error: function (a) {
            console.log(a);
        },
    });

    $(document).on('click', '.table-btn', function (){
        var btn = $(this),action = btn.data('action'), tid = btn.data('id');
        console.log(action);
        switch (action) {
            case 'edit':
                $.ajax({
                    url: '/api/manage/member/'+tid,
                    method: 'GET',
                    dataType: 'json',
                    success: function (a) {
                        var info = a.data;
                        $('#edit_account').val(info.account);
                        $('#edit_name').val(info.name);
                        $('#edit_idcard').val(info.idcard);
                        $('#edit_mobile').val(info.mobile);
                        $('#edit_tel').val(info.tel);
                        $('#edit_email').val(info.email);
                        $('.member-btn').attr('data-id', info.id);
                        object.id = info.id;
                    },
                    error: function (a) {
                        console.log(a);
                    },
                });
                $('#member_modal').modal({
                    backdrop: 'static',
                    keyboard: true,
                    show: true
                });
                break;
            case 'delete':
                bootbox.confirm({
                    size:"small",
                    title:"刪除會員資料",
                    message:"是否確定刪除會員"+$('#account_'+tid).text(),
                    centerVertical:true,
                    buttons: {
                        confirm: {label: 'Yes',className: 'btn-danger'},
                        cancel: {label: 'No',className: 'btn-secondary'}
                    },
                    callback:function(result){
                        if(result){
                            $.ajax({
                                url: '/api/manage/member/'+tid,
                                method: 'DELETE',
                                dataType: 'json',
                                success: function (a) {
                                    $.growl.notice({message: 'success'});
                                    $('#row_'+a.data).remove();
                                },
                                error: function (a) {
                                    console.log(a);
                                },
                            });
                        }
                    }
                });
                break;
        }

    });

    $(".member-btn").on("click", function() {
        var btn = $(this), tid= btn.data('id');
        switch (btn.data('action')) {
            case 'apply':
                var condition = false, data = {};

                $('#edit_account').val().length && (data['account'] = $('#edit_account').val(), condition = true);
                $('#edit_name').val().length && (data['name'] = $('#edit_name').val(), condition = true);
                $('#edit_idcard').val().length && (data['idcard'] = $('#edit_idcard').val(), condition = true);
                $('#edit_mobile').val().length && (data['mobile'] = $('#edit_mobile').val(), condition = true);
                $('#ediit_tel').val().length && (data['tel'] = $('#ediit_tel').val(), condition = true);
                $('#edit_email').val().length && (data['email'] = $('#edit_email').val(), condition = true);

                if(condition){
                    $.ajax({
                        url: '/api/manage/member/'+tid,
                        method: 'PUT',
                        dataType: 'json',
                        data: data,
                        success: function (a) {
                            $.growl.notice({message: 'success'});
                            $('#row_'+a.data.id).html(gen_member_card(a.data));
                        },
                        error: function (a) {
                            console.log(a);
                        },
                    });
                }else
                    $.growl.warning({message: 'nothing change'});
                break;
            case 'delete':
                $('#member_modal').modal('hide');
                bootbox.confirm({
                    size:"small",
                    title:"刪除會員資料",
                    message:"是否確定刪除會員"+$('#account_'+tid).text(),
                    centerVertical:true,
                    buttons: {
                        confirm: {label: 'Yes',className: 'btn-danger'},
                        cancel: {label: 'No',className: 'btn-secondary'}
                    },
                    callback:function(result){
                        if(result){
                            $.ajax({
                                url: '/api/manage/member/'+tid,
                                method: 'DELETE',
                                dataType: 'json',
                                success: function (a) {
                                    $.growl.notice({message: 'success'});
                                    $('#row_'+a.data).remove();
                                },
                                error: function (a) {
                                    console.log(a);
                                },
                            });
                        }else{
                            $('#member_modal').modal({
                                backdrop: 'static',
                                keyboard: true,
                                show: true
                            });
                        }
                    }
                });
                break;
        }
    });

    $("#myInput").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#memberList tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });
});
